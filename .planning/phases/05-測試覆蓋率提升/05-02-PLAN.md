---
phase: 05-測試覆蓋率提升
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/Unit/Webhook/NotifyHandlerTest.php
  - tests/Fixtures/PayUNiTestHelper.php
autonomous: true

must_haves:
  truths:
    - "Webhook 重複通知只處理一次"
    - "錯誤簽章的通知被拒絕"
    - "無效 transaction_id 的通知被正確處理"
  artifacts:
    - path: "tests/Unit/Webhook/NotifyHandlerTest.php"
      provides: "Webhook 處理邊界案例測試"
      min_lines: 200
    - path: "tests/Fixtures/PayUNiTestHelper.php"
      provides: "共用測試輔助類別"
      min_lines: 80
  key_links:
    - from: "tests/Unit/Webhook/NotifyHandlerTest.php"
      to: "src/Webhook/NotifyHandler.php"
      via: "PHPUnit test cases"
      pattern: "NotifyHandler"
---

<objective>
建立 Webhook NotifyHandler 的邊界案例測試。

Purpose: Webhook 是非同步付款通知的關鍵入口。TEST-02 要求測試重複通知、錯誤簽章、無效 transaction_id 等邊界案例。由於 NotifyHandler 依賴 WordPress 函數（transient、DB），需要建立適當的 mock/stub。

Output: NotifyHandlerTest.php 涵蓋邊界案例，加上共用的 PayUNiTestHelper。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Webhook/NotifyHandler.php
@src/Services/PayUNiCryptoService.php
@tests/bootstrap-unit.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立共用測試輔助類別 PayUNiTestHelper</name>
  <files>tests/Fixtures/PayUNiTestHelper.php</files>
  <action>
建立 `tests/Fixtures/PayUNiTestHelper.php`：

這個類別提供測試用的 mock 和工廠方法：

1. **MockPayUNiSettings** 類別：
   ```php
   class MockPayUNiSettings {
       public const TEST_HASH_KEY = 'abcdefghij1234567890abcdefghij12';
       public const TEST_HASH_IV = '123456789012';
       public const TEST_MER_ID = 'TEST12345';

       public function getHashKey($mode = '') { return self::TEST_HASH_KEY; }
       public function getHashIV($mode = '') { return self::TEST_HASH_IV; }
       public function getMode() { return 'test'; }
       public function getMerId($mode = '') { return self::TEST_MER_ID; }
   }
   ```

2. **PayUNiTestHelper** 類別：
   - `createValidEncryptedPayload(array $data)`: 用真正的加密邏輯產生有效的 EncryptInfo
   - `createValidHashInfo(string $encryptInfo)`: 產生對應的 HashInfo
   - `createMockCryptoService()`: 回傳使用 MockSettings 的 CryptoService
   - `createInvalidHashInfo()`: 回傳錯誤的 HashInfo（用於測試簽章驗證失敗）
   - `createCorruptedEncryptInfo()`: 回傳損壞的 EncryptInfo

3. 確保使用真正的 PayUNiCryptoService（用 MockSettings 初始化）來產生測試資料，這樣可以確保測試資料格式正確。
  </action>
  <verify>
建立檔案後，確認 `require_once` 能正常載入，且 MockPayUNiSettings 和 PayUNiTestHelper 類別存在
  </verify>
  <done>
PayUNiTestHelper.php 存在於 tests/Fixtures/，包含 MockPayUNiSettings 和工廠方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 NotifyHandler 解析邏輯測試</name>
  <files>tests/Unit/Webhook/NotifyHandlerTest.php</files>
  <action>
建立 `tests/Unit/Webhook/NotifyHandlerTest.php`：

由於 NotifyHandler::processNotify() 直接依賴 WordPress 函數（get_transient, set_transient, exit），我們需要測試可隔離的邏輯。

**策略**：測試 `extractTrxHashFromMerTradeNo()` 方法（使用反射或建立 testable 版本）

測試案例：

1. **MerTradeNo 解析測試**：
   - `testExtractTrxHashFromNewFormat()` - 測試 `{uuid}__{time}_{rand}` 格式
   - `testExtractTrxHashFromOldFormat()` - 測試 `{uuid}_{time}_{rand}` 格式
   - `testExtractTrxHashFromIdFormat()` - 測試 `{id}A{timebase36}{rand}` 格式
   - `testExtractTrxHashFromEmptyString()` - 空字串回傳空字串
   - `testExtractTrxHashFromInvalidFormat()` - 無效格式回傳空字串

使用 ReflectionMethod 讓 private 方法變成可測試：
```php
$handler = new NotifyHandler();
$method = new \ReflectionMethod(NotifyHandler::class, 'extractTrxHashFromMerTradeNo');
$method->setAccessible(true);
$result = $method->invoke($handler, $merTradeNo);
```

注意：測試 `{id}A{timebase36}` 格式時，由於需要查資料庫，這個測試可能需要 skip 或 mock。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter NotifyHandlerTest` 測試通過
  </verify>
  <done>
NotifyHandlerTest.php 存在，extractTrxHashFromMerTradeNo 相關測試通過
  </done>
</task>

<task type="auto">
  <name>Task 3: 建立 Webhook 簽章驗證和去重邏輯測試</name>
  <files>tests/Unit/Webhook/NotifyHandlerTest.php</files>
  <action>
擴展 NotifyHandlerTest，加入簽章驗證相關的邏輯測試：

**簽章驗證測試**（使用 CryptoService）：
1. `testValidHashInfoPassesVerification()` - 有效簽章通過驗證
2. `testInvalidHashInfoFailsVerification()` - 無效簽章驗證失敗
3. `testTamperedEncryptInfoFailsVerification()` - 篡改後的資料驗證失敗

**解密結果驗證**：
4. `testDecryptedPayloadHasRequiredFields()` - 解密後有必要欄位
5. `testMissingTradeStatusHandling()` - 缺少 TradeStatus 時的處理
6. `testMissingPaymentTypeHandling()` - 缺少 PaymentType 時的處理

**去重 Key 生成邏輯**：
7. `testDedupKeyGenerationWithNotifyId()` - 有 notify_id 時的 key 生成
8. `testDedupKeyGenerationWithoutNotifyId()` - 無 notify_id 時用 encrypt+hash 生成
9. `testDedupKeyConsistency()` - 相同輸入產生相同 key

這些測試主要測試資料處理邏輯，不需要實際呼叫 WordPress 函數。

使用 PayUNiTestHelper 產生測試資料。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter NotifyHandlerTest --testdox` 顯示所有測試
  </verify>
  <done>
NotifyHandlerTest 至少有 15 個測試方法，涵蓋 MerTradeNo 解析、簽章驗證、去重邏輯
  </done>
</task>

</tasks>

<verification>
1. `composer test -- --filter NotifyHandlerTest` 全部通過
2. PayUNiTestHelper.php 存在且可重用
3. 測試涵蓋：MerTradeNo 解析、簽章驗證邏輯、去重 key 生成
4. 不依賴 WordPress transient API（只測試純邏輯）
</verification>

<success_criteria>
- NotifyHandlerTest.php 和 PayUNiTestHelper.php 存在
- 至少 15 個測試方法通過
- 測試涵蓋 TEST-02 要求的邊界案例（重複、錯誤簽章、無效 transaction_id 的處理邏輯）
</success_criteria>

<output>
完成後，建立 `.planning/phases/05-測試覆蓋率提升/05-02-SUMMARY.md`
</output>
