---
phase: 05-測試覆蓋率提升
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03", "05-04"]
files_modified:
  - phpunit-unit.xml
  - tests/Unit/README.md
autonomous: true

must_haves:
  truths:
    - "PHPUnit 覆蓋率報告能正確執行"
    - "核心模組覆蓋率統計包含正確的目錄"
    - "測試文件說明清楚測試策略和執行方式"
  artifacts:
    - path: "phpunit-unit.xml"
      provides: "更新的 PHPUnit 配置（包含正確的覆蓋率目錄）"
      contains: "src/"
    - path: "tests/Unit/README.md"
      provides: "測試文件，說明測試結構和執行方式"
      min_lines: 50
  key_links:
    - from: "phpunit-unit.xml"
      to: "src/"
      via: "coverage include directive"
      pattern: "src/"
---

<objective>
整合測試配置、驗證覆蓋率、建立測試文件。

Purpose: 確保所有新增的測試能正確執行並產生覆蓋率報告，同時建立測試文件讓未來維護者理解測試策略。

Output: 更新的 phpunit-unit.xml、測試 README、驗證的覆蓋率報告。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@phpunit-unit.xml
@tests/bootstrap-unit.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 更新 PHPUnit 配置以正確計算覆蓋率</name>
  <files>phpunit-unit.xml</files>
  <action>
更新 `phpunit-unit.xml`：

**問題**：現有配置的 coverage include 指向 `includes/` 但實際程式碼在 `src/`。

**修正**：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/9.5/phpunit.xsd"
         bootstrap="tests/bootstrap-unit.php"
         colors="true"
         verbose="true"
         processIsolation="false"
         failOnWarning="true">
    <coverage processUncoveredFiles="true">
        <include>
            <directory suffix=".php">src/</directory>
        </include>
        <exclude>
            <directory suffix="Test.php">tests/</directory>
            <directory>vendor</directory>
        </exclude>
        <report>
            <html outputDirectory="coverage/" />
            <text outputFile="php://stdout" showUncoveredFiles="false"/>
        </report>
    </coverage>
    <testsuites>
        <testsuite name="Unit Tests">
            <directory suffix="Test.php">tests/Unit/</directory>
        </testsuite>
    </testsuites>
    <logging>
        <testdoxText outputFile="php://stdout"/>
    </logging>
</phpunit>
```

**關鍵變更**：
1. coverage include 從 `includes/` 改為 `src/`
2. 加入 coverage report 配置（HTML 輸出到 coverage/）
3. 加入 testdox 輸出便於閱讀測試結果
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test:coverage` 應該在 coverage/ 目錄產生 HTML 報告
  </verify>
  <done>
phpunit-unit.xml 更新完成，覆蓋率報告能正確產生
  </done>
</task>

<task type="auto">
  <name>Task 2: 執行全部測試並驗證覆蓋率</name>
  <files>tests/Unit/README.md</files>
  <action>
執行完整測試套件並記錄結果：

1. 執行 `composer test` 確認所有測試通過
2. 執行 `composer test:coverage` 產生覆蓋率報告
3. 記錄測試統計：
   - 總測試數量
   - 總 assertions 數量
   - 各模組覆蓋率

**預期測試數量**（根據前四個 plan）：
- 05-01: PayUNiCryptoServiceTest ~20 tests
- 05-02: NotifyHandlerTest ~15 tests
- 05-03: SubscriptionStateMachineTest ~24 tests
- 05-04: PaymentProcessorTest ~22 tests, PayUNiGatewayTest ~10 tests
- 既有: PayUNiSubscriptionsTest 6 tests, PayUNiSubscriptionRenewalRunnerTest 10 tests

**總計**: ~107 tests

開始建立 tests/Unit/README.md 包含測試執行結果摘要。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test` 全部通過，且測試數量 > 90
  </verify>
  <done>
全部測試通過，測試數量達標，覆蓋率報告產生
  </done>
</task>

<task type="auto">
  <name>Task 3: 建立測試文件</name>
  <files>tests/Unit/README.md</files>
  <action>
建立 `tests/Unit/README.md`：

```markdown
# FluentCart PayUNi Unit Tests

## Overview

單元測試套件涵蓋 PayUNi 整合外掛的核心邏輯，不需要 WordPress 或 FluentCart 環境即可執行。

## Test Structure

```
tests/Unit/
├── Gateway/
│   ├── PayUNiGatewayTest.php      # Gateway 設定驗證
│   └── PayUNiSubscriptionsTest.php # 訂閱參數處理
├── Processor/
│   └── PaymentProcessorTest.php   # 支付處理核心邏輯
├── Scheduler/
│   ├── PayUNiSubscriptionRenewalRunnerTest.php # 重試機制
│   └── SubscriptionStateMachineTest.php        # 狀態機測試
├── Services/
│   ├── PayUNiCryptoServiceTest.php # 加解密、簽章
│   └── SampleServiceTest.php       # 範例測試
├── Webhook/
│   └── NotifyHandlerTest.php      # Webhook 處理邏輯
└── README.md
```

## Running Tests

### Run All Tests
```bash
composer test
```

### Run with Verbose Output
```bash
composer test:unit
```

### Run Specific Test Class
```bash
composer test -- --filter PayUNiCryptoServiceTest
```

### Generate Coverage Report
```bash
composer test:coverage
```
Coverage report will be generated in `coverage/` directory.

## Test Categories

### 1. CryptoService Tests (TEST-04)
- AES-256-GCM 加解密
- SHA256 簽章生成與驗證
- 邊界案例（空值、特殊字元、大 payload）

### 2. Webhook Tests (TEST-02)
- MerTradeNo 解析（多種格式）
- 簽章驗證邏輯
- 去重 key 生成

### 3. Subscription State Machine Tests (TEST-03)
- 狀態轉換（active → failing → cancelled）
- 重試邏輯（24h/48h/72h 間隔）
- 錯誤分類（可重試 vs 不可重試）

### 4. Gateway/Processor Tests (TEST-01)
- 金額轉換（cents → dollars）
- MerTradeNo 格式與長度限制
- ATM/CVS/Credit 請求參數
- 設定驗證

## Test Fixtures

`tests/Fixtures/PayUNiTestHelper.php` 提供共用的 mock 和工廠方法：
- `MockPayUNiSettings` - 測試用設定類別
- `createValidEncryptedPayload()` - 產生有效的加密資料
- `createValidHashInfo()` - 產生對應的簽章

## Coverage Target

目標覆蓋率：60%+ 核心模組（src/Gateway/, src/Processor/, src/Services/, src/Webhook/）

## Notes

- 測試不依賴 WordPress transient/database
- 使用 ReflectionMethod 測試 private 方法
- 測試資料使用固定值，不使用隨機數據
```
  </action>
  <verify>
檔案存在且內容完整
  </verify>
  <done>
tests/Unit/README.md 建立完成，包含完整的測試文件
  </done>
</task>

</tasks>

<verification>
1. `composer test` 全部通過，測試數量 > 90
2. `composer test:coverage` 產生覆蓋率報告
3. phpunit-unit.xml 正確指向 src/ 目錄
4. tests/Unit/README.md 存在且包含完整說明
</verification>

<success_criteria>
- 全部測試通過（> 90 tests）
- 覆蓋率報告成功產生
- 測試文件清楚說明結構和執行方式
- Phase 5 所有 requirements (TEST-01~04) 達成
</success_criteria>

<output>
完成後，建立 `.planning/phases/05-測試覆蓋率提升/05-05-SUMMARY.md`
</output>
