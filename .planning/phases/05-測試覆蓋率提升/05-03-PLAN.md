---
phase: 05-測試覆蓋率提升
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - tests/Unit/Scheduler/SubscriptionStateMachineTest.php
autonomous: true

must_haves:
  truths:
    - "訂閱狀態機正確處理 active → failing 轉換"
    - "重試計數和間隔計算正確"
    - "不可重試錯誤直接標記 failing 不進入重試流程"
  artifacts:
    - path: "tests/Unit/Scheduler/SubscriptionStateMachineTest.php"
      provides: "訂閱狀態機測試"
      min_lines: 200
  key_links:
    - from: "tests/Unit/Scheduler/SubscriptionStateMachineTest.php"
      to: "src/Scheduler/PayUNiSubscriptionRenewalRunner.php"
      via: "PHPUnit test cases"
      pattern: "retry|state|failing"
---

<objective>
建立訂閱續扣狀態機的完整測試。

Purpose: TEST-03 要求測試訂閱狀態轉換（active → trialing → failing → cancelled）。PayUNiSubscriptionRenewalRunner 包含重試邏輯、狀態轉換、錯誤分類等商業邏輯，需要完整測試覆蓋。

Output: SubscriptionStateMachineTest.php 涵蓋重試邏輯、狀態轉換、邊界案例。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Scheduler/PayUNiSubscriptionRenewalRunner.php
@tests/Unit/Scheduler/PayUNiSubscriptionRenewalRunnerTest.php
@tests/Fixtures/PayUNiTestHelper.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 SubscriptionStateMachineTest 基礎架構</name>
  <files>tests/Unit/Scheduler/SubscriptionStateMachineTest.php</files>
  <action>
建立 `tests/Unit/Scheduler/SubscriptionStateMachineTest.php`：

這個測試類別專注於狀態機邏輯的單元測試（補充現有的 PayUNiSubscriptionRenewalRunnerTest）。

1. **定義狀態常數**（模擬 FluentCart Status 類別）：
```php
private const STATUS_ACTIVE = 'active';
private const STATUS_TRIALING = 'trialing';
private const STATUS_FAILING = 'failing';
private const STATUS_CANCELLED = 'cancelled';
```

2. **定義重試常數**（從 PayUNiSubscriptionRenewalRunner 複製）：
```php
private const MAX_RETRY_ATTEMPTS = 3;
private const RETRY_INTERVALS = [
    1 => 24,
    2 => 48,
    3 => 72,
];
```

3. **建立輔助方法**：
- `calculateNextRetryTime(int $attempt, int $baseTime): string` - 計算下次重試時間
- `shouldRetry(array $retryInfo, string $errorType): bool` - 判斷是否應該重試
- `isNoRetryError(string $errorType): bool` - 判斷是否為不可重試錯誤

這些方法模擬 PayUNiSubscriptionRenewalRunner 的邏輯，用於驗證正確性。
  </action>
  <verify>
建立檔案後，執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter SubscriptionStateMachineTest` 確認測試類別被識別
  </verify>
  <done>
SubscriptionStateMachineTest.php 存在，包含狀態常數和輔助方法
  </done>
</task>

<task type="auto">
  <name>Task 2: 撰寫重試邏輯和狀態轉換測試</name>
  <files>tests/Unit/Scheduler/SubscriptionStateMachineTest.php</files>
  <action>
加入以下測試方法：

**狀態轉換測試**：
1. `testActiveSubscriptionCanTransitionToFailing()` - active 可轉為 failing
2. `testTrialingSubscriptionCanTransitionToFailing()` - trialing 可轉為 failing
3. `testFailingSubscriptionCanTransitionToCancelled()` - failing 可轉為 cancelled
4. `testFailingSubscriptionCanTransitionToActive()` - failing 重試成功可回復 active

**重試次數測試**：
5. `testFirstFailureSchedulesRetryAfter24Hours()` - 首次失敗 24h 後重試
6. `testSecondFailureSchedulesRetryAfter48Hours()` - 第二次失敗 48h 後重試
7. `testThirdFailureSchedulesRetryAfter72Hours()` - 第三次失敗 72h 後重試
8. `testFourthFailureExhaustsRetries()` - 第四次失敗耗盡重試

**重試資訊結構測試**：
9. `testRetryInfoContainsRequiredFields()` - retryInfo 有必要欄位
10. `testRetryHistoryAccumulatesCorrectly()` - 歷史記錄正確累積
11. `testRetryInfoClearedOnSuccess()` - 成功後清除 retryInfo
12. `testExhaustedFlagSetOnMaxRetries()` - 達到最大重試次數時設置 exhausted

每個測試使用具體的時間戳和狀態值，不使用 mocking framework。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter SubscriptionStateMachineTest` 所有測試通過
  </verify>
  <done>
至少 12 個狀態轉換和重試相關測試通過
  </done>
</task>

<task type="auto">
  <name>Task 3: 撰寫錯誤分類和邊界案例測試</name>
  <files>tests/Unit/Scheduler/SubscriptionStateMachineTest.php</files>
  <action>
加入錯誤分類和邊界案例測試：

**不可重試錯誤測試**：
1. `testMissingCreditHashIsNoRetryError()` - 缺少 token 不重試
2. `testMissingCustomerEmailIsNoRetryError()` - 缺少 email 不重試
3. `testRequires3DIsNoRetryError()` - 需要 3D 驗證不重試
4. `testNoRetryErrorsDirectlyMarkFailing()` - 不可重試錯誤直接標記 failing

**可重試錯誤測試**：
5. `testApiErrorIsRetryable()` - API 錯誤可重試
6. `testInvalidResponseIsRetryable()` - 無效回應可重試
7. `testVerificationFailedIsRetryable()` - 驗證失敗可重試
8. `testPaymentDeclinedIsRetryable()` - 付款被拒可重試

**邊界案例**：
9. `testRetryWithZeroAttemptsInitializesCorrectly()` - 首次失敗時正確初始化
10. `testRetryWithMissingRetryInfoRecovers()` - 缺少 retryInfo 時恢復
11. `testDuplicateRenewalAttemptPrevention()` - 15 分鐘內重複扣款防護
12. `testNextBillingDateCalculation()` - 下次帳單日期計算

最終 SubscriptionStateMachineTest 應有至少 24 個測試方法。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter SubscriptionStateMachineTest --testdox` 顯示所有測試
  </verify>
  <done>
SubscriptionStateMachineTest 至少 24 個測試方法，全部通過
  </done>
</task>

</tasks>

<verification>
1. `composer test -- --filter SubscriptionStateMachineTest` 全部通過
2. 測試至少 24 個方法
3. 涵蓋狀態轉換、重試邏輯、錯誤分類、邊界案例
4. 不依賴 FluentCart 環境（純邏輯測試）
</verification>

<success_criteria>
- SubscriptionStateMachineTest.php 存在且有至少 24 個測試方法
- 涵蓋 TEST-03 要求的狀態轉換（active → trialing → failing → cancelled）
- 重試邏輯（24h/48h/72h）經過驗證
- 錯誤分類（可重試 vs 不可重試）經過驗證
</success_criteria>

<output>
完成後，建立 `.planning/phases/05-測試覆蓋率提升/05-03-SUMMARY.md`
</output>
