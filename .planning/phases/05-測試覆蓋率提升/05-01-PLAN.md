---
phase: 05-測試覆蓋率提升
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - tests/Unit/Services/PayUNiCryptoServiceTest.php
autonomous: true

must_haves:
  truths:
    - "CryptoService 加密後能正確解密還原"
    - "CryptoService HashInfo 驗證能偵測篡改"
    - "CryptoService 處理邊界案例不會崩潰"
  artifacts:
    - path: "tests/Unit/Services/PayUNiCryptoServiceTest.php"
      provides: "CryptoService 完整單元測試"
      min_lines: 150
  key_links:
    - from: "tests/Unit/Services/PayUNiCryptoServiceTest.php"
      to: "src/Services/PayUNiCryptoService.php"
      via: "PHPUnit test cases"
      pattern: "PayUNiCryptoService"
---

<objective>
建立 PayUNiCryptoService 的完整單元測試套件。

Purpose: CryptoService 是整個支付流程的核心安全元件，負責 AES-256-GCM 加解密和簽章驗證。這是純粹的商業邏輯，不依賴 WordPress/FluentCart，非常適合 TDD 且必須有完整測試。

Output: 一個完整的 CryptoServiceTest.php，涵蓋加密、解密、簽章、驗證、邊界案例。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Services/PayUNiCryptoService.php
@tests/bootstrap-unit.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 CryptoService 測試類別與 Mock Settings</name>
  <files>tests/Unit/Services/PayUNiCryptoServiceTest.php</files>
  <action>
建立 `tests/Unit/Services/PayUNiCryptoServiceTest.php`：

1. 建立 MockPayUNiSettings 類別（在同一檔案或獨立）：
   - 實作 `getHashKey($mode)` 回傳固定測試金鑰（32 字元）
   - 實作 `getHashIV($mode)` 回傳固定測試 IV（12 字元）
   - 實作 `getMode()` 回傳 'test'
   - 實作 `getMerId($mode)` 回傳 'TEST12345'

2. 建立 PayUNiCryptoServiceTest 類別：
   - 使用 `setUp()` 初始化 CryptoService 與 Mock Settings
   - 定義測試用的固定金鑰/IV（必須符合 AES-256-GCM 要求）

測試金鑰範例（32 bytes for AES-256）：
```php
private const TEST_HASH_KEY = 'abcdefghij1234567890abcdefghij12'; // 32 chars
private const TEST_HASH_IV = '123456789012'; // 12 chars for GCM
```
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PayUNiCryptoServiceTest` 應該看到測試類別被識別（即使還沒有測試方法）
  </verify>
  <done>
MockPayUNiSettings 和 PayUNiCryptoServiceTest 類別存在，PHPUnit 能識別測試檔案
  </done>
</task>

<task type="auto">
  <name>Task 2: 撰寫加解密和簽章測試</name>
  <files>tests/Unit/Services/PayUNiCryptoServiceTest.php</files>
  <action>
在 PayUNiCryptoServiceTest 中加入以下測試方法：

**加密測試**：
1. `testEncryptInfoReturnsNonEmptyString()` - 驗證加密輸出非空
2. `testEncryptInfoDifferentInputProducesDifferentOutput()` - 不同輸入產生不同密文
3. `testEncryptInfoReturnsHexString()` - 輸出是有效的 hex 字串

**解密測試**：
4. `testDecryptInfoRestoresOriginalData()` - 加密後解密能還原
5. `testDecryptInfoReturnsEmptyArrayOnInvalidInput()` - 無效輸入回傳空陣列
6. `testDecryptInfoReturnsEmptyArrayOnMalformedHex()` - 非 hex 輸入回傳空陣列
7. `testDecryptInfoReturnsEmptyArrayOnMissingTag()` - 缺少 tag 分隔符回傳空陣列

**簽章測試**：
8. `testHashInfoReturnsUppercaseHexString()` - HashInfo 是大寫 hex
9. `testHashInfoIsDeterministic()` - 相同輸入產生相同 hash
10. `testVerifyHashInfoReturnsTrueOnValidHash()` - 有效 hash 驗證通過
11. `testVerifyHashInfoReturnsFalseOnInvalidHash()` - 無效 hash 驗證失敗
12. `testVerifyHashInfoReturnsFalseOnTamperedData()` - 篡改後驗證失敗

每個測試使用具體的輸入值，不要使用隨機數據。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PayUNiCryptoServiceTest` 所有測試通過
  </verify>
  <done>
至少 12 個測試方法存在並通過，覆蓋 encryptInfo、decryptInfo、hashInfo、verifyHashInfo
  </done>
</task>

<task type="auto">
  <name>Task 3: 撰寫邊界案例和安全性測試</name>
  <files>tests/Unit/Services/PayUNiCryptoServiceTest.php</files>
  <action>
加入邊界案例和安全性相關測試：

**空值/null 處理**：
1. `testEncryptInfoWithEmptyArray()` - 空陣列加密
2. `testDecryptInfoWithEmptyString()` - 空字串解密
3. `testHashInfoWithEmptyString()` - 空字串雜湊

**特殊字元處理**：
4. `testEncryptInfoWithSpecialCharacters()` - 含中文、特殊符號的資料
5. `testEncryptInfoWithUnicodeCharacters()` - Unicode 字元

**長度/格式邊界**：
6. `testEncryptInfoWithLargePayload()` - 大量資料（>1KB）
7. `testDecryptInfoWithPartialHex()` - 不完整的 hex 字串
8. `testVerifyHashInfoCaseInsensitive()` - Hash 比對應忽略大小寫

**buildStubPayload 測試**（if applicable）：
9. `testBuildStubPayloadReturnsCorrectStructure()` - 回傳格式正確

最終測試數量目標：至少 20 個測試方法。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PayUNiCryptoServiceTest --testdox` 顯示所有測試通過且覆蓋完整
  </verify>
  <done>
PayUNiCryptoServiceTest 有至少 20 個測試方法，全部通過，涵蓋正常流程、邊界案例、安全性
  </done>
</task>

</tasks>

<verification>
1. `composer test -- --filter PayUNiCryptoServiceTest` 全部通過
2. 測試檔案至少 150 行，至少 20 個測試方法
3. 覆蓋 encryptInfo、decryptInfo、hashInfo、verifyHashInfo、buildStubPayload
4. 包含正常流程、邊界案例、錯誤處理測試
</verification>

<success_criteria>
- PayUNiCryptoServiceTest.php 存在且 PHPUnit 能執行
- 至少 20 個測試方法全部通過
- 測試涵蓋：加密、解密、簽章、驗證、邊界案例
- 無需 WordPress/FluentCart 環境即可執行
</success_criteria>

<output>
完成後，建立 `.planning/phases/05-測試覆蓋率提升/05-01-SUMMARY.md`
</output>
