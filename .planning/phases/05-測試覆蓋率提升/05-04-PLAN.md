---
phase: 05-測試覆蓋率提升
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - tests/Unit/Processor/PaymentProcessorTest.php
  - tests/Unit/Gateway/PayUNiGatewayTest.php
autonomous: true

must_haves:
  truths:
    - "一次性付款流程的金額轉換正確"
    - "MerTradeNo 格式符合 PayUNi 規範"
    - "ATM/CVS 付款請求結構正確"
  artifacts:
    - path: "tests/Unit/Processor/PaymentProcessorTest.php"
      provides: "PaymentProcessor 核心邏輯測試"
      min_lines: 150
    - path: "tests/Unit/Gateway/PayUNiGatewayTest.php"
      provides: "Gateway 設定驗證測試"
      min_lines: 100
  key_links:
    - from: "tests/Unit/Processor/PaymentProcessorTest.php"
      to: "src/Processor/PaymentProcessor.php"
      via: "PHPUnit test cases"
      pattern: "PaymentProcessor"
---

<objective>
建立 Gateway 和 Processor 層的核心邏輯測試。

Purpose: TEST-01 要求核心支付流程測試覆蓋率達 60%。Gateway 和 Processor 是支付入口，但它們高度依賴 FluentCart 物件。我們專注於測試可隔離的純 PHP 邏輯：金額轉換、MerTradeNo 生成、請求參數建構等。

Output: PaymentProcessorTest.php 和 PayUNiGatewayTest.php 涵蓋核心邏輯。
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Processor/PaymentProcessor.php
@src/Gateway/PayUNiGateway.php
@tests/Fixtures/PayUNiTestHelper.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 PaymentProcessor 核心邏輯測試</name>
  <files>tests/Unit/Processor/PaymentProcessorTest.php</files>
  <action>
建立 `tests/Unit/Processor/PaymentProcessorTest.php`：

由於 PaymentProcessor 依賴 FluentCart 物件，我們使用反射或重新實作可測試的邏輯來測試。

**測試 normalizeTradeAmount 邏輯**：
```php
// 模擬 normalizeTradeAmount 邏輯（參考 PaymentProcessor）
private function normalizeTradeAmount($amount): int {
    // FluentCart 金額可能是分（cents）或元
    $floatAmt = (float) $amount;
    if ($floatAmt >= 100) {
        return (int) round($floatAmt / 100);
    }
    return (int) $floatAmt;
}
```

**測試案例**：
1. `testNormalizeTradeAmountFromCents()` - 分轉元（10000 → 100）
2. `testNormalizeTradeAmountFromDollars()` - 元保持（30 → 30）
3. `testNormalizeTradeAmountRounding()` - 小數正確四捨五入
4. `testNormalizeTradeAmountZero()` - 零金額處理
5. `testNormalizeTradeAmountNegative()` - 負數處理

**測試 generateMerTradeNo 邏輯**：
6. `testMerTradeNoFormat()` - 格式為 `{id}A{timebase36}{rand}`
7. `testMerTradeNoMaxLength()` - 長度不超過 PayUNi 限制（20 字元）
8. `testMerTradeNoUniqueness()` - 連續生成不重複
9. `testMerTradeNoExtractableId()` - 可從 MerTradeNo 反查 transaction id

**測試 getCardInputFromRequest 邏輯**：
10. `testGetCardInputStructure()` - 回傳結構正確
11. `testGetCardInputSanitization()` - 輸入被正確清理
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PaymentProcessorTest` 測試通過
  </verify>
  <done>
PaymentProcessorTest.php 存在，至少 11 個測試方法通過
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 PayUNiGateway 設定驗證測試</name>
  <files>tests/Unit/Gateway/PayUNiGatewayTest.php</files>
  <action>
建立 `tests/Unit/Gateway/PayUNiGatewayTest.php`：

測試 Gateway 的靜態方法和設定驗證邏輯：

**validateSettings 測試**：
1. `testValidateSettingsWithValidLiveData()` - 完整 live 設定通過
2. `testValidateSettingsWithValidTestData()` - 完整 test 設定通過
3. `testValidateSettingsFailsWithoutMerId()` - 缺少 MerID 失敗
4. `testValidateSettingsFailsWithoutHashKey()` - 缺少 HashKey 失敗
5. `testValidateSettingsFailsWithoutHashIV()` - 缺少 HashIV 失敗
6. `testValidateSettingsGatewayModeNormalization()` - gateway_mode 正規化

**meta 測試**：
7. `testMetaReturnsRequiredFields()` - meta 包含必要欄位
8. `testMetaSlugConsistency()` - slug 一致性

**beforeSettingsUpdate 測試**：
9. `testBeforeSettingsUpdateRemovesDisplayOnlyFields()` - 移除顯示欄位
10. `testBeforeSettingsUpdatePreservesCredentials()` - 保留認證資料

由於 validateSettings 是靜態方法且不依賴 WordPress，可以直接測試。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PayUNiGatewayTest` 測試通過
  </verify>
  <done>
PayUNiGatewayTest.php 存在，至少 10 個測試方法通過
  </done>
</task>

<task type="auto">
  <name>Task 3: 擴展 Processor 測試涵蓋 ATM/CVS 邏輯</name>
  <files>tests/Unit/Processor/PaymentProcessorTest.php</files>
  <action>
擴展 PaymentProcessorTest，加入 ATM/CVS 相關邏輯測試：

**ATM 請求參數測試**：
1. `testAtmEncryptInfoStructure()` - ATM 加密資訊結構正確
2. `testAtmExpireDayCalculation()` - 過期日計算正確（預設 3 天）
3. `testAtmBankTypeDefault()` - 預設銀行類型

**CVS 請求參數測試**：
4. `testCvsEncryptInfoStructure()` - CVS 加密資訊結構正確
5. `testCvsExpireDayCalculation()` - 過期日計算正確（預設 7 天）
6. `testCvsProductDescTruncation()` - 商品描述截斷（20 字元限制）

**Credit 請求參數測試**：
7. `testCreditEncryptInfoStructure()` - 信用卡加密資訊結構
8. `testCreditApi3DFlag()` - 3D 驗證旗標設定
9. `testCreditCardExpiryCleaning()` - 卡片效期清理（移除 /）

**ReturnURL/NotifyURL 測試**：
10. `testReturnUrlIncludesTrxHash()` - ReturnURL 包含 trx_hash
11. `testNotifyUrlFormat()` - NotifyURL 格式正確

PaymentProcessorTest 最終應有至少 22 個測試方法。
  </action>
  <verify>
執行 `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter PaymentProcessorTest --testdox` 顯示所有測試
  </verify>
  <done>
PaymentProcessorTest 至少 22 個測試方法，涵蓋金額轉換、MerTradeNo、ATM/CVS/Credit 參數
  </done>
</task>

</tasks>

<verification>
1. `composer test -- --filter "PaymentProcessorTest|PayUNiGatewayTest"` 全部通過
2. PaymentProcessorTest 至少 22 個測試，PayUNiGatewayTest 至少 10 個測試
3. 涵蓋金額轉換、MerTradeNo 生成、設定驗證、ATM/CVS/Credit 參數建構
</verification>

<success_criteria>
- PaymentProcessorTest.php 和 PayUNiGatewayTest.php 存在
- 合計至少 32 個測試方法通過
- 涵蓋 TEST-01 要求的核心支付流程邏輯
</success_criteria>

<output>
完成後，建立 `.planning/phases/05-測試覆蓋率提升/05-04-SUMMARY.md`
</output>
