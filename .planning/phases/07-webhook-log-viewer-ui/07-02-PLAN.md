---
phase: 07-webhook-log-viewer-ui
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - assets/css/payuni-webhook-logs.css
  - assets/js/payuni-webhook-logs.js
autonomous: true

must_haves:
  truths:
    - "Webhook events list displays time, type, transaction_id, and status"
    - "List uses pagination for large datasets"
    - "Clicking event opens modal showing complete payload"
    - "Duplicate webhook events visually marked as Duplicate (skipped)"
  artifacts:
    - path: "assets/js/payuni-webhook-logs.js"
      provides: "Frontend JavaScript for webhook log viewer"
      min_lines: 200
    - path: "assets/css/payuni-webhook-logs.css"
      provides: "Styling for webhook log viewer"
      min_lines: 50
  key_links:
    - from: "assets/js/payuni-webhook-logs.js"
      to: "src/API/WebhookLogAPI.php"
      via: "REST API fetch"
      pattern: "fluentcart-payuni/v1/webhook-logs"
---

<objective>
Create frontend JavaScript and CSS for the webhook log viewer with table rendering, pagination, filtering, and detail modal.

Purpose: Provide interactive UI for merchants to browse, search, and inspect webhook events.
Output: JavaScript and CSS files that power the webhook log viewer admin page.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing code patterns
@assets/js/payuni-order-detail.js (jQuery AJAX pattern)
@assets/css/payuni-order-detail.css (styling pattern)
@src/Admin/WebhookLogPage.php (HTML structure from 07-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook logs CSS styling</name>
  <files>assets/css/payuni-webhook-logs.css</files>
  <action>
Create `assets/css/payuni-webhook-logs.css` with styling for the webhook log viewer:

```css
/**
 * PayUNi Webhook Logs Viewer Styles
 *
 * @package BuyGoFluentCart\PayUNi
 * @since 1.1.0
 */

/* Container */
.payuni-webhook-logs-wrap {
    max-width: 1400px;
    margin: 20px auto;
}

.payuni-webhook-logs-wrap h1 {
    margin-bottom: 20px;
}

/* Filters */
.payuni-logs-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    background: #fff;
    border: 1px solid #ccd0d4;
    border-radius: 4px;
}

.payuni-logs-filters input[type="text"],
.payuni-logs-filters input[type="date"],
.payuni-logs-filters select {
    padding: 6px 10px;
    border: 1px solid #8c8f94;
    border-radius: 4px;
    min-height: 32px;
}

.payuni-logs-filters input[type="text"] {
    min-width: 250px;
}

.payuni-logs-filters input[type="date"] {
    min-width: 130px;
}

.payuni-logs-filters select {
    min-width: 120px;
}

/* Table */
#payuni-logs-table {
    margin-top: 0;
}

#payuni-logs-table th.column-time {
    width: 150px;
}

#payuni-logs-table th.column-type {
    width: 80px;
}

#payuni-logs-table th.column-trade-no {
    width: 180px;
}

#payuni-logs-table th.column-transaction {
    width: 280px;
}

#payuni-logs-table th.column-status {
    width: 100px;
}

#payuni-logs-table th.column-actions {
    width: 100px;
}

#payuni-logs-table .payuni-logs-loading td {
    text-align: center;
    padding: 20px;
    color: #666;
}

#payuni-logs-table .payuni-logs-empty td {
    text-align: center;
    padding: 40px;
    color: #666;
}

/* Status badges */
.payuni-status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
}

.payuni-status-processed {
    background: #d4edda;
    color: #155724;
}

.payuni-status-duplicate {
    background: #fff3cd;
    color: #856404;
}

.payuni-status-failed {
    background: #f8d7da;
    color: #721c24;
}

.payuni-status-pending {
    background: #d1ecf1;
    color: #0c5460;
}

/* Type badges */
.payuni-type-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
}

.payuni-type-notify {
    background: #e2e3e5;
    color: #383d41;
}

.payuni-type-return {
    background: #cce5ff;
    color: #004085;
}

/* Pagination */
.payuni-logs-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border: 1px solid #ccd0d4;
    border-radius: 4px;
}

#payuni-logs-page-info {
    color: #666;
    font-size: 13px;
}

/* Modal */
.payuni-modal {
    position: fixed;
    z-index: 100000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.payuni-modal-content {
    background: #fff;
    padding: 25px;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
}

.payuni-modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
}

.payuni-modal-close:hover {
    color: #333;
}

.payuni-modal-content h2 {
    margin: 0 0 20px 0;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

/* Detail content */
.payuni-detail-section {
    margin-bottom: 20px;
}

.payuni-detail-section h3 {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 10px 0;
    color: #333;
}

.payuni-detail-row {
    display: flex;
    padding: 8px 0;
    border-bottom: 1px dashed #eee;
}

.payuni-detail-row:last-child {
    border-bottom: none;
}

.payuni-detail-label {
    flex: 0 0 150px;
    color: #666;
    font-size: 13px;
}

.payuni-detail-value {
    flex: 1;
    font-size: 13px;
    word-break: break-all;
}

.payuni-payload-block {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow-y: auto;
}

/* View details button */
.payuni-view-detail-btn {
    background: #0073aa;
    color: #fff;
    border: none;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.payuni-view-detail-btn:hover {
    background: #005a87;
}

/* Responsive */
@media screen and (max-width: 782px) {
    .payuni-logs-filters {
        flex-direction: column;
    }

    .payuni-logs-filters input[type="text"],
    .payuni-logs-filters input[type="date"],
    .payuni-logs-filters select {
        width: 100%;
        min-width: unset;
    }

    #payuni-logs-table th.column-transaction {
        display: none;
    }

    #payuni-logs-table td:nth-child(4) {
        display: none;
    }
}
```

IMPORTANT: Use WordPress admin color scheme conventions.
IMPORTANT: Include responsive styles for mobile admin.
  </action>
  <verify>
1. File exists: `test -f assets/css/payuni-webhook-logs.css && echo "exists"`
2. Contains status badge styles: `grep -r "payuni-status-duplicate" assets/css/payuni-webhook-logs.css`
3. Contains modal styles: `grep -r "payuni-modal" assets/css/payuni-webhook-logs.css`
  </verify>
  <done>
- CSS file created with all necessary styles
- Status badges have distinct colors (processed=green, duplicate=yellow, failed=red)
- Modal styling includes scroll for large content
- Responsive styles for mobile admin
  </done>
</task>

<task type="auto">
  <name>Task 2: Create webhook logs JavaScript with table rendering and pagination</name>
  <files>assets/js/payuni-webhook-logs.js</files>
  <action>
Create `assets/js/payuni-webhook-logs.js` with full functionality:

```javascript
/**
 * PayUNi Webhook Logs Viewer JavaScript
 *
 * @package BuyGoFluentCart\PayUNi
 * @since 1.1.0
 */

(function($) {
    'use strict';

    var PayUNiWebhookLogs = {
        config: null,
        currentPage: 1,
        perPage: 20,
        totalPages: 1,
        filters: {},

        init: function() {
            this.config = window.payuniWebhookLogs || {};
            this.bindEvents();
            this.loadLogs();
        },

        bindEvents: function() {
            var self = this;

            // Filter button
            $('#payuni-logs-filter-btn').on('click', function() {
                self.currentPage = 1;
                self.loadLogs();
            });

            // Enter key in search field
            $('#payuni-logs-search').on('keypress', function(e) {
                if (e.which === 13) {
                    self.currentPage = 1;
                    self.loadLogs();
                }
            });

            // Pagination
            $('#payuni-logs-prev').on('click', function() {
                if (self.currentPage > 1) {
                    self.currentPage--;
                    self.loadLogs();
                }
            });

            $('#payuni-logs-next').on('click', function() {
                if (self.currentPage < self.totalPages) {
                    self.currentPage++;
                    self.loadLogs();
                }
            });

            // Modal close
            $('.payuni-modal-close').on('click', function() {
                self.closeModal();
            });

            // Close modal on backdrop click
            $('#payuni-log-detail-modal').on('click', function(e) {
                if ($(e.target).is('#payuni-log-detail-modal')) {
                    self.closeModal();
                }
            });

            // Close modal on Escape key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape') {
                    self.closeModal();
                }
            });
        },

        getFilters: function() {
            return {
                search: $('#payuni-logs-search').val() || '',
                status: $('#payuni-logs-status').val() || '',
                webhook_type: $('#payuni-logs-type').val() || '',
                date_from: $('#payuni-logs-date-from').val() || '',
                date_to: $('#payuni-logs-date-to').val() || ''
            };
        },

        loadLogs: function() {
            var self = this;
            var filters = this.getFilters();

            // Show loading
            $('#payuni-logs-body').html(
                '<tr class="payuni-logs-loading"><td colspan="6">' +
                (this.config.labels ? this.config.labels.loading : 'Loading...') +
                '</td></tr>'
            );

            // Build query params
            var params = {
                page: this.currentPage,
                per_page: this.perPage
            };

            if (filters.search) params.search = filters.search;
            if (filters.status) params.status = filters.status;
            if (filters.webhook_type) params.webhook_type = filters.webhook_type;
            if (filters.date_from) params.date_from = filters.date_from;
            if (filters.date_to) params.date_to = filters.date_to;

            $.ajax({
                url: this.config.restUrl,
                method: 'GET',
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-WP-Nonce', self.config.nonce);
                },
                data: params,
                success: function(response) {
                    self.renderTable(response);
                    self.updatePagination(response);
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load webhook logs:', error);
                    $('#payuni-logs-body').html(
                        '<tr class="payuni-logs-empty"><td colspan="6">Error loading logs.</td></tr>'
                    );
                }
            });
        },

        renderTable: function(response) {
            var self = this;
            var logs = response.data || [];
            var labels = this.config.labels || {};
            var tbody = $('#payuni-logs-body');

            if (logs.length === 0) {
                tbody.html(
                    '<tr class="payuni-logs-empty"><td colspan="6">' +
                    (labels.no_logs || 'No webhook logs found.') +
                    '</td></tr>'
                );
                return;
            }

            var html = '';
            logs.forEach(function(log) {
                html += self.renderRow(log);
            });

            tbody.html(html);

            // Bind view detail buttons
            tbody.find('.payuni-view-detail-btn').on('click', function() {
                var logData = $(this).data('log');
                self.showDetail(logData);
            });
        },

        renderRow: function(log) {
            var labels = this.config.labels || {};

            var statusClass = 'payuni-status-' + (log.webhook_status || 'processed');
            var statusLabel = this.getStatusLabel(log.webhook_status);

            var typeClass = 'payuni-type-' + (log.webhook_type || 'notify');
            var typeLabel = log.webhook_type === 'return' ?
                (labels.type_return || 'Return') :
                (labels.type_notify || 'Notify');

            var time = this.formatTime(log.processed_at);
            var tradeNo = log.trade_no || '-';
            var transactionId = log.transaction_id || '-';

            // Escape log data for data attribute
            var logDataStr = this.escapeHtml(JSON.stringify(log));

            return '<tr>' +
                '<td>' + this.escapeHtml(time) + '</td>' +
                '<td><span class="payuni-type-badge ' + typeClass + '">' + typeLabel + '</span></td>' +
                '<td>' + this.escapeHtml(tradeNo) + '</td>' +
                '<td>' + this.escapeHtml(transactionId) + '</td>' +
                '<td><span class="payuni-status-badge ' + statusClass + '">' + statusLabel + '</span></td>' +
                '<td>' +
                    '<button type="button" class="payuni-view-detail-btn" data-log=\'' + logDataStr + '\'>' +
                    (this.config.labels ? this.config.labels.view_details : 'View Details') +
                    '</button>' +
                '</td>' +
                '</tr>';
        },

        getStatusLabel: function(status) {
            var labels = this.config.labels || {};
            switch (status) {
                case 'processed':
                    return labels.status_processed || 'Processed';
                case 'duplicate':
                    return labels.status_duplicate || 'Duplicate (skipped)';
                case 'failed':
                    return labels.status_failed || 'Failed';
                case 'pending':
                    return labels.status_pending || 'Pending';
                default:
                    return status || 'Unknown';
            }
        },

        formatTime: function(datetime) {
            if (!datetime) return '-';
            try {
                var date = new Date(datetime + ' UTC');
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return datetime;
            }
        },

        updatePagination: function(response) {
            this.totalPages = response.total_pages || 1;
            var total = response.total || 0;

            $('#payuni-logs-page-info').text(
                'Page ' + this.currentPage + ' of ' + this.totalPages +
                ' (' + total + ' total)'
            );

            $('#payuni-logs-prev').prop('disabled', this.currentPage <= 1);
            $('#payuni-logs-next').prop('disabled', this.currentPage >= this.totalPages);
        },

        showDetail: function(log) {
            var labels = this.config.labels || {};
            var html = '';

            // Basic info section
            html += '<div class="payuni-detail-section">';
            html += '<h3>Basic Information</h3>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">ID</span>';
            html += '<span class="payuni-detail-value">' + this.escapeHtml(log.id || '-') + '</span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Transaction ID</span>';
            html += '<span class="payuni-detail-value">' + this.escapeHtml(log.transaction_id || '-') + '</span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Trade No</span>';
            html += '<span class="payuni-detail-value">' + this.escapeHtml(log.trade_no || '-') + '</span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Type</span>';
            html += '<span class="payuni-detail-value">' + this.escapeHtml(log.webhook_type || '-') + '</span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Status</span>';
            html += '<span class="payuni-detail-value">' +
                '<span class="payuni-status-badge payuni-status-' + (log.webhook_status || 'processed') + '">' +
                this.getStatusLabel(log.webhook_status) +
                '</span></span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Processed At</span>';
            html += '<span class="payuni-detail-value">' + this.formatTime(log.processed_at) + '</span>';
            html += '</div>';

            html += '<div class="payuni-detail-row">';
            html += '<span class="payuni-detail-label">Payload Hash</span>';
            html += '<span class="payuni-detail-value">' + this.escapeHtml(log.payload_hash || '-') + '</span>';
            html += '</div>';

            if (log.response_message) {
                html += '<div class="payuni-detail-row">';
                html += '<span class="payuni-detail-label">Response</span>';
                html += '<span class="payuni-detail-value">' + this.escapeHtml(log.response_message) + '</span>';
                html += '</div>';
            }

            html += '</div>';

            // Raw payload section (if available)
            if (log.raw_payload) {
                html += '<div class="payuni-detail-section">';
                html += '<h3>Raw Payload</h3>';
                html += '<div class="payuni-payload-block">';
                try {
                    var payload = JSON.parse(log.raw_payload);
                    html += this.escapeHtml(JSON.stringify(payload, null, 2));
                } catch (e) {
                    html += this.escapeHtml(log.raw_payload);
                }
                html += '</div>';
                html += '</div>';
            }

            $('#payuni-log-detail-content').html(html);
            $('#payuni-log-detail-modal').show();
        },

        closeModal: function() {
            $('#payuni-log-detail-modal').hide();
        },

        escapeHtml: function(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(String(text)));
            return div.innerHTML;
        }
    };

    // Initialize on document ready
    $(document).ready(function() {
        if ($('#payuni-webhook-logs-app').length) {
            PayUNiWebhookLogs.init();
        }
    });

})(jQuery);
```

IMPORTANT: Use jQuery for WordPress admin compatibility.
IMPORTANT: Escape all HTML output to prevent XSS.
IMPORTANT: Handle UTC to local time conversion for dates.
  </action>
  <verify>
1. File exists: `test -f assets/js/payuni-webhook-logs.js && echo "exists"`
2. Contains REST API call: `grep -r "fluentcart-payuni/v1/webhook-logs" assets/js/payuni-webhook-logs.js` (via config.restUrl)
3. Contains pagination handling: `grep -r "currentPage" assets/js/payuni-webhook-logs.js`
4. Contains modal show/hide: `grep -r "showDetail" assets/js/payuni-webhook-logs.js`
5. Contains XSS prevention: `grep -r "escapeHtml" assets/js/payuni-webhook-logs.js`
  </verify>
  <done>
- JavaScript file created with all functionality
- Table rendering with status badges
- Pagination controls work correctly
- Filter functionality (search, status, type, date range)
- Modal shows detailed webhook information
- XSS prevention via escapeHtml function
- UTC to local time conversion
  </done>
</task>

<task type="auto">
  <name>Task 3: Update NotifyHandler to record webhook status and payload</name>
  <files>src/Webhook/NotifyHandler.php</files>
  <action>
Update NotifyHandler to pass status and payload to WebhookDeduplicationService:

1. Find where `markProcessed()` is called in NotifyHandler (around line 100-120).

2. Update the call to include raw payload and status:
```php
// Before processing, check for duplicate
if ($this->deduplicationService->isProcessed($transactionId, 'notify')) {
    // Mark as duplicate for logging purposes
    $this->deduplicationService->markProcessed(
        $transactionId,
        'notify',
        $tradeNo ?? null,
        $payloadHash ?? null,
        'duplicate',  // status
        null,         // raw_payload (don't store duplicates)
        'Duplicate webhook skipped'
    );
    return; // Skip processing
}

// After successful processing
$this->deduplicationService->markProcessed(
    $transactionId,
    'notify',
    $tradeNo,
    $payloadHash,
    'processed',
    json_encode($_POST, JSON_UNESCAPED_UNICODE),
    'Successfully processed'
);
```

3. If processing fails (in catch block or error condition):
```php
$this->deduplicationService->markProcessed(
    $transactionId,
    'notify',
    $tradeNo ?? null,
    $payloadHash ?? null,
    'failed',
    json_encode($_POST, JSON_UNESCAPED_UNICODE),
    substr($errorMessage, 0, 255)
);
```

IMPORTANT: Store raw payload only for new webhooks, not duplicates (to save space).
IMPORTANT: Truncate error messages to 255 characters.
IMPORTANT: Use JSON_UNESCAPED_UNICODE for Chinese characters in payload.
  </action>
  <verify>
1. `grep -r "'processed'" src/Webhook/NotifyHandler.php` confirms status passed
2. `grep -r "'duplicate'" src/Webhook/NotifyHandler.php` confirms duplicate handling
3. `grep -r "json_encode" src/Webhook/NotifyHandler.php` confirms payload storage
4. PHP syntax check: `php -l src/Webhook/NotifyHandler.php`
  </verify>
  <done>
- NotifyHandler passes status to markProcessed()
- Duplicate webhooks marked with 'duplicate' status
- Failed webhooks marked with 'failed' status and error message
- Raw payload stored for debugging (except duplicates)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `test -f assets/css/payuni-webhook-logs.css && echo "CSS exists"` - CSS file created
2. `test -f assets/js/payuni-webhook-logs.js && echo "JS exists"` - JS file created
3. `grep -r "payuni-status-duplicate" assets/css/` - Duplicate status styling exists
4. `grep -r "escapeHtml" assets/js/payuni-webhook-logs.js` - XSS prevention
5. `grep -r "'duplicate'" src/Webhook/NotifyHandler.php` - Duplicate marking
6. PHP syntax check for all modified PHP files
</verification>

<success_criteria>
1. CSS file provides styling for table, filters, badges, modal
2. Duplicate status has distinct yellow badge styling
3. JavaScript loads and displays webhook logs
4. Pagination works correctly
5. Filter controls update table results
6. Modal displays complete webhook detail
7. NotifyHandler marks duplicates and stores status
8. XSS prevention in place for all rendered HTML
</success_criteria>

<output>
After completion, create `.planning/phases/07-webhook-log-viewer-ui/07-02-SUMMARY.md`
</output>
