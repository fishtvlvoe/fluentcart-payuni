---
phase: 07-webhook-log-viewer-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Admin/WebhookLogPage.php
  - fluentcart-payuni.php
  - includes/class-database.php
autonomous: true

must_haves:
  truths:
    - "WordPress admin menu contains PayUNi submenu with Webhook Logs page"
    - "WebhookLogPage class registered and renders admin page shell"
    - "Database table stores webhook_status column for processing result"
    - "REST API endpoint enhanced with date range and status filters"
  artifacts:
    - path: "src/Admin/WebhookLogPage.php"
      provides: "WordPress admin page for Webhook Log Viewer"
      min_lines: 100
      exports: ["WebhookLogPage"]
  key_links:
    - from: "fluentcart-payuni.php"
      to: "src/Admin/WebhookLogPage.php"
      via: "require and admin_menu hook"
      pattern: "add_action.*admin_menu.*WebhookLogPage"
    - from: "src/Admin/WebhookLogPage.php"
      to: "src/API/WebhookLogAPI.php"
      via: "REST API consumption"
      pattern: "fluentcart-payuni/v1/webhook-logs"
---

<objective>
Create WordPress admin menu page for viewing webhook logs with enhanced database schema and REST API filters.

Purpose: Merchants need a dedicated admin interface to monitor webhook events, debug payment issues, and verify webhook delivery status.
Output: WebhookLogPage.php class that creates admin menu page with necessary infrastructure for log viewing.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing code patterns
@includes/class-database.php (current schema)
@src/API/WebhookLogAPI.php (existing REST API)
@src/Admin/OrderPayUNiMetaBoxUI.php (admin asset enqueue pattern)
@fluentcart-payuni.php (plugin initialization pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance database schema with webhook_status and raw_payload columns</name>
  <files>includes/class-database.php, src/Services/WebhookDeduplicationService.php</files>
  <action>
Update database schema to support webhook status tracking and payload storage:

1. In `includes/class-database.php`, modify `createTables()` to add new columns:
```php
$sql = "CREATE TABLE $table_name (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    transaction_id VARCHAR(64) NOT NULL,
    trade_no VARCHAR(64) DEFAULT NULL,
    webhook_type VARCHAR(32) NOT NULL,
    webhook_status VARCHAR(32) NOT NULL DEFAULT 'processed',
    processed_at DATETIME NOT NULL,
    payload_hash VARCHAR(64) NOT NULL,
    raw_payload LONGTEXT DEFAULT NULL,
    response_message VARCHAR(255) DEFAULT NULL,
    PRIMARY KEY (id),
    UNIQUE KEY unique_transaction (transaction_id, webhook_type),
    KEY idx_processed_at (processed_at),
    KEY idx_trade_no (trade_no),
    KEY idx_webhook_status (webhook_status)
) $charset_collate;";
```

New columns:
- `webhook_status`: 'processed', 'duplicate', 'failed', 'pending' (for debugging)
- `raw_payload`: Store encrypted payload for debugging (LONGTEXT for large payloads)
- `response_message`: Brief result message (255 chars max)

2. In `WebhookDeduplicationService.php`, update `markProcessed()` to accept new parameters:
```php
public function markProcessed(
    string $transactionId,
    string $webhookType,
    ?string $tradeNo = null,
    ?string $payloadHash = null,
    string $status = 'processed',
    ?string $rawPayload = null,
    ?string $responseMessage = null
): bool {
    // ... existing validation ...

    $result = $wpdb->query(
        $wpdb->prepare(
            "INSERT IGNORE INTO $table
            (transaction_id, webhook_type, trade_no, processed_at, payload_hash, webhook_status, raw_payload, response_message)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s)",
            $transactionId,
            $webhookType,
            $tradeNo ?? '',
            gmdate('Y-m-d H:i:s'),
            $payloadHash ?? '',
            $status,
            $rawPayload,
            $responseMessage ?? ''
        )
    );
    // ...
}
```

3. Add new method `markDuplicate()` for duplicate webhooks:
```php
public function markDuplicate(
    string $transactionId,
    string $webhookType,
    ?string $tradeNo = null,
    ?string $payloadHash = null
): bool {
    return $this->markProcessed($transactionId, $webhookType, $tradeNo, $payloadHash, 'duplicate');
}
```

IMPORTANT: dbDelta() will handle adding new columns to existing tables safely.
IMPORTANT: Use LONGTEXT for raw_payload to handle large webhook payloads.
  </action>
  <verify>
1. `grep -r "webhook_status" includes/class-database.php` confirms new column
2. `grep -r "raw_payload" includes/class-database.php` confirms payload storage
3. `grep -r "markDuplicate" src/Services/WebhookDeduplicationService.php` confirms new method
4. PHP syntax check: `php -l includes/class-database.php && php -l src/Services/WebhookDeduplicationService.php`
  </verify>
  <done>
- Database schema includes webhook_status, raw_payload, response_message columns
- WebhookDeduplicationService updated to accept new parameters
- markDuplicate() method added for duplicate webhook tracking
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance WebhookLogAPI with date range and status filters</name>
  <files>src/API/WebhookLogAPI.php</files>
  <action>
Update REST API to support additional filtering options:

1. In `register_routes()`, add new args:
```php
'args' => [
    // ... existing args ...
    'date_from' => [
        'type'              => 'string',
        'sanitize_callback' => 'sanitize_text_field',
        'description'       => 'Filter logs from this date (Y-m-d format)',
    ],
    'date_to' => [
        'type'              => 'string',
        'sanitize_callback' => 'sanitize_text_field',
        'description'       => 'Filter logs until this date (Y-m-d format)',
    ],
    'status' => [
        'type'              => 'string',
        'enum'              => ['processed', 'duplicate', 'failed', 'pending'],
        'sanitize_callback' => 'sanitize_text_field',
        'description'       => 'Filter by webhook status',
    ],
    'search' => [
        'type'              => 'string',
        'sanitize_callback' => 'sanitize_text_field',
        'description'       => 'Search in trade_no or transaction_id',
    ],
],
```

2. In `get_logs()`, add filter handling:
```php
// Date range filter
if ($date_from = $request->get_param('date_from')) {
    $where[] = 'processed_at >= %s';
    $values[] = $date_from . ' 00:00:00';
}

if ($date_to = $request->get_param('date_to')) {
    $where[] = 'processed_at <= %s';
    $values[] = $date_to . ' 23:59:59';
}

// Status filter
if ($status = $request->get_param('status')) {
    $where[] = 'webhook_status = %s';
    $values[] = $status;
}

// Search filter
if ($search = $request->get_param('search')) {
    $where[] = '(trade_no LIKE %s OR transaction_id LIKE %s)';
    $values[] = '%' . $wpdb->esc_like($search) . '%';
    $values[] = '%' . $wpdb->esc_like($search) . '%';
}
```

3. Update `permission_check()` to also allow shop_manager:
```php
public function permission_check(): bool
{
    return current_user_can('manage_options') || current_user_can('manage_fluentcart');
}
```

IMPORTANT: Use prepared statements for all query parameters.
IMPORTANT: Add shop_manager capability check for FluentCart admins.
  </action>
  <verify>
1. `grep -r "date_from" src/API/WebhookLogAPI.php` confirms date filter
2. `grep -r "webhook_status" src/API/WebhookLogAPI.php` confirms status filter
3. `grep -r "manage_fluentcart" src/API/WebhookLogAPI.php` confirms permission update
4. PHP syntax check: `php -l src/API/WebhookLogAPI.php`
  </verify>
  <done>
- REST API supports date_from, date_to, status, and search filters
- Permission check includes manage_fluentcart capability
- All filters use prepared statements for security
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WebhookLogPage admin menu class</name>
  <files>src/Admin/WebhookLogPage.php, fluentcart-payuni.php</files>
  <action>
Create admin page class for Webhook Log Viewer:

1. Create `src/Admin/WebhookLogPage.php`:
```php
<?php
/**
 * PayUNi Webhook Log Viewer Admin Page
 *
 * @package BuyGoFluentCart\PayUNi\Admin
 * @since 1.1.0
 */

namespace BuyGoFluentCart\PayUNi\Admin;

/**
 * WebhookLogPage class.
 *
 * Creates admin menu page for viewing PayUNi webhook logs.
 */
class WebhookLogPage
{
    /**
     * Page slug.
     */
    private const PAGE_SLUG = 'payuni-webhook-logs';

    /**
     * Constructor.
     *
     * @param bool $registerHooks Whether to register WordPress hooks (for testability).
     */
    public function __construct(bool $registerHooks = true)
    {
        if ($registerHooks) {
            add_action('admin_menu', [$this, 'registerMenu'], 99);
            add_action('admin_enqueue_scripts', [$this, 'enqueueAssets']);
        }
    }

    /**
     * Register admin menu.
     */
    public function registerMenu(): void
    {
        // Add as submenu under FluentCart if it exists
        $parent_slug = 'fluent-cart';

        add_submenu_page(
            $parent_slug,
            __('PayUNi Webhook Logs', 'fluentcart-payuni'),
            __('PayUNi Webhooks', 'fluentcart-payuni'),
            'manage_options',
            self::PAGE_SLUG,
            [$this, 'renderPage']
        );
    }

    /**
     * Enqueue admin assets.
     *
     * @param string $hook Current admin page hook.
     */
    public function enqueueAssets(string $hook): void
    {
        // Only load on our page
        if (strpos($hook, self::PAGE_SLUG) === false) {
            return;
        }

        wp_enqueue_style(
            'payuni-webhook-logs',
            FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/css/payuni-webhook-logs.css',
            [],
            FLUENTCART_PAYUNI_VERSION
        );

        wp_enqueue_script(
            'payuni-webhook-logs',
            FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/js/payuni-webhook-logs.js',
            ['jquery'],
            FLUENTCART_PAYUNI_VERSION,
            true
        );

        wp_localize_script('payuni-webhook-logs', 'payuniWebhookLogs', [
            'restUrl' => rest_url('fluentcart-payuni/v1/webhook-logs'),
            'nonce'   => wp_create_nonce('wp_rest'),
            'labels'  => [
                'title'           => __('PayUNi Webhook Logs', 'fluentcart-payuni'),
                'search'          => __('Search...', 'fluentcart-payuni'),
                'filter_status'   => __('Filter by Status', 'fluentcart-payuni'),
                'filter_type'     => __('Filter by Type', 'fluentcart-payuni'),
                'date_from'       => __('From Date', 'fluentcart-payuni'),
                'date_to'         => __('To Date', 'fluentcart-payuni'),
                'column_time'     => __('Time', 'fluentcart-payuni'),
                'column_type'     => __('Type', 'fluentcart-payuni'),
                'column_trade_no' => __('Trade No', 'fluentcart-payuni'),
                'column_status'   => __('Status', 'fluentcart-payuni'),
                'column_actions'  => __('Actions', 'fluentcart-payuni'),
                'view_details'    => __('View Details', 'fluentcart-payuni'),
                'loading'         => __('Loading...', 'fluentcart-payuni'),
                'no_logs'         => __('No webhook logs found.', 'fluentcart-payuni'),
                'status_processed'=> __('Processed', 'fluentcart-payuni'),
                'status_duplicate'=> __('Duplicate', 'fluentcart-payuni'),
                'status_failed'   => __('Failed', 'fluentcart-payuni'),
                'status_pending'  => __('Pending', 'fluentcart-payuni'),
                'type_notify'     => __('Notify', 'fluentcart-payuni'),
                'type_return'     => __('Return', 'fluentcart-payuni'),
            ],
        ]);
    }

    /**
     * Render admin page.
     */
    public function renderPage(): void
    {
        // Check user capability
        if (!current_user_can('manage_options') && !current_user_can('manage_fluentcart')) {
            wp_die(__('You do not have permission to access this page.', 'fluentcart-payuni'));
        }

        ?>
        <div class="wrap payuni-webhook-logs-wrap">
            <h1><?php esc_html_e('PayUNi Webhook Logs', 'fluentcart-payuni'); ?></h1>

            <div id="payuni-webhook-logs-app">
                <!-- Filters -->
                <div class="payuni-logs-filters">
                    <input type="text" id="payuni-logs-search" placeholder="<?php esc_attr_e('Search by Trade No or Transaction ID...', 'fluentcart-payuni'); ?>" />

                    <select id="payuni-logs-status">
                        <option value=""><?php esc_html_e('All Status', 'fluentcart-payuni'); ?></option>
                        <option value="processed"><?php esc_html_e('Processed', 'fluentcart-payuni'); ?></option>
                        <option value="duplicate"><?php esc_html_e('Duplicate', 'fluentcart-payuni'); ?></option>
                        <option value="failed"><?php esc_html_e('Failed', 'fluentcart-payuni'); ?></option>
                    </select>

                    <select id="payuni-logs-type">
                        <option value=""><?php esc_html_e('All Types', 'fluentcart-payuni'); ?></option>
                        <option value="notify"><?php esc_html_e('Notify', 'fluentcart-payuni'); ?></option>
                        <option value="return"><?php esc_html_e('Return', 'fluentcart-payuni'); ?></option>
                    </select>

                    <input type="date" id="payuni-logs-date-from" />
                    <input type="date" id="payuni-logs-date-to" />

                    <button type="button" id="payuni-logs-filter-btn" class="button">
                        <?php esc_html_e('Filter', 'fluentcart-payuni'); ?>
                    </button>
                </div>

                <!-- Table -->
                <table class="wp-list-table widefat fixed striped" id="payuni-logs-table">
                    <thead>
                        <tr>
                            <th class="column-time"><?php esc_html_e('Time', 'fluentcart-payuni'); ?></th>
                            <th class="column-type"><?php esc_html_e('Type', 'fluentcart-payuni'); ?></th>
                            <th class="column-trade-no"><?php esc_html_e('Trade No', 'fluentcart-payuni'); ?></th>
                            <th class="column-transaction"><?php esc_html_e('Transaction ID', 'fluentcart-payuni'); ?></th>
                            <th class="column-status"><?php esc_html_e('Status', 'fluentcart-payuni'); ?></th>
                            <th class="column-actions"><?php esc_html_e('Actions', 'fluentcart-payuni'); ?></th>
                        </tr>
                    </thead>
                    <tbody id="payuni-logs-body">
                        <tr class="payuni-logs-loading">
                            <td colspan="6"><?php esc_html_e('Loading...', 'fluentcart-payuni'); ?></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="payuni-logs-pagination">
                    <button type="button" id="payuni-logs-prev" class="button" disabled>&laquo; <?php esc_html_e('Previous', 'fluentcart-payuni'); ?></button>
                    <span id="payuni-logs-page-info"></span>
                    <button type="button" id="payuni-logs-next" class="button"><?php esc_html_e('Next', 'fluentcart-payuni'); ?> &raquo;</button>
                </div>
            </div>

            <!-- Detail Modal -->
            <div id="payuni-log-detail-modal" class="payuni-modal" style="display:none;">
                <div class="payuni-modal-content">
                    <span class="payuni-modal-close">&times;</span>
                    <h2><?php esc_html_e('Webhook Detail', 'fluentcart-payuni'); ?></h2>
                    <div id="payuni-log-detail-content"></div>
                </div>
            </div>
        </div>
        <?php
    }
}
```

2. In `fluentcart-payuni.php`, register the admin page in `buygo_fc_payuni_bootstrap()`:
```php
// Webhook Log Viewer Admin Page
if (class_exists('BuyGoFluentCart\\PayUNi\\Admin\\WebhookLogPage')) {
    new \BuyGoFluentCart\PayUNi\Admin\WebhookLogPage();
}
```

Add this after the OrderPayUNiMetaBoxUI registration (around line 115).

IMPORTANT: Use priority 99 in admin_menu to ensure FluentCart menu exists first.
IMPORTANT: Check both manage_options and manage_fluentcart capabilities.
IMPORTANT: Use localized strings for all UI text.
  </action>
  <verify>
1. `grep -r "WebhookLogPage" fluentcart-payuni.php` confirms registration
2. `grep -r "payuni-webhook-logs" src/Admin/WebhookLogPage.php` confirms page slug
3. `grep -r "add_submenu_page" src/Admin/WebhookLogPage.php` confirms menu registration
4. PHP syntax check: `php -l src/Admin/WebhookLogPage.php`
  </verify>
  <done>
- WebhookLogPage class created with admin menu registration
- Page renders HTML shell with filters, table, pagination, and modal
- Assets enqueued only on webhook logs page
- Localized strings provided for JavaScript
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php -l includes/class-database.php` - No syntax errors
2. `php -l src/API/WebhookLogAPI.php` - No syntax errors
3. `php -l src/Admin/WebhookLogPage.php` - No syntax errors
4. `grep -r "webhook_status" includes/class-database.php` - Schema updated
5. `grep -r "date_from" src/API/WebhookLogAPI.php` - API filters added
6. `grep -r "WebhookLogPage" fluentcart-payuni.php` - Admin page registered
</verification>

<success_criteria>
1. Database schema includes webhook_status, raw_payload, response_message columns
2. WebhookDeduplicationService supports status tracking and duplicate marking
3. REST API supports date range, status, and search filters
4. WebhookLogPage class creates admin menu under FluentCart
5. Admin page renders filter controls, table, and modal structure
6. Constructor accepts $registerHooks parameter for testability
</success_criteria>

<output>
After completion, create `.planning/phases/07-webhook-log-viewer-ui/07-01-SUMMARY.md`
</output>
