---
phase: 11-user-guidance-and-documentation
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - src/Admin/SettingsPage.php
  - src/Admin/DashboardWidget.php
  - src/Admin/UserGuidePage.php
  - assets/css/payuni-user-guide.css
  - assets/js/payuni-user-guide.js
  - tests/Unit/Admin/UserGuidePageTest.php
autonomous: true

must_haves:
  truths:
    - "Settings page contains tooltip icons (i) next to key fields"
    - "Dashboard page contains help button linking to User Guide"
    - "First-time welcome message appears on Dashboard with link to Quick Start"
    - "User Guide page helper methods are testable without WordPress"
  artifacts:
    - path: "src/Admin/SettingsPage.php"
      provides: "Settings page with tooltip integration"
    - path: "src/Admin/DashboardWidget.php"
      provides: "Dashboard with help button and welcome message"
    - path: "tests/Unit/Admin/UserGuidePageTest.php"
      provides: "Unit tests for User Guide content generation"
      min_lines: 60
  key_links:
    - from: "src/Admin/DashboardWidget.php"
      to: "User Guide page"
      via: "help button link"
      pattern: "payuni-user-guide"
    - from: "src/Admin/SettingsPage.php"
      to: "User Guide FAQ section"
      via: "tooltip help links"
      pattern: "#faq"
---

<objective>
Add integration points (tooltips, help buttons, welcome message) and unit tests for User Guide.

Purpose: Provide contextual help throughout PayUNi admin pages so merchants can access relevant documentation without leaving their current workflow.
Output: Tooltips on Settings page fields, help button on Dashboard, first-time welcome message, and unit tests for UserGuidePage.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/phases/11-user-guidance-and-documentation/11-CONTEXT.md

# Reference existing implementations
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/DashboardWidget.php
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/UserGuidePage.php
@/Users/fishtv/Development/fluentcart-payuni/tests/Unit/Admin/SettingsPageTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tooltips to Settings page and help button to Dashboard</name>
  <files>src/Admin/SettingsPage.php, src/Admin/DashboardWidget.php, assets/css/payuni-user-guide.css</files>
  <action>
**Part A: Add tooltip icons to SettingsPage.php renderPage() method**

Add tooltip helper spans next to key field labels. Example pattern:

```php
// In Credentials Status section, add tooltip after labels:
<li>
    <strong><?php echo esc_html__('商店代號 (MerID):', 'fluentcart-payuni'); ?></strong>
    <span class="payuni-tooltip" title="<?php echo esc_attr__('從 PayUNi 商戶後台「商店設定」取得，用於識別您的商店', 'fluentcart-payuni'); ?>">
        <span class="dashicons dashicons-info-outline"></span>
    </span>
    <?php echo $testStatus['mer_id'] ? esc_html($testStatus['mer_id']) : '<em>' . esc_html__('未填寫', 'fluentcart-payuni') . '</em>'; ?>
</li>
```

**Fields to add tooltips:**
1. **MerID (商店代號)**: "從 PayUNi 商戶後台「商店設定」取得，用於識別您的商店"
2. **Hash Key**: "PayUNi 提供的加密金鑰，用於交易資料加密"
3. **Hash IV**: "PayUNi 提供的初始向量，與 Hash Key 配合使用"
4. **NotifyURL**: "PayUNi 付款完成後會發送通知到此網址"
5. **ReturnURL**: "客戶完成付款後會被導向到此網址"

**Add help link to Quick Links section:**
```php
<a href="<?php echo esc_url(admin_url('admin.php?page=payuni-user-guide')); ?>" class="quick-link-card">
    <span class="dashicons dashicons-book"></span>
    <div>
        <strong><?php echo esc_html__('使用指南', 'fluentcart-payuni'); ?></strong>
        <p><?php echo esc_html__('查看 FAQ 和疑難排解', 'fluentcart-payuni'); ?></p>
    </div>
</a>
```

**Part B: Add help button and welcome message to DashboardWidget.php**

**1. Add help button in page header:**
```php
// In renderPage() method, after <h1> tag:
<div class="dashboard-header">
    <h1><?php echo esc_html__('PayUNi Dashboard', 'fluentcart-payuni'); ?></h1>
    <a href="<?php echo esc_url(admin_url('admin.php?page=payuni-user-guide')); ?>"
       class="page-help-button"
       title="<?php echo esc_attr__('查看使用指南', 'fluentcart-payuni'); ?>">
        <span class="dashicons dashicons-editor-help"></span>
    </a>
</div>
```

**2. Add first-time welcome message:**
```php
// Check if first visit (user meta)
$user_id = get_current_user_id();
$has_seen_welcome = get_user_meta($user_id, 'payuni_dashboard_welcome_seen', true);

if (!$has_seen_welcome) {
    ?>
    <div class="payuni-welcome-banner" id="payuni-welcome-banner">
        <p>
            <strong><?php echo esc_html__('歡迎使用 PayUNi！', 'fluentcart-payuni'); ?></strong>
            <?php echo esc_html__('第一次使用嗎？', 'fluentcart-payuni'); ?>
            <a href="<?php echo esc_url(admin_url('admin.php?page=payuni-user-guide#quick-start')); ?>">
                <?php echo esc_html__('點擊此處查看快速開始指南', 'fluentcart-payuni'); ?>
            </a>
        </p>
        <button type="button" class="notice-dismiss" id="dismiss-welcome">
            <span class="screen-reader-text"><?php echo esc_html__('關閉', 'fluentcart-payuni'); ?></span>
        </button>
    </div>
    <?php
}
```

**3. Add REST endpoint to dismiss welcome:**
Add to `registerRestRoutes()` method:
```php
register_rest_route('fluentcart-payuni/v1', '/dismiss-welcome', [
    'methods' => 'POST',
    'permission_callback' => function() {
        return current_user_can('manage_fluentcart');
    },
    'callback' => function() {
        $user_id = get_current_user_id();
        update_user_meta($user_id, 'payuni_dashboard_welcome_seen', '1');
        return new \WP_REST_Response(['success' => true], 200);
    },
]);
```

**Part C: Add CSS for tooltips and welcome banner**

Add to `assets/css/payuni-settings.css`:
```css
/* Tooltips */
.payuni-tooltip {
    display: inline-flex;
    align-items: center;
    margin-left: 4px;
    cursor: help;
}

.payuni-tooltip .dashicons {
    font-size: 16px;
    width: 16px;
    height: 16px;
    color: #646970;
}

.payuni-tooltip:hover .dashicons {
    color: #2271b1;
}
```

Add to `assets/css/payuni-dashboard.css`:
```css
/* Dashboard Header with Help Button */
.payuni-dashboard .dashboard-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.payuni-dashboard .dashboard-header h1 {
    margin: 0;
}

.payuni-dashboard .page-help-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: #f6f7f7;
    border: 1px solid #dcdcde;
    border-radius: 50%;
    color: #2271b1;
    text-decoration: none;
    transition: background-color 0.2s;
}

.payuni-dashboard .page-help-button:hover {
    background: #2271b1;
    color: #fff;
}

.payuni-dashboard .page-help-button .dashicons {
    font-size: 18px;
    width: 18px;
    height: 18px;
}

/* Welcome Banner */
.payuni-welcome-banner {
    position: relative;
    padding: 12px 40px 12px 16px;
    margin-bottom: 20px;
    background: #d7edff;
    border-left: 4px solid #2271b1;
    border-radius: 4px;
}

.payuni-welcome-banner a {
    color: #2271b1;
    font-weight: 500;
}

.payuni-welcome-banner .notice-dismiss {
    position: absolute;
    top: 50%;
    right: 8px;
    transform: translateY(-50%);
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
}
```

**Part D: Add JavaScript for welcome banner dismissal**

Add to `assets/js/payuni-dashboard.js`:
```javascript
// Welcome banner dismissal
$('#dismiss-welcome').on('click', function() {
    var $banner = $('#payuni-welcome-banner');

    $.ajax({
        url: payuniDashboard.restUrl + '/dismiss-welcome',
        method: 'POST',
        headers: {
            'X-WP-Nonce': payuniDashboard.nonce
        },
        success: function() {
            $banner.fadeOut(300, function() {
                $(this).remove();
            });
        }
    });
});
```
  </action>
  <verify>
1. Settings page: tooltip icons appear next to MerID, Hash Key, Hash IV, NotifyURL, ReturnURL
2. Settings page: Quick Links section includes "使用指南" card
3. Dashboard page: help button (?) appears next to page title
4. Dashboard page: first visit shows welcome banner with link to Quick Start
5. Welcome banner: clicking dismiss hides banner permanently for that user
  </verify>
  <done>
- Tooltips added to 5 key fields on Settings page (GUIDE-05)
- Help button on Dashboard linking to User Guide
- First-time welcome banner with Quick Start link (CONTEXT.md requirement)
- REST endpoint for dismissing welcome banner
- CSS styling consistent with WordPress admin UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for UserGuidePage content generation</name>
  <files>tests/Unit/Admin/UserGuidePageTest.php</files>
  <action>
**Create `tests/Unit/Admin/UserGuidePageTest.php`**

Following SettingsPageTest pattern:

```php
<?php
/**
 * Unit tests for UserGuidePage.
 *
 * @package BuyGoFluentCart\PayUNi\Tests\Unit\Admin
 */

namespace BuyGoFluentCart\PayUNi\Tests\Unit\Admin;

use BuyGoFluentCart\PayUNi\Admin\UserGuidePage;
use PHPUnit\Framework\TestCase;

/**
 * Test case for UserGuidePage.
 */
class UserGuidePageTest extends TestCase
{
    /**
     * @var UserGuidePage
     */
    private $page;

    /**
     * Set up test fixtures.
     */
    protected function setUp(): void
    {
        parent::setUp();
        // Create instance without registering WordPress hooks
        $this->page = new UserGuidePage(false);
    }

    /**
     * Test Quick Start section contains setup steps.
     */
    public function testQuickStartSectionContainsSetupSteps(): void
    {
        $html = $this->page->renderQuickStartSection();

        // Should contain numbered setup steps
        $this->assertStringContainsString('PayUNi', $html);
        $this->assertStringContainsString('MerID', $html);
        $this->assertStringContainsString('Hash Key', $html);
        $this->assertStringContainsString('Webhook', $html);
    }

    /**
     * Test Quick Start section contains quick links.
     */
    public function testQuickStartSectionContainsQuickLinks(): void
    {
        $html = $this->page->renderQuickStartSection();

        // Should contain links to PayUNi pages
        $this->assertStringContainsString('payuni-settings', $html);
        $this->assertStringContainsString('payuni-webhook-logs', $html);
        $this->assertStringContainsString('payuni-dashboard', $html);
    }

    /**
     * Test Feature Locations section contains all main features.
     */
    public function testFeatureLocationsSectionContainsAllFeatures(): void
    {
        $html = $this->page->renderFeatureLocationsSection();

        // Should contain all documented feature locations
        $this->assertStringContainsString('訂單', $html);
        $this->assertStringContainsString('訂閱', $html);
        $this->assertStringContainsString('Webhook', $html);
        $this->assertStringContainsString('Dashboard', $html);
    }

    /**
     * Test FAQ section contains all required categories.
     */
    public function testFaqSectionContainsAllCategories(): void
    {
        $html = $this->page->renderFaqSection();

        // Should contain all 4 FAQ categories from CONTEXT.md
        $this->assertStringContainsString('金流設定', $html);
        $this->assertStringContainsString('Webhook', $html);
        $this->assertStringContainsString('訂閱', $html);
        $this->assertStringContainsString('ATM', $html);
    }

    /**
     * Test FAQ section contains collapsible structure.
     */
    public function testFaqSectionHasCollapsibleStructure(): void
    {
        $html = $this->page->renderFaqSection();

        // Should contain accordion CSS classes
        $this->assertStringContainsString('faq-item', $html);
        $this->assertStringContainsString('faq-question', $html);
        $this->assertStringContainsString('faq-answer', $html);
    }

    /**
     * Test Troubleshooting section contains error table.
     */
    public function testTroubleshootingSectionContainsErrorTable(): void
    {
        $html = $this->page->renderTroubleshootingSection();

        // Should contain error reference table
        $this->assertStringContainsString('error-table', $html);
        $this->assertStringContainsString('Hash', $html);
        $this->assertStringContainsString('商店代號', $html);
    }

    /**
     * Test Troubleshooting section contains checklist.
     */
    public function testTroubleshootingSectionContainsChecklist(): void
    {
        $html = $this->page->renderTroubleshootingSection();

        // Should contain Webhook checklist
        $this->assertStringContainsString('checklist', $html);
        $this->assertStringContainsString('HTTPS', $html);
        $this->assertStringContainsString('防火牆', $html);
    }

    /**
     * Test sidebar navigation items match content sections.
     */
    public function testSidebarNavigationMatchesContentSections(): void
    {
        $navItems = $this->page->getNavigationItems();

        // Should have 4 navigation items
        $this->assertCount(4, $navItems);

        // Each item should have id and label
        foreach ($navItems as $item) {
            $this->assertArrayHasKey('id', $item);
            $this->assertArrayHasKey('label', $item);
        }
    }

    /**
     * Test page slug is correctly defined.
     */
    public function testPageSlugConstant(): void
    {
        $reflection = new \ReflectionClass(UserGuidePage::class);
        $constant = $reflection->getConstant('PAGE_SLUG');

        $this->assertEquals('payuni-user-guide', $constant);
    }
}
```

**Note:** Make render methods public or add public getter methods to allow testing:

In UserGuidePage.php, change method visibility:
```php
public function renderQuickStartSection(): string { ... }
public function renderFeatureLocationsSection(): string { ... }
public function renderFaqSection(): string { ... }
public function renderTroubleshootingSection(): string { ... }

public function getNavigationItems(): array
{
    return [
        ['id' => 'quick-start', 'label' => __('快速開始', 'fluentcart-payuni')],
        ['id' => 'feature-locations', 'label' => __('功能位置', 'fluentcart-payuni')],
        ['id' => 'faq', 'label' => __('常見問題', 'fluentcart-payuni')],
        ['id' => 'troubleshooting', 'label' => __('疑難排解', 'fluentcart-payuni')],
    ];
}
```
  </action>
  <verify>
1. Test file exists at `tests/Unit/Admin/UserGuidePageTest.php`
2. Run tests: `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter UserGuidePageTest`
3. All 9 tests pass
  </verify>
  <done>
- Unit tests for Quick Start section content
- Unit tests for Feature Locations section content
- Unit tests for FAQ section structure and categories
- Unit tests for Troubleshooting section (error table, checklist)
- Unit tests for navigation structure
- All tests pass without WordPress dependencies
  </done>
</task>

</tasks>

<verification>
1. PHP syntax validation passes for all modified files
2. Settings page tooltips display on hover with correct text
3. Dashboard help button links to User Guide page
4. First-time welcome banner displays and can be dismissed
5. Welcome banner stays dismissed after page refresh
6. All unit tests pass: `composer test -- --filter UserGuidePageTest`
</verification>

<success_criteria>
1. GUIDE-05: Integration points include tooltips and help links
2. INFRA-05: Consistent with FluentCart backend UI patterns
3. Contextual help available without leaving current workflow
4. Unit tests provide coverage for content generation methods
5. First-time user experience improved with welcome message
</success_criteria>

<output>
After completion, create `.planning/phases/11-user-guidance-and-documentation/11-03-SUMMARY.md`
</output>
