---
phase: 08-settings-page-integration
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/Admin/SettingsPage.php
  - assets/js/payuni-settings.js
  - assets/css/payuni-settings.css
  - tests/Unit/Admin/SettingsPageTest.php
autonomous: true

must_haves:
  truths:
    - "Settings page shows quick links to related PayUNi features"
    - "Settings page provides API mode switch guidance"
    - "Help text explains credential configuration process"
    - "Unit tests verify credential status detection logic"
    - "Page includes troubleshooting section for common issues"
  artifacts:
    - path: "src/Admin/SettingsPage.php"
      provides: "Enhanced settings page with guidance and quick links"
      contains: "renderQuickLinks"
    - path: "assets/js/payuni-settings.js"
      provides: "Enhanced interactivity with collapsible sections"
      contains: "toggleSection"
    - path: "tests/Unit/Admin/SettingsPageTest.php"
      provides: "Unit tests for SettingsPage class"
      min_lines: 80
  key_links:
    - from: "Quick links section"
      to: "WebhookLogPage, FluentCart orders"
      via: "admin_url() links"
      pattern: "admin\\.php\\?page="
    - from: "tests/Unit/Admin/SettingsPageTest.php"
      to: "src/Admin/SettingsPage.php"
      via: "PHPUnit test cases"
      pattern: "SettingsPage.*getCredentialStatus"
---

<objective>
Enhance PayUNi Settings Page with user guidance, quick navigation links, troubleshooting help, and unit tests.

Purpose: Transform settings page from simple status display into comprehensive merchant guidance hub, reducing support burden by providing contextual help and quick access to related features.
Output: Enhanced settings page with quick links, troubleshooting section, collapsible help panels, and comprehensive unit test coverage for business logic.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md

# Reference Task 1 output
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php

# Reference existing tests for patterns
@/Users/fishtv/Development/fluentcart-payuni/tests/Unit/Admin/OrderPayUNiMetaBoxTest.php
@/Users/fishtv/Development/fluentcart-payuni/tests/Unit/Webhook/NotifyHandlerTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quick links, guidance sections, and troubleshooting help to settings page</name>
  <files>
    src/Admin/SettingsPage.php
    assets/js/payuni-settings.js
    assets/css/payuni-settings.css
  </files>
  <action>
**Update src/Admin/SettingsPage.php - Add to renderPage method:**

After webhook URLs section, add:

**Quick Links Section:**
```php
<div class="settings-section">
  <h2>快速連結</h2>
  <div class="quick-links-grid">
    <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart-payment-settings')); ?>" class="quick-link-card">
      <span class="dashicons dashicons-admin-settings"></span>
      <div>
        <strong>編輯 PayUNi 憑證</strong>
        <p>修改 MerID、Hash Key、Hash IV</p>
      </div>
    </a>

    <a href="<?php echo esc_url(admin_url('admin.php?page=payuni-webhook-logs')); ?>" class="quick-link-card">
      <span class="dashicons dashicons-list-view"></span>
      <div>
        <strong>Webhook 記錄</strong>
        <p>查看付款通知記錄</p>
      </div>
    </a>

    <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart#/orders')); ?>" class="quick-link-card">
      <span class="dashicons dashicons-cart"></span>
      <div>
        <strong>訂單列表</strong>
        <p>查看 PayUNi 交易資訊</p>
      </div>
    </a>

    <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart#/subscriptions')); ?>" class="quick-link-card">
      <span class="dashicons dashicons-update"></span>
      <div>
        <strong>訂閱列表</strong>
        <p>管理自動續扣訂閱</p>
      </div>
    </a>
  </div>
</div>
```

**Configuration Guidance Section (collapsible):**
```php
<div class="settings-section">
  <h2 class="section-toggle" data-section="config-guide">
    <span class="dashicons dashicons-arrow-down"></span>
    設定指南
  </h2>
  <div class="section-content" id="config-guide" style="display: none;">
    <h3>如何取得 PayUNi 憑證</h3>
    <ol>
      <li>登入 <a href="https://www.payuni.com.tw/" target="_blank">PayUNi 商店後台</a></li>
      <li>前往「API 串接」→「商店資訊」</li>
      <li>複製 MerID（商店代號）</li>
      <li>複製 Hash Key 和 Hash IV（API 金鑰）</li>
      <li>將憑證貼到 <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart-payment-settings')); ?>">FluentCart 支付方式設定</a></li>
    </ol>

    <h3>如何切換測試/正式環境</h3>
    <p>在 <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart-payment-settings')); ?>">FluentCart 支付方式 → PayUNi 設定</a> 中：</p>
    <ul>
      <li><strong>跟隨商店：</strong>依照 FluentCart 訂單模式（推薦）</li>
      <li><strong>強制測試：</strong>總是使用沙盒環境（開發用）</li>
      <li><strong>強制正式：</strong>總是使用正式環境（不建議）</li>
    </ul>

    <h3>設定 Webhook URL</h3>
    <p>將上方的 NotifyURL 複製到 PayUNi 後台：</p>
    <ol>
      <li>登入 PayUNi 後台</li>
      <li>前往「API 串接」→「Webhook 設定」</li>
      <li>貼上 NotifyURL</li>
      <li>儲存後點擊上方「測試連線」按鈕驗證</li>
    </ol>
  </div>
</div>
```

**Troubleshooting Section (collapsible):**
```php
<div class="settings-section">
  <h2 class="section-toggle" data-section="troubleshooting">
    <span class="dashicons dashicons-arrow-down"></span>
    常見問題排查
  </h2>
  <div class="section-content" id="troubleshooting" style="display: none;">
    <h3>❓ Webhook 測試失敗</h3>
    <ul>
      <li>檢查主機防火牆是否允許 PayUNi IP</li>
      <li>確認網站沒有使用 Basic Auth 保護</li>
      <li>檢查 SSL 憑證是否有效（正式環境必須使用 HTTPS）</li>
      <li>查看 <a href="<?php echo esc_url(admin_url('admin.php?page=payuni-webhook-logs')); ?>">Webhook 記錄</a> 確認是否有錯誤</li>
    </ul>

    <h3>❓ 付款後訂單狀態未更新</h3>
    <ul>
      <li>確認 Webhook URL 已正確設定在 PayUNi 後台</li>
      <li>檢查 <a href="<?php echo esc_url(admin_url('admin.php?page=payuni-webhook-logs')); ?>">Webhook 記錄</a> 是否有收到通知</li>
      <li>如果記錄狀態為「失敗」，查看錯誤訊息</li>
      <li>如果沒有記錄，使用上方「測試連線」按鈕驗證 Webhook 可達性</li>
    </ul>

    <h3>❓ 憑證狀態顯示「未填寫」</h3>
    <ul>
      <li>前往 <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart-payment-settings')); ?>">FluentCart 支付方式設定</a></li>
      <li>找到「PayUNi 統一金流」並點擊設定</li>
      <li>根據目前模式填寫對應的憑證（測試或正式）</li>
      <li>儲存後重新整理此頁面</li>
    </ul>

    <h3>❓ 訂閱自動續扣失敗</h3>
    <ul>
      <li>前往 <a href="<?php echo esc_url(admin_url('admin.php?page=fluent-cart#/subscriptions')); ?>">FluentCart 訂閱列表</a></li>
      <li>點擊失敗的訂閱查看 PayUNi Meta Box</li>
      <li>檢查續扣歷史和失敗原因</li>
      <li>常見原因：信用卡過期、餘額不足、需要 3D 驗證（不應發生於續扣）</li>
    </ul>
  </div>
</div>
```

**Update assets/js/payuni-settings.js:**

Add collapsible section toggle functionality:
```javascript
// Toggle collapsible sections
$('.section-toggle').on('click', function() {
  const $header = $(this);
  const sectionId = $header.data('section');
  const $content = $('#' + sectionId);
  const $icon = $header.find('.dashicons');

  $content.slideToggle(300);

  if ($icon.hasClass('dashicons-arrow-down')) {
    $icon.removeClass('dashicons-arrow-down').addClass('dashicons-arrow-up');
  } else {
    $icon.removeClass('dashicons-arrow-up').addClass('dashicons-arrow-down');
  }
});
```

**Update assets/css/payuni-settings.css:**

Add styling for new sections:
```css
.quick-links-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.quick-link-card {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: #fff;
  border: 2px solid #ddd;
  border-radius: 4px;
  text-decoration: none;
  color: #2271b1;
  transition: all 0.2s;
}

.quick-link-card:hover {
  border-color: #2271b1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.quick-link-card .dashicons {
  font-size: 32px;
  width: 32px;
  height: 32px;
  color: #2271b1;
}

.quick-link-card strong {
  display: block;
  font-size: 15px;
  margin-bottom: 4px;
  color: #1d2327;
}

.quick-link-card p {
  margin: 0;
  font-size: 13px;
  color: #646970;
}

.section-toggle {
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 0;
}

.section-toggle:hover {
  color: #2271b1;
}

.section-toggle .dashicons {
  font-size: 20px;
  width: 20px;
  height: 20px;
  transition: transform 0.3s;
}

.section-content {
  margin-top: 15px;
}

.section-content h3 {
  margin-top: 20px;
  color: #1d2327;
}

.section-content ol,
.section-content ul {
  margin-left: 20px;
  line-height: 1.8;
}

.section-content li {
  margin-bottom: 8px;
}

.section-content a {
  color: #2271b1;
  text-decoration: underline;
}

.section-content a:hover {
  color: #135e96;
}
```

**DO NOT:**
- Do NOT implement actual credential editing (that's FluentCart payment settings)
- Do NOT add too many external links (keep focused on PayUNi workflow)
- Do NOT duplicate FluentCart's own documentation

**WHY:**
- Quick links reduce navigation friction for common tasks
- Collapsible sections keep page clean while providing depth
- Troubleshooting guidance reduces support requests
- Links to related features create cohesive admin experience
  </action>
  <verify>
Check updated content:
```bash
grep -E "quick-links-grid|section-toggle|troubleshooting" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
grep "slideToggle" /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-settings.js
grep "quick-link-card" /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-settings.css
```
  </verify>
  <done>
- [x] Quick links section added with 4 cards (Payment Settings, Webhook Logs, Orders, Subscriptions)
- [x] Configuration guidance section added with collapsible toggle
- [x] Troubleshooting section added with common issues and solutions
- [x] JavaScript toggle functionality for collapsible sections
- [x] CSS styling for quick links grid and collapsible sections
- [x] All links use admin_url() for proper WordPress admin navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for SettingsPage business logic</name>
  <files>tests/Unit/Admin/SettingsPageTest.php</files>
  <action>
Create `tests/Unit/Admin/SettingsPageTest.php` following existing test patterns:

**Test structure:**
- Namespace: `BuyGoFluentCart\PayUNi\Tests\Unit\Admin`
- Extends: `PHPUnit\Framework\TestCase`
- Uses: `Yoast\PHPUnitPolyfills\TestCases\TestCase`

**Test cases:**

1. **testConstructorWithoutHooksDoesNotRegisterActions**
   - Instantiate `new SettingsPage(false)`
   - Assert no WordPress hooks are added (cannot test in unit test context, document as limitation)
   - Purpose: Verify $registerHooks parameter works for testability

2. **testGetCredentialStatusReturnsFilled**
   - Mock `PayUNiSettingsBase` with filled test credentials
   - Call `getCredentialStatus('test')`
   - Assert returns `['filled' => true, 'mer_id' => 'MS1xxxxx', 'hash_key_set' => true, 'hash_iv_set' => true]`

3. **testGetCredentialStatusReturnsEmpty**
   - Mock `PayUNiSettingsBase` with empty credentials
   - Call `getCredentialStatus('test')`
   - Assert returns `['filled' => false, 'mer_id' => '', 'hash_key_set' => false, 'hash_iv_set' => false]`

4. **testGetCredentialStatusPartiallyFilled**
   - Mock settings with only MerID filled
   - Call `getCredentialStatus('test')`
   - Assert returns `['filled' => false, 'mer_id' => 'MS1xxxxx', 'hash_key_set' => false, 'hash_iv_set' => false]`

5. **testGetCredentialStatusMasksSecrets**
   - Mock settings with test_hash_key = '1234567890abcdef'
   - Verify mer_id shows first 3 + '***' (e.g., 'MS1***')
   - Verify hash_key_set is bool (not actual key)

6. **testGetWebhookUrlsReturnsCorrectUrls**
   - Call `getWebhookUrls()`
   - Assert returns array with 'notify' and 'return' keys
   - Assert notify URL contains `fct_payment_listener=1&method=payuni`
   - Assert return URL contains `payuni_return=1`

7. **testGetWebhookUrlsUseSiteUrl**
   - Mock WordPress `site_url()` function (use function mock if needed)
   - Verify webhook URLs use site_url() as base
   - Purpose: Ensure URLs work across different WordPress installations

**Mock strategy:**
- Use PHPUnit's `createMock()` for `PayUNiSettingsBase`
- Use `method()->willReturn()` to stub getMerId, getHashKey, getHashIV
- For WordPress functions (site_url, add_query_arg), document that these are integration points

**Test helper methods:**
```php
private function createMockSettings(array $credentials): PayUNiSettingsBase
{
    $mock = $this->createMock(PayUNiSettingsBase::class);
    $mock->method('getMerId')->willReturn($credentials['mer_id'] ?? '');
    $mock->method('getHashKey')->willReturn($credentials['hash_key'] ?? '');
    $mock->method('getHashIV')->willReturn($credentials['hash_iv'] ?? '');
    return $mock;
}
```

**Important notes:**
- Unit tests CANNOT fully test WordPress hooks (admin_menu, etc.) without WordPress
- Focus tests on pure PHP logic: getCredentialStatus, getWebhookUrls
- Document that page rendering and hook registration require integration tests
- Use `@covers` annotations for code coverage tracking

**DO NOT:**
- Do NOT test actual WordPress hook registration (that's integration test territory)
- Do NOT test actual HTTP requests (mock wp_remote_head)
- Do NOT require WordPress to be loaded (pure unit test)

**WHY:**
- Unit tests verify business logic without WordPress overhead
- Mocking allows testing edge cases (empty credentials, partial fills)
- Tests document expected behavior of helper methods
- Fast execution enables TDD workflow
  </action>
  <verify>
Run unit tests:
```bash
cd /Users/fishtv/Development/fluentcart-payuni
composer test -- --filter SettingsPageTest
```

Check test structure:
```bash
grep -E "class SettingsPageTest|function test" /Users/fishtv/Development/fluentcart-payuni/tests/Unit/Admin/SettingsPageTest.php
```

Verify test count:
```bash
grep "function test" /Users/fishtv/Development/fluentcart-payuni/tests/Unit/Admin/SettingsPageTest.php | wc -l
# Should be at least 7
```
  </verify>
  <done>
- [x] SettingsPageTest.php created with 7+ test cases
- [x] Tests cover getCredentialStatus with filled/empty/partial scenarios
- [x] Tests cover getWebhookUrls URL structure
- [x] Tests use mocks for PayUNiSettingsBase
- [x] All tests pass when run via composer test
- [x] Tests use Yoast PHPUnit Polyfills for PHP 8.2 compatibility
- [x] @covers annotations present for code coverage tracking
  </done>
</task>

</tasks>

<verification>
**Manual verification steps:**

1. Navigate to WordPress admin → FluentCart → PayUNi 設定
2. Verify new sections appear:
   - Quick links grid with 4 cards
   - Configuration guidance (collapsed by default)
   - Troubleshooting section (collapsed by default)
3. Click each quick link card:
   - Payment Settings → navigates to FluentCart payment settings
   - Webhook Logs → navigates to PayUNi webhook logs page
   - Orders → navigates to FluentCart orders list
   - Subscriptions → navigates to FluentCart subscriptions list
4. Click "設定指南" header:
   - Section expands smoothly
   - Arrow icon rotates from down to up
   - Content shows configuration steps
5. Click "常見問題排查" header:
   - Section expands with troubleshooting help
   - All internal links work correctly
6. Hover over quick link cards:
   - Cards elevate slightly
   - Border color changes to blue
   - Cursor shows pointer

**Test verification:**
```bash
# Run unit tests
cd /Users/fishtv/Development/fluentcart-payuni
composer test -- --filter SettingsPageTest

# Check test coverage
composer test:coverage -- --filter SettingsPage

# Verify all tests pass
echo $? # Should be 0
```

**Code quality:**
```bash
# Check for WordPress coding standards (if PHPCS configured)
phpcs src/Admin/SettingsPage.php

# Validate JavaScript syntax
node -c assets/js/payuni-settings.js

# Validate CSS (basic check)
grep -E "^[^{]+{$" assets/css/payuni-settings.css | wc -l # Should show CSS rules
```
</verification>

<success_criteria>
**Phase complete when:**

- [ ] Quick links section displays 4 cards with correct navigation targets
- [ ] All quick links navigate to correct WordPress admin pages
- [ ] Configuration guidance section expands/collapses smoothly
- [ ] Troubleshooting section expands/collapses smoothly
- [ ] Arrow icons rotate when toggling sections
- [ ] Quick link cards have hover effects (elevation, border color)
- [ ] All internal links in guidance/troubleshooting work correctly
- [ ] External links to PayUNi website open in new tab
- [ ] Page remains responsive on mobile devices
- [ ] Unit tests pass with 7+ test cases
- [ ] Test coverage for getCredentialStatus and getWebhookUrls > 80%
- [ ] No JavaScript console errors
- [ ] No PHP errors or warnings in error log

**Requirements coverage (cumulative with Plan 01):**
- [x] SETTING-01: Admin menu contains "PayUNi → Settings" page ✓
- [x] SETTING-02: Test/production environment toggle interface (guidance provided) ✓
- [x] SETTING-03: Webhook URL displayed with reachability test button ✓
- [x] SETTING-04: API key management guidance (filled/empty status + links) ✓
- [x] SETTING-05: Settings validation (reachability test + troubleshooting) ✓

**Additional value delivered:**
- Quick navigation to related PayUNi features
- Comprehensive configuration guidance
- Troubleshooting help for common issues
- Unit test coverage for maintainability
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-page-integration/08-02-SUMMARY.md` documenting:
- Enhanced user guidance features
- Quick links navigation structure
- Collapsible section implementation
- Troubleshooting content strategy
- Unit test coverage and patterns
- Integration points with existing admin pages
</output>
