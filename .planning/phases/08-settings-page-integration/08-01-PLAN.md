---
phase: 08-settings-page-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Admin/SettingsPage.php
  - assets/css/payuni-settings.css
  - assets/js/payuni-settings.js
autonomous: true

must_haves:
  truths:
    - "Merchant can access PayUNi settings via WordPress admin menu"
    - "Settings page displays current test/live credentials status"
    - "Webhook URLs are visible and copyable"
    - "Merchants can test webhook URL reachability"
    - "Debug mode toggle works correctly"
  artifacts:
    - path: "src/Admin/SettingsPage.php"
      provides: "Settings page registration and rendering"
      min_lines: 200
      exports: ["SettingsPage"]
    - path: "assets/css/payuni-settings.css"
      provides: "Settings page styling"
      contains: ".payuni-settings-page"
    - path: "assets/js/payuni-settings.js"
      provides: "Settings page interactivity"
      contains: "testWebhookReachability"
  key_links:
    - from: "src/Admin/SettingsPage.php"
      to: "fluent-cart admin menu"
      via: "add_submenu_page hook"
      pattern: "add_submenu_page.*fluent-cart"
    - from: "assets/js/payuni-settings.js"
      to: "REST API"
      via: "jQuery AJAX"
      pattern: "\\$.ajax.*fluentcart-payuni/v1"
    - from: "fluentcart-payuni.php"
      to: "SettingsPage class"
      via: "class instantiation"
      pattern: "new.*SettingsPage"
---

<objective>
Create PayUNi Settings Page with credential status display, webhook URL management, and reachability testing.

Purpose: Provide merchants with a centralized interface to monitor PayUNi configuration health and test webhook connectivity without navigating to FluentCart payment settings.
Output: WordPress admin page under "FluentCart → PayUNi 設定" with credential status cards, webhook URL display, and connectivity test functionality.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md

# Reference existing admin pages for patterns
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/WebhookLogPage.php
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/OrderPayUNiMetaBox.php

# Reference settings structure
@/Users/fishtv/Development/fluentcart-payuni/src/Gateway/PayUNiSettingsBase.php
@/Users/fishtv/Development/fluentcart-payuni/src/Gateway/PayUNiGateway.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsPage admin page class with credential status display</name>
  <files>src/Admin/SettingsPage.php</files>
  <action>
Create `src/Admin/SettingsPage.php` following the pattern from `WebhookLogPage.php`:

**Class structure:**
- Namespace: `BuyGoFluentCart\PayUNi\Admin`
- Constants: `PAGE_SLUG = 'payuni-settings'`
- Constructor: Accept `$registerHooks` parameter (default true) for testability
- Hooks: `admin_menu` (priority 99), `admin_enqueue_scripts`

**registerAdminPage method:**
- Check `manage_options` or `manage_fluentcart` capability
- Add submenu under `fluent-cart` parent slug
- Menu title: "PayUNi 設定"
- Capability: `manage_fluentcart`

**renderPage method:**
- Display page title "PayUNi 設定"
- Show credential status section:
  - Load `PayUNiSettingsBase` to get current mode (test/live)
  - Display test credentials status card (filled/empty)
  - Display live credentials status card (filled/empty)
  - Show current active mode badge (from `getMode()`)
- Show webhook URLs section:
  - NotifyURL (with copyable input field)
  - ReturnURL (with copyable input field)
  - Test reachability button for NotifyURL
- Show debug mode status toggle (read-only display, actual toggle is in FluentCart payment settings)
- Add helpful text: "完整設定請至 FluentCart → 支付方式 → PayUNi"

**Helper methods:**
- `getCredentialStatus(string $mode): array` - Returns ['filled' => bool, 'mer_id' => string|'***', 'hash_key_set' => bool, 'hash_iv_set' => bool]
- `getWebhookUrls(): array` - Returns ['notify' => string, 'return' => string]

**DO NOT:**
- Do NOT allow editing credentials (that's handled by FluentCart payment settings)
- Do NOT create REST API routes yet (Task 2)
- Do NOT implement reachability test logic yet (Task 2)

**WHY these constraints:**
- Settings editing happens in FluentCart payment gateway settings (existing pattern)
- This page is read-only + test utilities, not a duplicate settings interface
- Reachability test requires REST API (separate task for clean execution)
  </action>
  <verify>
Check file exists and structure:
```bash
php -l /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
grep -E "class SettingsPage|registerAdminPage|renderPage|getCredentialStatus|getWebhookUrls" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
```
  </verify>
  <done>
- [x] SettingsPage.php exists with correct namespace
- [x] Class has constructor with $registerHooks parameter
- [x] registerAdminPage adds submenu under fluent-cart
- [x] renderPage displays credential status and webhook URLs
- [x] Helper methods exist and return correct data types
  </done>
</task>

<task type="auto">
  <name>Task 2: Add REST API endpoint for webhook reachability test and frontend JavaScript</name>
  <files>
    src/Admin/SettingsPage.php
    assets/js/payuni-settings.js
    assets/css/payuni-settings.css
  </files>
  <action>
**Update src/Admin/SettingsPage.php:**

Add `enqueueAssets` method (called from admin_enqueue_scripts hook):
- Only load on settings page (check $hook contains PAGE_SLUG)
- Enqueue CSS: `payuni-settings` from `assets/css/payuni-settings.css`
- Enqueue JS: `payuni-settings` from `assets/js/payuni-settings.js` with jQuery dependency
- Localize script with:
  ```php
  'restUrl' => rest_url('fluentcart-payuni/v1/settings'),
  'nonce' => wp_create_nonce('wp_rest'),
  'labels' => [
    'testingWebhook' => __('測試中...', 'fluentcart-payuni'),
    'webhookReachable' => __('✓ Webhook URL 可連線', 'fluentcart-payuni'),
    'webhookUnreachable' => __('✗ Webhook URL 無法連線', 'fluentcart-payuni'),
    'copySuccess' => __('已複製', 'fluentcart-payuni'),
  ],
  ```

Add REST API route registration (hook to `rest_api_init`):
- Endpoint: `/fluentcart-payuni/v1/settings/test-webhook`
- Method: POST
- Permission callback: `current_user_can('manage_fluentcart')`
- Callback: Test webhook URL reachability
  - Get NotifyURL from `getWebhookUrls()`
  - Make HEAD request using `wp_remote_head()` with 5s timeout
  - Return JSON: `['reachable' => bool, 'message' => string, 'status_code' => int]`

**Create assets/js/payuni-settings.js:**

jQuery-based JavaScript (WordPress admin compatibility):
```javascript
jQuery(document).ready(function($) {
  // Test webhook reachability
  $('#test-webhook-btn').on('click', function() {
    const $btn = $(this);
    const $result = $('#webhook-test-result');

    $btn.prop('disabled', true).text(payuniSettings.labels.testingWebhook);

    $.ajax({
      url: payuniSettings.restUrl + '/test-webhook',
      method: 'POST',
      beforeSend: function(xhr) {
        xhr.setRequestHeader('X-WP-Nonce', payuniSettings.nonce);
      },
      success: function(response) {
        if (response.reachable) {
          $result.html('<span class="status-success">' + payuniSettings.labels.webhookReachable + '</span>');
        } else {
          $result.html('<span class="status-error">' + payuniSettings.labels.webhookUnreachable + ' (' + response.message + ')</span>');
        }
      },
      error: function() {
        $result.html('<span class="status-error">測試失敗</span>');
      },
      complete: function() {
        $btn.prop('disabled', false).text('測試連線');
      }
    });
  });

  // Copy to clipboard functionality
  $('.copy-url-btn').on('click', function() {
    const $input = $(this).siblings('input');
    $input.select();
    document.execCommand('copy');

    const $btn = $(this);
    const originalText = $btn.text();
    $btn.text(payuniSettings.labels.copySuccess);
    setTimeout(() => $btn.text(originalText), 2000);
  });
});
```

**Create assets/css/payuni-settings.css:**

Styling following WordPress admin and webhook logs page patterns:
```css
.payuni-settings-page {
  max-width: 1200px;
}

.settings-section {
  background: #fff;
  border: 1px solid #ccd0d4;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 4px;
}

.credential-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 15px;
}

.credential-card {
  border: 2px solid #ddd;
  padding: 15px;
  border-radius: 4px;
}

.credential-card.active {
  border-color: #2271b1;
  background: #f0f6fc;
}

.credential-card.filled {
  border-left: 4px solid #46b450;
}

.credential-card.empty {
  border-left: 4px solid #dc3232;
}

.webhook-url-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  align-items: center;
}

.webhook-url-row input {
  flex: 1;
  font-family: monospace;
  font-size: 13px;
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 3px;
  font-size: 13px;
  font-weight: 600;
}

.status-badge.mode-test {
  background: #f0f6fc;
  color: #2271b1;
}

.status-badge.mode-live {
  background: #d4f4dd;
  color: #00a32a;
}

.status-success {
  color: #46b450;
  font-weight: 600;
}

.status-error {
  color: #dc3232;
  font-weight: 600;
}

@media (max-width: 768px) {
  .credential-cards {
    grid-template-columns: 1fr;
  }
}
```

**Update fluentcart-payuni.php bootstrap section:**

Add after WebhookLogPage instantiation:
```php
// PayUNi Settings Page: 後台設定頁面（憑證狀態、Webhook URL、連線測試）
if (class_exists('BuyGoFluentCart\\PayUNi\\Admin\\SettingsPage')) {
    new \BuyGoFluentCart\PayUNi\Admin\SettingsPage();
}
```

**DO NOT:**
- Do NOT use vanilla JS (use jQuery for WordPress compatibility)
- Do NOT implement settings editing (that's in FluentCart payment gateway)
- Do NOT add Vue.js (this is simple read-only page, jQuery is sufficient)

**WHY:**
- jQuery ensures WordPress admin compatibility (same pattern as webhook logs)
- REST API endpoint separates concerns (frontend/backend)
- Reachability test helps merchants debug webhook configuration issues
  </action>
  <verify>
Check all files created and integrated:
```bash
ls -la /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-settings.js
ls -la /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-settings.css
grep -E "enqueueAssets|wp_enqueue_script.*payuni-settings" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
grep "SettingsPage" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php
grep -E "rest_api_init|test-webhook" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
```

Validate JavaScript syntax:
```bash
node -c /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-settings.js 2>&1 || echo "JS syntax OK"
```
  </verify>
  <done>
- [x] payuni-settings.js exists with jQuery-based webhook test and copy functionality
- [x] payuni-settings.css exists with credential card and webhook URL styling
- [x] SettingsPage.php has enqueueAssets method with script localization
- [x] REST API route registered for /test-webhook endpoint
- [x] SettingsPage instantiated in fluentcart-payuni.php
- [x] Assets only load on PayUNi settings page (not globally)
  </done>
</task>

</tasks>

<verification>
**Manual verification steps:**

1. Navigate to WordPress admin → FluentCart → PayUNi 設定
2. Verify page displays:
   - Current mode badge (test/live)
   - Test credentials status card (filled/empty indicators)
   - Live credentials status card (filled/empty indicators)
   - NotifyURL with copy button
   - ReturnURL with copy button
   - Debug mode status
3. Click "測試連線" button next to NotifyURL:
   - Button shows "測試中..." during request
   - Result displays success/failure message
   - Button re-enables after completion
4. Click copy button next to webhook URLs:
   - Button shows "已複製" for 2 seconds
   - URL is copied to clipboard
5. Check browser console for errors (should be none)
6. Verify page is responsive on mobile (credential cards stack vertically)

**Code verification:**
```bash
# Check REST API endpoint
curl -X POST http://buygo.local/wp-json/fluentcart-payuni/v1/settings/test-webhook \
  -H "X-WP-Nonce: $(wp eval 'echo wp_create_nonce("wp_rest");')" \
  --cookie-jar cookies.txt --cookie cookies.txt

# Check admin menu registration
grep -A 5 "PayUNi 設定" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php

# Verify assets enqueue only on settings page
grep -B 5 "payuni-settings\.css" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php | grep "if.*PAGE_SLUG"
```
</verification>

<success_criteria>
**Phase complete when:**

- [ ] Settings page accessible via "FluentCart → PayUNi 設定" menu
- [ ] Credential status correctly displays filled/empty state for both test and live modes
- [ ] Current active mode (test/live) displayed with colored badge
- [ ] NotifyURL and ReturnURL displayed with copy buttons
- [ ] Copy buttons successfully copy URLs to clipboard and show confirmation
- [ ] Webhook reachability test button triggers REST API call and displays result
- [ ] Debug mode status displayed (read-only)
- [ ] Link to FluentCart payment settings displayed for full configuration
- [ ] Page styling matches WordPress admin and webhook logs page aesthetics
- [ ] Assets (CSS/JS) only load on PayUNi settings page (not globally)
- [ ] REST API endpoint requires `manage_fluentcart` capability
- [ ] Page works on mobile (responsive layout)
- [ ] No JavaScript console errors

**Requirements coverage:**
- [x] SETTING-01: Admin menu contains "PayUNi → Settings" page
- [x] SETTING-02: Test/production environment status visible (read-only display)
- [x] SETTING-03: Webhook URL displayed with reachability test button
- [x] SETTING-04: API key status visible (filled/empty indication, not actual keys)
- [x] SETTING-05: Settings validation via reachability test
</success_criteria>

<output>
After completion, create `.planning/phases/08-settings-page-integration/08-01-SUMMARY.md` documenting:
- Settings page structure and features
- REST API endpoint for webhook testing
- Frontend JavaScript interaction patterns
- CSS styling approach
- Integration points with PayUNiSettingsBase
</output>
