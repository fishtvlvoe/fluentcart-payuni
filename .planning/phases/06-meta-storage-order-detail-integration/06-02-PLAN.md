---
phase: 06-meta-storage-order-detail-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/Admin/OrderPayUNiMetaBox.php
  - src/Admin/OrderPayUNiMetaBoxUI.php
  - assets/js/payuni-order-detail.js
  - assets/css/payuni-order-detail.css
  - tests/Unit/Admin/OrderPayUNiMetaBoxTest.php
autonomous: false

must_haves:
  truths:
    - "Credit card information (last 4 digits, 3D verification status) prepared in backend data"
    - "Frontend JavaScript renders PayUNi info panel in FluentCart order detail page"
    - "All payment types (credit/ATM/CVS) display correctly in admin order view UI"
    - "Merchant can visually verify PayUNi transaction details in order detail page"
  artifacts:
    - path: "src/Admin/OrderPayUNiMetaBox.php"
      provides: "Complete PayUNi order meta box with credit card info"
      contains: "card_last4|is_3d"
    - path: "src/Admin/OrderPayUNiMetaBoxUI.php"
      provides: "JavaScript/CSS enqueue for frontend rendering"
      contains: "admin_enqueue_scripts|payuni-order-detail"
    - path: "assets/js/payuni-order-detail.js"
      provides: "Frontend rendering logic for PayUNi info panel"
      min_lines: 50
    - path: "tests/Unit/Admin/OrderPayUNiMetaBoxTest.php"
      provides: "Unit tests for helper methods"
      min_lines: 80
  key_links:
    - from: "src/Admin/OrderPayUNiMetaBox.php"
      to: "$subscription->getMeta('payuni_credit_hash')"
      via: "subscription meta lookup for credit info"
      pattern: "getMeta.*payuni_credit_hash"
    - from: "src/Admin/OrderPayUNiMetaBoxUI.php"
      to: "assets/js/payuni-order-detail.js"
      via: "wp_enqueue_script"
      pattern: "wp_enqueue_script.*payuni-order-detail"
    - from: "assets/js/payuni-order-detail.js"
      to: "order.payuni_info"
      via: "reads injected data and renders UI"
      pattern: "payuni_info"
---

<objective>
Add credit card information display to PayUNi meta box, create frontend JavaScript/CSS for rendering the PayUNi info panel in FluentCart admin, and verify the complete integration works end-to-end.

Purpose: Credit card payments are the most common payment method. Merchants need to see card info and 3D verification status for customer support and fraud detection. The injected backend data must be visually rendered in the FluentCart order detail page.
Output: Complete OrderPayUNiMetaBox with credit card info extraction, frontend rendering via JavaScript, and human verification.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-meta-storage-order-detail-integration/06-01-SUMMARY.md

# Credit card meta storage patterns
@src/Processor/PaymentProcessor.php (lines 290-300 - credit card meta)
@src/Processor/SubscriptionPaymentProcessor.php (lines 260-290 - subscription credit meta)
@src/Gateway/PayUNiSubscriptions.php (lines 300-310 - payuni_credit_hash storage)

# FluentCart admin hooks
@/Users/fishtv/Local Sites/buygo/app/public/wp-content/plugins/fluent-cart/assets/admin_hooks.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credit card information extraction to OrderPayUNiMetaBox</name>
  <files>src/Admin/OrderPayUNiMetaBox.php</files>
  <action>
Extend OrderPayUNiMetaBox to include credit card payment information:

1. In `injectPayUNiData()`, for credit card payments (`$payuniMeta['trade_type'] === 'credit'`):

2. Extract credit card info from transaction meta:
```php
$creditInit = $payuniMeta['credit_init'] ?? [];
$is3D = !empty($creditInit['is_3d']);
```

3. For subscription orders, get card info from subscription meta:
```php
$subscription = $orderModel->currentSubscription();
$cardLast4 = '';
$cardExpiry = '';

if ($subscription) {
    $activePaymentMethod = $subscription->getMeta('active_payment_method', []);
    $cardLast4 = $activePaymentMethod['details']['card_last4'] ?? '';
    $cardExpiry = $activePaymentMethod['details']['card_expiry'] ?? '';

    // CRITICAL: Check for payuni_credit_hash - this is the key_link pattern
    $hasToken = !empty($subscription->getMeta('payuni_credit_hash'));
}
```

4. For one-time credit card payments, extract from PayUNi webhook response:
   - PayUNi returns `Card4No` (last 4 digits) in notify/return responses
   - Check `$payuniMeta['Card4No']` or `$payuniMeta['card_last4']`
   - Card expiry is NOT returned by PayUNi for one-time payments (security) - handle gracefully
```php
if (empty($cardLast4)) {
    $cardLast4 = $payuniMeta['Card4No'] ?? $payuniMeta['card_last4'] ?? '';
}
// Note: card_expiry is only available for subscription orders (stored during token creation)
// For one-time payments, expiry is not returned by PayUNi API
```

5. Add to `$payuniInfo['credit']` array:
```php
'credit' => [
    'card_last4' => $cardLast4,
    'card_brand' => $this->detectCardBrand($cardLast4),
    'card_expiry' => $cardExpiry,  // Empty for one-time payments (by design)
    'is_3d_verified' => $is3D,
    '3d_label' => $is3D ? '3D 驗證通過' : '非 3D 交易',
    'has_token' => !empty($subscription ? $subscription->getMeta('payuni_credit_hash') : ''),
]
```

6. Add helper method for card brand detection:
```php
public function detectCardBrand(string $cardNumber): string {
    if (empty($cardNumber)) {
        return '信用卡';
    }

    // Based on first digit patterns (from Card4No or full card prefix)
    $firstDigit = substr($cardNumber, 0, 1);
    $firstTwo = strlen($cardNumber) >= 2 ? substr($cardNumber, 0, 2) : '';

    if ($firstDigit === '4') return 'Visa';
    if (in_array($firstTwo, ['51', '52', '53', '54', '55'])) return 'Mastercard';
    if (in_array($firstTwo, ['34', '37'])) return 'American Express';
    if ($firstTwo === '35') return 'JCB';
    if ($firstTwo === '62') return 'UnionPay';

    return '信用卡';
}
```

7. Handle subscription vs one-time payment differences:
```php
if ($order['payment_method'] === 'payuni_subscription') {
    // Get card info from subscription meta
} else {
    // Get card info from transaction response meta (only card_last4 available)
}
```

IMPORTANT: Card numbers are never stored fully - only last 4 digits.
IMPORTANT: PayUNi returns Card4No in webhook response - check actual response structure in NotifyHandler.
IMPORTANT: For one-time payments, card_expiry will be empty - this is expected behavior (PayUNi security).
IMPORTANT: Handle case where card info is not available (legacy orders, API changes).
  </action>
  <verify>
1. `grep -r "'credit'" src/Admin/OrderPayUNiMetaBox.php` shows credit card handling
2. `grep -r "detectCardBrand" src/Admin/OrderPayUNiMetaBox.php` shows brand detection
3. `grep -r "is_3d" src/Admin/OrderPayUNiMetaBox.php` shows 3D verification handling
4. `grep -r "getMeta.*payuni_credit_hash" src/Admin/OrderPayUNiMetaBox.php` confirms subscription meta lookup key_link
5. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
6. Run unit tests: `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter OrderPayUNiMetaBox`
  </verify>
  <done>
- Credit card info extraction works for subscription orders (card_last4, card_expiry)
- Credit card info extraction works for one-time payments (card_last4 only, expiry empty by design)
- Card brand detected from card number pattern
- 3D verification status displayed
- Missing card info handled gracefully (empty strings, not errors)
- Subscription meta lookup via getMeta('payuni_credit_hash') implemented (key_link verified)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontend JavaScript/CSS for PayUNi info panel rendering</name>
  <files>src/Admin/OrderPayUNiMetaBoxUI.php, assets/js/payuni-order-detail.js, assets/css/payuni-order-detail.css, fluentcart-payuni.php</files>
  <action>
Create frontend rendering for PayUNi info panel in FluentCart order detail page:

1. Create `src/Admin/OrderPayUNiMetaBoxUI.php`:
```php
namespace FluentCartPayUNi\Admin;

class OrderPayUNiMetaBoxUI {
    public function __construct() {
        add_action('admin_enqueue_scripts', [$this, 'enqueueAssets']);
    }

    public function enqueueAssets($hook) {
        // Only load on FluentCart admin pages
        if (strpos($hook, 'fluent-cart') === false &&
            !isset($_GET['page']) || strpos($_GET['page'], 'fluent-cart') === false) {
            return;
        }

        wp_enqueue_style(
            'payuni-order-detail',
            FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/css/payuni-order-detail.css',
            [],
            FLUENTCART_PAYUNI_VERSION
        );

        wp_enqueue_script(
            'payuni-order-detail',
            FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/js/payuni-order-detail.js',
            ['jquery'],
            FLUENTCART_PAYUNI_VERSION,
            true
        );

        wp_localize_script('payuni-order-detail', 'payuniOrderDetail', [
            'labels' => [
                'title' => 'PayUNi 付款資訊',
                'trade_no' => '交易編號',
                'status' => '交易狀態',
                'payment_type' => '付款方式',
                'atm_bank' => '轉帳銀行',
                'atm_account' => '虛擬帳號',
                'atm_expire' => '繳費期限',
                'cvs_code' => '繳費代碼',
                'cvs_store' => '繳費超商',
                'cvs_expire' => '繳費期限',
                'credit_card' => '信用卡',
                'credit_last4' => '卡號末四碼',
                'credit_expiry' => '有效期限',
                'credit_3d' => '3D 驗證',
                'not_available' => '無資料',
            ],
        ]);
    }
}
```

2. Create `assets/js/payuni-order-detail.js`:
```javascript
(function($) {
    'use strict';

    // Wait for FluentCart admin hooks to be available
    if (typeof window.fluentCartAdminHooks === 'undefined') {
        // Fallback: poll for order data in the page
        $(document).ready(function() {
            initPayUNiInfoPanel();
        });
        return;
    }

    // Use FluentCart admin hooks if available
    window.fluentCartAdminHooks.addAction('fluent_cart_order_loaded', 'payuni', function(order) {
        renderPayUNiInfoPanel(order);
    });

    function initPayUNiInfoPanel() {
        // Check for order data in FluentCart's Vue app or REST response
        var checkInterval = setInterval(function() {
            // Look for order detail page indicators
            var orderDetailEl = document.querySelector('.fct_order_single, [data-order-id], .fc-order-view');
            if (orderDetailEl) {
                clearInterval(checkInterval);
                // Try to get order data from page or make API call
                fetchAndRenderPayUNiInfo();
            }
        }, 500);

        // Stop checking after 10 seconds
        setTimeout(function() {
            clearInterval(checkInterval);
        }, 10000);
    }

    function fetchAndRenderPayUNiInfo() {
        // Extract order ID from URL (FluentCart uses hash routing: #/orders/{id})
        var hash = window.location.hash;
        var orderIdMatch = hash.match(/orders\/(\d+)/);
        if (!orderIdMatch) return;

        var orderId = orderIdMatch[1];

        // Fetch order data via FluentCart REST API
        $.ajax({
            url: wpApiSettings.root + 'fluent-cart/v2/orders/' + orderId,
            method: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-WP-Nonce', wpApiSettings.nonce);
            },
            success: function(response) {
                if (response && response.order && response.order.payuni_info) {
                    renderPayUNiInfoPanel(response.order);
                }
            }
        });
    }

    function renderPayUNiInfoPanel(order) {
        if (!order || !order.payuni_info) return;

        var info = order.payuni_info;
        var labels = window.payuniOrderDetail ? window.payuniOrderDetail.labels : {};

        // Remove existing panel if any
        $('.payuni-info-panel').remove();

        // Build panel HTML
        var html = '<div class="payuni-info-panel">';
        html += '<h4 class="payuni-info-title">' + (labels.title || 'PayUNi 付款資訊') + '</h4>';
        html += '<div class="payuni-info-content">';

        // Basic info
        if (info.trade_no) {
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.trade_no || '交易編號') + '</span>';
            html += '<span class="payuni-info-value">' + info.trade_no + '</span>';
            html += '</div>';
        }

        html += '<div class="payuni-info-row">';
        html += '<span class="payuni-info-label">' + (labels.status || '交易狀態') + '</span>';
        html += '<span class="payuni-info-value payuni-status-' + info.status + '">' + info.status_label + '</span>';
        html += '</div>';

        html += '<div class="payuni-info-row">';
        html += '<span class="payuni-info-label">' + (labels.payment_type || '付款方式') + '</span>';
        html += '<span class="payuni-info-value">' + info.payment_type_label + '</span>';
        html += '</div>';

        // ATM info
        if (info.atm) {
            html += '<div class="payuni-info-section payuni-atm-section">';
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.atm_bank || '轉帳銀行') + '</span>';
            html += '<span class="payuni-info-value">' + info.atm.bank_name + ' (' + info.atm.bank_code + ')</span>';
            html += '</div>';
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.atm_account || '虛擬帳號') + '</span>';
            html += '<span class="payuni-info-value payuni-highlight">' + info.atm.virtual_account + '</span>';
            html += '</div>';
            if (info.atm.expire_formatted) {
                html += '<div class="payuni-info-row">';
                html += '<span class="payuni-info-label">' + (labels.atm_expire || '繳費期限') + '</span>';
                html += '<span class="payuni-info-value">' + info.atm.expire_formatted + '</span>';
                html += '</div>';
            }
            html += '</div>';
        }

        // CVS info
        if (info.cvs) {
            html += '<div class="payuni-info-section payuni-cvs-section">';
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.cvs_store || '繳費超商') + '</span>';
            html += '<span class="payuni-info-value">' + info.cvs.store_name + '</span>';
            html += '</div>';
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.cvs_code || '繳費代碼') + '</span>';
            html += '<span class="payuni-info-value payuni-highlight">' + info.cvs.payment_no + '</span>';
            html += '</div>';
            if (info.cvs.expire_formatted) {
                html += '<div class="payuni-info-row">';
                html += '<span class="payuni-info-label">' + (labels.cvs_expire || '繳費期限') + '</span>';
                html += '<span class="payuni-info-value">' + info.cvs.expire_formatted + '</span>';
                html += '</div>';
            }
            html += '</div>';
        }

        // Credit card info
        if (info.credit) {
            html += '<div class="payuni-info-section payuni-credit-section">';
            if (info.credit.card_last4) {
                html += '<div class="payuni-info-row">';
                html += '<span class="payuni-info-label">' + (labels.credit_card || '信用卡') + '</span>';
                html += '<span class="payuni-info-value">' + info.credit.card_brand + ' **** ' + info.credit.card_last4 + '</span>';
                html += '</div>';
            }
            if (info.credit.card_expiry) {
                html += '<div class="payuni-info-row">';
                html += '<span class="payuni-info-label">' + (labels.credit_expiry || '有效期限') + '</span>';
                html += '<span class="payuni-info-value">' + info.credit.card_expiry + '</span>';
                html += '</div>';
            }
            html += '<div class="payuni-info-row">';
            html += '<span class="payuni-info-label">' + (labels.credit_3d || '3D 驗證') + '</span>';
            html += '<span class="payuni-info-value ' + (info.credit.is_3d_verified ? 'payuni-3d-verified' : '') + '">' + info.credit['3d_label'] + '</span>';
            html += '</div>';
            html += '</div>';
        }

        html += '</div></div>';

        // Insert panel into FluentCart order detail page
        // Try multiple selectors for FluentCart order detail layout
        var targetSelectors = [
            '.fct_order_single .fct_order_sidebar',  // Sidebar area
            '.fc-order-sidebar',                     // Alternative sidebar
            '.fct_order_single .fct_order_main',     // Main content area
            '.fc-order-view',                        // Order view wrapper
        ];

        var inserted = false;
        for (var i = 0; i < targetSelectors.length; i++) {
            var target = $(targetSelectors[i]);
            if (target.length) {
                target.first().prepend(html);
                inserted = true;
                break;
            }
        }

        // Fallback: append to body as floating panel
        if (!inserted) {
            $('body').append(html);
            $('.payuni-info-panel').addClass('payuni-floating-panel');
        }
    }

    // Re-render on hash change (SPA navigation)
    $(window).on('hashchange', function() {
        setTimeout(initPayUNiInfoPanel, 500);
    });

})(jQuery);
```

3. Create `assets/css/payuni-order-detail.css`:
```css
.payuni-info-panel {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.payuni-info-title {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.payuni-info-content {
    font-size: 13px;
}

.payuni-info-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed #f0f0f0;
}

.payuni-info-row:last-child {
    border-bottom: none;
}

.payuni-info-label {
    color: #666;
    flex-shrink: 0;
    margin-right: 12px;
}

.payuni-info-value {
    color: #333;
    font-weight: 500;
    text-align: right;
    word-break: break-all;
}

.payuni-info-section {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eee;
}

.payuni-highlight {
    font-family: 'Courier New', monospace;
    background: #f5f5f5;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    letter-spacing: 1px;
}

.payuni-status-succeeded {
    color: #22c55e;
}

.payuni-status-pending {
    color: #f59e0b;
}

.payuni-status-failed {
    color: #ef4444;
}

.payuni-3d-verified {
    color: #22c55e;
}

.payuni-floating-panel {
    position: fixed;
    top: 100px;
    right: 20px;
    width: 300px;
    z-index: 9999;
}
```

4. In `fluentcart-payuni.php`, add require and instantiate:
```php
// In requires section
require_once __DIR__ . '/src/Admin/OrderPayUNiMetaBoxUI.php';

// In init() method, after OrderPayUNiMetaBox
new \FluentCartPayUNi\Admin\OrderPayUNiMetaBoxUI();
```

IMPORTANT: FluentCart uses Vue.js SPA with hash routing, so we need to handle hash changes.
IMPORTANT: Use FluentCart's REST API to fetch order data if hooks not available.
IMPORTANT: Multiple selector fallbacks ensure panel renders in various FluentCart versions.
  </action>
  <verify>
1. `ls assets/js/payuni-order-detail.js` - File exists
2. `ls assets/css/payuni-order-detail.css` - File exists
3. `grep -r "admin_enqueue_scripts" src/Admin/OrderPayUNiMetaBoxUI.php` - Hook registered
4. `grep -r "OrderPayUNiMetaBoxUI" fluentcart-payuni.php` - Class instantiated
5. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBoxUI.php` returns no errors
  </verify>
  <done>
- OrderPayUNiMetaBoxUI.php enqueues JS/CSS on FluentCart admin pages
- JavaScript renders PayUNi info panel in order detail page
- CSS styles the panel consistently with FluentCart design
- Panel shows for ATM, CVS, and credit card payments
- SPA navigation handled via hashchange listener
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for OrderPayUNiMetaBox</name>
  <files>tests/Unit/Admin/OrderPayUNiMetaBoxTest.php</files>
  <action>
Create unit tests for OrderPayUNiMetaBox helper methods:

1. Create `tests/Unit/Admin/OrderPayUNiMetaBoxTest.php`:
```php
namespace FluentCartPayUNi\Tests\Unit\Admin;

use PHPUnit\Framework\TestCase;
use FluentCartPayUNi\Admin\OrderPayUNiMetaBox;

class OrderPayUNiMetaBoxTest extends TestCase {
    private OrderPayUNiMetaBox $metaBox;

    protected function setUp(): void {
        parent::setUp();
        // Create instance without triggering WordPress hooks
        $this->metaBox = new OrderPayUNiMetaBox(false);
    }

    // getBankName tests
    public function testGetBankNameReturnsKnownBankName(): void {
        $this->assertEquals('中國信託', $this->metaBox->getBankName('822'));
        $this->assertEquals('玉山銀行', $this->metaBox->getBankName('808'));
        $this->assertEquals('台新銀行', $this->metaBox->getBankName('812'));
    }

    public function testGetBankNameReturnsCodeForUnknownBank(): void {
        $this->assertEquals('999', $this->metaBox->getBankName('999'));
        $this->assertEquals('ABC', $this->metaBox->getBankName('ABC'));
    }

    public function testGetBankNameHandlesEmptyString(): void {
        $this->assertEquals('', $this->metaBox->getBankName(''));
    }

    // getStoreName tests
    public function testGetStoreNameReturnsKnownStoreName(): void {
        $this->assertEquals('7-ELEVEN', $this->metaBox->getStoreName('1'));
        $this->assertEquals('全家 FamilyMart', $this->metaBox->getStoreName('2'));
        $this->assertEquals('萊爾富 Hi-Life', $this->metaBox->getStoreName('3'));
        $this->assertEquals('OK 超商', $this->metaBox->getStoreName('4'));
    }

    public function testGetStoreNameReturnsTypeForUnknownStore(): void {
        $this->assertEquals('5', $this->metaBox->getStoreName('5'));
        $this->assertEquals('unknown', $this->metaBox->getStoreName('unknown'));
    }

    public function testGetStoreNameHandlesEmptyString(): void {
        $this->assertEquals('', $this->metaBox->getStoreName(''));
    }

    // formatExpireDate tests
    public function testFormatExpireDateFormatsValidDate(): void {
        $this->assertEquals('2025/02/15 14:30', $this->metaBox->formatExpireDate('2025-02-15 14:30:00'));
        $this->assertEquals('2025/12/31 23:59', $this->metaBox->formatExpireDate('2025/12/31 23:59:59'));
    }

    public function testFormatExpireDateHandlesEmptyString(): void {
        $this->assertEquals('', $this->metaBox->formatExpireDate(''));
    }

    public function testFormatExpireDateReturnsOriginalForInvalidDate(): void {
        $this->assertEquals('invalid-date', $this->metaBox->formatExpireDate('invalid-date'));
    }

    // detectCardBrand tests
    public function testDetectCardBrandDetectsVisa(): void {
        $this->assertEquals('Visa', $this->metaBox->detectCardBrand('4123'));
        $this->assertEquals('Visa', $this->metaBox->detectCardBrand('4'));
    }

    public function testDetectCardBrandDetectsMastercard(): void {
        $this->assertEquals('Mastercard', $this->metaBox->detectCardBrand('5123'));
        $this->assertEquals('Mastercard', $this->metaBox->detectCardBrand('51'));
        $this->assertEquals('Mastercard', $this->metaBox->detectCardBrand('55'));
    }

    public function testDetectCardBrandDetectsJCB(): void {
        $this->assertEquals('JCB', $this->metaBox->detectCardBrand('3512'));
        $this->assertEquals('JCB', $this->metaBox->detectCardBrand('35'));
    }

    public function testDetectCardBrandDetectsAmex(): void {
        $this->assertEquals('American Express', $this->metaBox->detectCardBrand('3456'));
        $this->assertEquals('American Express', $this->metaBox->detectCardBrand('37'));
    }

    public function testDetectCardBrandReturnsDefaultForUnknown(): void {
        $this->assertEquals('信用卡', $this->metaBox->detectCardBrand('9999'));
        $this->assertEquals('信用卡', $this->metaBox->detectCardBrand(''));
        $this->assertEquals('信用卡', $this->metaBox->detectCardBrand('1'));
    }
}
```

2. Ensure tests/bootstrap-unit.php autoloads Admin namespace properly.

IMPORTANT: Tests use $registerHooks = false to avoid WordPress function calls.
IMPORTANT: All helper methods should be public for testability.
  </action>
  <verify>
1. Run tests: `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter OrderPayUNiMetaBox`
2. All tests pass (should be 15+ tests)
3. Test output shows coverage for bank mapping, store mapping, date formatting, and card brand detection
  </verify>
  <done>
- OrderPayUNiMetaBoxTest.php exists with 15+ test cases
- Tests pass without WordPress environment
- Helper method mappings verified (bank, store, card brand)
- Edge cases (empty data, unknown codes) covered
- formatExpireDate tests cover valid, empty, and invalid dates
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete PayUNi meta box integration for FluentCart order detail page, including:
- Backend data injection via fluent_cart/order/view filter (transaction status, ATM/CVS/credit info)
- Frontend JavaScript rendering of PayUNi info panel
- CSS styling consistent with FluentCart design
- Unit tests for all helper methods
  </what-built>
  <how-to-verify>
1. Access WordPress admin: https://test.buygo.me/wp-admin
2. Navigate to FluentCart -> Orders
3. Find a PayUNi order (credit card payment)
   - Verify PayUNi info panel appears in order detail page
   - Check panel shows: 交易編號, 交易狀態, 付款方式
   - Check credit card section shows: 卡號末四碼, 3D 驗證狀態
4. Find an ATM payment order (if available)
   - Verify panel shows: 轉帳銀行, 虛擬帳號, 繳費期限
5. Find a CVS payment order (if available)
   - Verify panel shows: 繳費超商, 繳費代碼, 繳費期限
6. Verify non-PayUNi orders do not show PayUNi info panel
7. Check browser console for any JavaScript errors

Note: If no test orders exist, create test orders using PayUNi sandbox:
- Credit card: Use test card 4000-2211-1111-1111
- ATM: Select ATM payment type at checkout
- CVS: Select CVS payment type at checkout
  </how-to-verify>
  <resume-signal>Type "approved" if PayUNi info panel displays correctly in order detail page, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `composer test -- --filter OrderPayUNiMetaBox` - All tests pass (15+ tests)
2. `php -l src/Admin/OrderPayUNiMetaBox.php` - No syntax errors
3. `php -l src/Admin/OrderPayUNiMetaBoxUI.php` - No syntax errors
4. `grep -r "getMeta.*payuni_credit_hash" src/Admin/OrderPayUNiMetaBox.php` - Key link verified
5. Manual verification in FluentCart admin shows PayUNi data panel
6. All payment types (credit/ATM/CVS) display correct info in UI
7. Non-PayUNi orders pass through unchanged (no panel shown)
</verification>

<success_criteria>
1. Credit card info extraction works for both subscription and one-time payments
2. Card brand detection returns correct brand names
3. 3D verification status displays correctly
4. All unit tests pass (15+ tests covering all helper methods)
5. Frontend JavaScript renders PayUNi info panel in FluentCart order detail
6. Human verification confirms PayUNi data visually displayed in FluentCart admin UI
7. Phase 6 requirements ORDER-01 through ORDER-05 and INFRA-01 all satisfied
8. Subscription meta lookup via getMeta('payuni_credit_hash') implemented (key_link verified)
</success_criteria>

<output>
After completion, create `.planning/phases/06-meta-storage-order-detail-integration/06-02-SUMMARY.md`
</output>
