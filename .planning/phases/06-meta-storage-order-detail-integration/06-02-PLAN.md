---
phase: 06-meta-storage-order-detail-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/Admin/OrderPayUNiMetaBox.php
  - tests/Unit/Admin/OrderPayUNiMetaBoxTest.php
autonomous: false

must_haves:
  truths:
    - "Credit card information visible (last 4 digits, expiry, 3D verification status)"
    - "All payment types display correctly in admin order view"
    - "Merchant can verify PayUNi transaction details match order"
  artifacts:
    - path: "src/Admin/OrderPayUNiMetaBox.php"
      provides: "Complete PayUNi order meta box with credit card info"
      contains: "credit_hash|card_last4|is_3d"
  key_links:
    - from: "src/Admin/OrderPayUNiMetaBox.php"
      to: "$subscription->getMeta('payuni_credit_hash')"
      via: "subscription meta lookup for credit info"
      pattern: "getMeta.*payuni_credit_hash"
    - from: "src/Admin/OrderPayUNiMetaBox.php"
      to: "$payuniMeta['credit_init']"
      via: "transaction meta for 3D status"
      pattern: "credit_init.*is_3d"
---

<objective>
Add credit card information display to PayUNi meta box and verify the complete order detail integration works end-to-end.

Purpose: Credit card payments are the most common payment method. Merchants need to see card info and 3D verification status for customer support and fraud detection.
Output: Complete OrderPayUNiMetaBox with credit card info extraction and human verification of the full integration.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-meta-storage-order-detail-integration/06-01-SUMMARY.md

# Credit card meta storage patterns
@src/Processor/PaymentProcessor.php (lines 290-300 - credit card meta)
@src/Processor/SubscriptionPaymentProcessor.php (lines 260-290 - subscription credit meta)
@src/Gateway/PayUNiSubscriptions.php (lines 300-310 - payuni_credit_hash storage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add credit card information extraction to OrderPayUNiMetaBox</name>
  <files>src/Admin/OrderPayUNiMetaBox.php</files>
  <action>
Extend OrderPayUNiMetaBox to include credit card payment information:

1. In `injectPayUNiData()`, for credit card payments (`$payuniMeta['trade_type'] === 'credit'`):

2. Extract credit card info from transaction meta:
```php
$creditInit = $payuniMeta['credit_init'] ?? [];
$is3D = !empty($creditInit['is_3d']);
```

3. For subscription orders, get card info from subscription meta:
```php
$subscription = $orderModel->currentSubscription();
if ($subscription) {
    $activePaymentMethod = $subscription->getMeta('active_payment_method', []);
    $cardLast4 = $activePaymentMethod['details']['card_last4'] ?? '';
    $cardExpiry = $activePaymentMethod['details']['card_expiry'] ?? '';
}
```

4. For one-time credit card payments, extract from transaction response:
   - Card info may be in PayUNi response stored in meta
   - Check `$payuniMeta['Card4No']` or similar field (verify against actual PayUNi response)

5. Add to `$payuniInfo['credit']` array:
```php
'credit' => [
    'card_last4' => $cardLast4 ?? '',
    'card_brand' => $this->detectCardBrand($cardLast4 ?? ''),
    'card_expiry' => $cardExpiry ?? '',
    'is_3d_verified' => $is3D,
    '3d_label' => $is3D ? '3D 驗證通過' : '非 3D 交易',
    'has_token' => !empty($creditHash),
]
```

6. Add helper method for card brand detection:
```php
private function detectCardBrand(string $cardNumber): string {
    // Based on first digit patterns
    $firstDigit = substr($cardNumber, 0, 1);
    $firstTwo = substr($cardNumber, 0, 2);

    if ($firstDigit === '4') return 'Visa';
    if (in_array($firstTwo, ['51', '52', '53', '54', '55'])) return 'Mastercard';
    if (in_array($firstTwo, ['34', '37'])) return 'American Express';
    if ($firstTwo === '35') return 'JCB';
    if ($firstTwo === '62') return 'UnionPay';

    return '信用卡';
}
```

7. Handle subscription vs one-time payment differences:
```php
if ($order['payment_method'] === 'payuni_subscription') {
    // Get card info from subscription meta
} else {
    // Get card info from transaction response meta
}
```

IMPORTANT: Card numbers are never stored fully - only last 4 digits.
IMPORTANT: PayUNi may return Card4No in webhook response - check actual response structure.
IMPORTANT: Handle case where card info is not available (legacy orders, API changes).
  </action>
  <verify>
1. `grep -r "'credit'" src/Admin/OrderPayUNiMetaBox.php` shows credit card handling
2. `grep -r "detectCardBrand" src/Admin/OrderPayUNiMetaBox.php` shows brand detection
3. `grep -r "is_3d" src/Admin/OrderPayUNiMetaBox.php` shows 3D verification handling
4. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- Credit card info extraction works for subscription orders
- Credit card info extraction works for one-time payments
- Card brand detected from card number pattern
- 3D verification status displayed
- Missing card info handled gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for credit card extraction</name>
  <files>tests/Unit/Admin/OrderPayUNiMetaBoxTest.php</files>
  <action>
Add unit tests for credit card information extraction:

1. Add tests for detectCardBrand():
   - Test '4' prefix returns 'Visa'
   - Test '51' prefix returns 'Mastercard'
   - Test '35' prefix returns 'JCB'
   - Test unknown prefix returns '信用卡'
   - Test empty string returns '信用卡'

2. Add tests for credit card data extraction:
   - Test subscription order extracts card info from subscription meta
   - Test 3D verified transaction has `is_3d_verified: true`
   - Test non-3D transaction has `is_3d_verified: false`
   - Test missing card info returns empty strings

3. Add integration-style tests:
   - Test complete payuni_info structure for credit card order
   - Test complete payuni_info structure for ATM order
   - Test complete payuni_info structure for CVS order

4. Run full test suite to ensure no regressions:
```bash
composer test -- --filter OrderPayUNiMetaBox
```

IMPORTANT: Keep tests isolated - mock FluentCart models if needed.
  </action>
  <verify>
1. Run tests: `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter OrderPayUNiMetaBox`
2. All tests pass (should be 10+ tests now)
3. Test output shows credit card, ATM, and CVS coverage
  </verify>
  <done>
- detectCardBrand tests pass for all major brands
- Credit card extraction tests pass
- 3D verification status tests pass
- All OrderPayUNiMetaBox tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete PayUNi meta box integration for FluentCart order detail page, including:
- Transaction status display (success/failed/processing)
- ATM virtual account info (bank code, account number, expiry)
- CVS payment code info (code, store type, expiry)
- Credit card info (last 4 digits, brand, 3D verification)
  </what-built>
  <how-to-verify>
1. Access WordPress admin: https://test.buygo.me/wp-admin
2. Navigate to FluentCart -> Orders
3. Find a PayUNi order (credit card payment)
   - Verify payuni_info is injected into order data
   - Check browser console: Order view API response should include payuni_info
4. Find an ATM payment order (if available)
   - Verify bank code and virtual account visible
5. Find a CVS payment order (if available)
   - Verify payment code and store type visible
6. Verify non-PayUNi orders (if any) do not have payuni_info

Note: If no test orders exist, create test orders using PayUNi sandbox:
- Credit card: Use test card 4000-2211-1111-1111
- ATM: Select ATM payment type at checkout
- CVS: Select CVS payment type at checkout
  </how-to-verify>
  <resume-signal>Type "approved" if PayUNi info displays correctly in order detail, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `composer test -- --filter OrderPayUNiMetaBox` - All tests pass (10+ tests)
2. Manual verification in FluentCart admin shows PayUNi data
3. All payment types (credit/ATM/CVS) display correct info
4. Non-PayUNi orders pass through unchanged
</verification>

<success_criteria>
1. Credit card info extraction works for both subscription and one-time payments
2. Card brand detection returns correct brand names
3. 3D verification status displays correctly
4. All unit tests pass
5. Human verification confirms PayUNi data visible in FluentCart admin
6. Phase 6 requirements ORDER-01 through ORDER-05 and INFRA-01 all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-meta-storage-order-detail-integration/06-02-SUMMARY.md`
</output>
