---
phase: 06-meta-storage-order-detail-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Admin/OrderPayUNiMetaBox.php
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "Backend prepares PayUNi transaction data (status, payment type) for order view API"
    - "ATM virtual account data (account number, bank code, expiry date) extracted and structured"
    - "CVS payment code data (code, store type, expiry date) extracted and structured"
    - "PayUNi meta box injected via filter without modifying FluentCart core"
  artifacts:
    - path: "src/Admin/OrderPayUNiMetaBox.php"
      provides: "PayUNi order meta box component"
      min_lines: 150
      exports: ["OrderPayUNiMetaBox"]
  key_links:
    - from: "fluentcart-payuni.php"
      to: "src/Admin/OrderPayUNiMetaBox.php"
      via: "require and hook registration"
      pattern: "add_filter.*fluent_cart/order/view"
    - from: "src/Admin/OrderPayUNiMetaBox.php"
      to: "$transaction->meta['payuni']"
      via: "reading transaction meta"
      pattern: "\\$transaction->meta\\['payuni'\\]"
---

<objective>
Create PayUNi meta box for FluentCart order detail page displaying transaction status, ATM virtual account info, and CVS payment code info.

Purpose: Merchants need to see PayUNi transaction information directly in the order detail page to verify payment status and share payment instructions with customers.
Output: OrderPayUNiMetaBox.php class that injects PayUNi data into FluentCart order view via filter.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

# Existing code patterns
@src/Processor/PaymentProcessor.php (lines 620-640 - ATM/CVS pending meta structure)
@src/Webhook/NotifyHandler.php (lines 165-175 - pending payment meta)
@docs/fluentcart-reference/fluentcart.com_doc/hooks_filters_orders-and-payments.md (fluent_cart/order/view filter)
@docs/fluentcart-reference/fluentcart.com_doc/database_models_order.md (Order model and relations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderPayUNiMetaBox class with basic structure and registration</name>
  <files>src/Admin/OrderPayUNiMetaBox.php, fluentcart-payuni.php</files>
  <action>
Create `src/Admin/OrderPayUNiMetaBox.php` class with:

1. Class structure:
```php
namespace FluentCartPayUNi\Admin;

class OrderPayUNiMetaBox {
    public function __construct(bool $registerHooks = true) {
        if ($registerHooks) {
            add_filter('fluent_cart/order/view', [$this, 'injectPayUNiData'], 20, 2);
        }
    }

    public function injectPayUNiData(array $order, array $data): array {
        // Only process PayUNi orders
        // Add payuni_info key to order array
    }
}
```

2. In `injectPayUNiData()`:
   - Check if `$order['payment_method']` is 'payuni' or 'payuni_subscription'
   - If not PayUNi order, return $order unchanged
   - Load Order model: `$orderModel = \FluentCart\App\Models\Order::find($order['id'])`
   - Get latest transaction: `$transaction = $orderModel->getLatestTransaction()`

3. **Extract PayUNi meta from transaction using explicit access pattern:**
```php
// CRITICAL: This is the key_link pattern for accessing PayUNi transaction meta
$payuniMeta = $transaction->meta['payuni'] ?? [];
```

4. Build `$payuniInfo` array with:
   - `trade_no`: From `$transaction->vendor_charge_id` or `$payuniMeta['trade_no']`
   - `status`: Map from `$transaction->status` (succeeded/failed/pending)
   - `status_label`: Human-readable label ('成功'/'失敗'/'處理中')
   - `payment_type`: From `$payuniMeta['trade_type']` ('credit'/'atm'/'cvs')
   - `payment_type_label`: Human-readable label ('信用卡'/'ATM 轉帳'/'超商代碼')

5. Add `$order['payuni_info'] = $payuniInfo` and return

6. In `fluentcart-payuni.php`:
   - Add require statement for new class (around line 50 with other requires)
   - In `init()` method, instantiate: `new \FluentCartPayUNi\Admin\OrderPayUNiMetaBox()`
   - Use priority 20 in plugins_loaded to ensure FluentCart loads first

IMPORTANT: Use priority 20 in filter registration to ensure FluentCart data is ready.
IMPORTANT: Check class_exists for FluentCart\App\Models\Order before usage.
IMPORTANT: Constructor accepts $registerHooks parameter for testability.
  </action>
  <verify>
1. `grep -r "fluent_cart/order/view" src/Admin/` returns the filter hook
2. `grep -r "OrderPayUNiMetaBox" fluentcart-payuni.php` shows registration
3. `grep -r "\\$transaction->meta\\['payuni'\\]" src/Admin/OrderPayUNiMetaBox.php` confirms key_link pattern exists
4. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- OrderPayUNiMetaBox.php exists with filter registration
- Class is instantiated in main plugin file
- Filter hook uses priority 20
- Payment method check filters non-PayUNi orders
- Constructor accepts $registerHooks parameter for testability
- Transaction meta accessed via `$transaction->meta['payuni']` pattern
  </done>
</task>

<task type="auto">
  <name>Task 2a: Add ATM virtual account display logic</name>
  <files>src/Admin/OrderPayUNiMetaBox.php</files>
  <action>
Extend OrderPayUNiMetaBox to include ATM pending payment information:

1. In `injectPayUNiData()`, after basic info extraction, check for pending payment:
```php
$pendingInfo = $payuniMeta['pending'] ?? [];
$paymentType = $pendingInfo['payment_type'] ?? '';
```

2. For ATM payments (`$paymentType === '2'` or `$payuniMeta['trade_type'] === 'atm'`):
   - Extract from `$pendingInfo`:
     - `bank_code`: 銀行代碼
     - `virtual_account`: 虛擬帳號
     - `expire_date`: 到期日 (format: Y/m/d H:i:s or similar)
   - Add to `$payuniInfo['atm']` array:
     ```php
     'atm' => [
         'bank_code' => $pendingInfo['bank_code'] ?? '',
         'bank_name' => $this->getBankName($pendingInfo['bank_code'] ?? ''),
         'virtual_account' => $pendingInfo['virtual_account'] ?? '',
         'expire_date' => $pendingInfo['expire_date'] ?? '',
         'expire_formatted' => $this->formatExpireDate($pendingInfo['expire_date'] ?? ''),
     ]
     ```

3. Add helper method for bank code mapping:
```php
public function getBankName(string $bankCode): string {
    $banks = [
        '004' => '台灣銀行',
        '005' => '土地銀行',
        '006' => '合作金庫',
        '007' => '第一銀行',
        '008' => '華南銀行',
        '009' => '彰化銀行',
        '011' => '上海銀行',
        '012' => '台北富邦',
        '013' => '國泰世華',
        '017' => '兆豐銀行',
        '021' => '花旗銀行',
        '050' => '台灣企銀',
        '053' => '台中商銀',
        '803' => '聯邦銀行',
        '808' => '玉山銀行',
        '812' => '台新銀行',
        '822' => '中國信託',
    ];
    return $banks[$bankCode] ?? $bankCode;
}
```

4. Add helper method for date formatting:
```php
public function formatExpireDate(string $date): string {
    if (empty($date)) {
        return '';
    }
    try {
        $dateObj = new \DateTime($date);
        return $dateObj->format('Y/m/d H:i');
    } catch (\Exception $e) {
        return $date;
    }
}
```

IMPORTANT: Handle empty/missing data gracefully - always use null coalescing operator.
IMPORTANT: Make helper methods public for testability.
  </action>
  <verify>
1. `grep -r "getBankName" src/Admin/OrderPayUNiMetaBox.php` shows helper method exists
2. `grep -r "'atm'" src/Admin/OrderPayUNiMetaBox.php` shows ATM payment type handling
3. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- ATM info extraction works (bank_code, virtual_account, expire_date)
- Bank code mapping returns human-readable names
- Empty data handled gracefully without errors
  </done>
</task>

<task type="auto">
  <name>Task 2b: Add CVS payment code display logic</name>
  <files>src/Admin/OrderPayUNiMetaBox.php</files>
  <action>
Extend OrderPayUNiMetaBox to include CVS pending payment information:

1. For CVS payments (`$paymentType === '3'` or `$payuniMeta['trade_type'] === 'cvs'`):
   - Extract from `$pendingInfo`:
     - `payment_no`: 繳費代碼
     - `store_type`: 超商類型 (1/2/3/4)
     - `expire_date`: 到期日
   - Add to `$payuniInfo['cvs']` array:
     ```php
     'cvs' => [
         'payment_no' => $pendingInfo['payment_no'] ?? '',
         'store_type' => $pendingInfo['store_type'] ?? '',
         'store_name' => $this->getStoreName($pendingInfo['store_type'] ?? ''),
         'expire_date' => $pendingInfo['expire_date'] ?? '',
         'expire_formatted' => $this->formatExpireDate($pendingInfo['expire_date'] ?? ''),
     ]
     ```

2. Add helper method for store type mapping:
```php
public function getStoreName(string $storeType): string {
    $stores = [
        '1' => '7-ELEVEN',
        '2' => '全家 FamilyMart',
        '3' => '萊爾富 Hi-Life',
        '4' => 'OK 超商',
    ];
    return $stores[$storeType] ?? $storeType;
}
```

IMPORTANT: Handle empty/missing data gracefully - always use null coalescing operator.
IMPORTANT: Check if $pendingInfo exists before accessing its properties.
  </action>
  <verify>
1. `grep -r "getStoreName" src/Admin/OrderPayUNiMetaBox.php` shows helper method exists
2. `grep -r "'cvs'" src/Admin/OrderPayUNiMetaBox.php` shows CVS payment type handling
3. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- CVS info extraction works (payment_no, store_type, expire_date)
- Store type mapping returns human-readable names
- Empty data handled gracefully without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php -l src/Admin/OrderPayUNiMetaBox.php` - No syntax errors
2. `grep -r "fluent_cart/order/view" src/` - Filter hook registered
3. `grep -r "\\$transaction->meta\\['payuni'\\]" src/Admin/` - Key link pattern verified
4. Check git diff shows expected changes
</verification>

<success_criteria>
1. OrderPayUNiMetaBox class created and registered in main plugin file
2. Filter injects payuni_info into order view data for PayUNi orders
3. ATM payment info (bank code, virtual account, expiry) extracted correctly
4. CVS payment info (payment code, store type, expiry) extracted correctly
5. Non-PayUNi orders pass through unchanged
6. Helper methods are public for testability
7. Transaction meta accessed via `$transaction->meta['payuni']` pattern (key_link verified)
</success_criteria>

<output>
After completion, create `.planning/phases/06-meta-storage-order-detail-integration/06-01-SUMMARY.md`
</output>
