---
phase: 06-meta-storage-order-detail-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Admin/OrderPayUNiMetaBox.php
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "Order detail page displays PayUNi transaction status (success/failed/processing)"
    - "ATM virtual account information visible (account number, bank code, expiry date)"
    - "CVS payment code information visible (code, store type, expiry date)"
    - "PayUNi meta box injected via filter without modifying FluentCart core"
  artifacts:
    - path: "src/Admin/OrderPayUNiMetaBox.php"
      provides: "PayUNi order meta box component"
      min_lines: 150
      exports: ["OrderPayUNiMetaBox"]
  key_links:
    - from: "fluentcart-payuni.php"
      to: "src/Admin/OrderPayUNiMetaBox.php"
      via: "require and hook registration"
      pattern: "add_filter.*fluent_cart/order/view"
    - from: "src/Admin/OrderPayUNiMetaBox.php"
      to: "$transaction->meta['payuni']"
      via: "reading transaction meta"
      pattern: "\\$transaction->meta\\['payuni'\\]"
---

<objective>
Create PayUNi meta box for FluentCart order detail page displaying transaction status, ATM virtual account info, and CVS payment code info.

Purpose: Merchants need to see PayUNi transaction information directly in the order detail page to verify payment status and share payment instructions with customers.
Output: OrderPayUNiMetaBox.php class that injects PayUNi data into FluentCart order view via filter.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

# Existing code patterns
@src/Processor/PaymentProcessor.php (lines 620-640 - ATM/CVS pending meta structure)
@src/Webhook/NotifyHandler.php (lines 165-175 - pending payment meta)
@docs/fluentcart-reference/fluentcart.com_doc/hooks_filters_orders-and-payments.md (fluent_cart/order/view filter)
@docs/fluentcart-reference/fluentcart.com_doc/database_models_order.md (Order model and relations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrderPayUNiMetaBox class with basic structure and registration</name>
  <files>src/Admin/OrderPayUNiMetaBox.php, fluentcart-payuni.php</files>
  <action>
Create `src/Admin/OrderPayUNiMetaBox.php` class with:

1. Class structure:
```php
namespace FluentCartPayUNi\Admin;

class OrderPayUNiMetaBox {
    public function __construct() {
        add_filter('fluent_cart/order/view', [$this, 'injectPayUNiData'], 20, 2);
    }

    public function injectPayUNiData(array $order, array $data): array {
        // Only process PayUNi orders
        // Add payuni_info key to order array
    }
}
```

2. In `injectPayUNiData()`:
   - Check if `$order['payment_method']` is 'payuni' or 'payuni_subscription'
   - If not PayUNi order, return $order unchanged
   - Load Order model: `$orderModel = \FluentCart\App\Models\Order::find($order['id'])`
   - Get latest transaction: `$transaction = $orderModel->getLatestTransaction()`
   - Extract PayUNi meta: `$payuniMeta = $transaction->meta['payuni'] ?? []`

3. Build `$payuniInfo` array with:
   - `trade_no`: From `$transaction->vendor_charge_id` or `$payuniMeta['trade_no']`
   - `status`: Map from `$transaction->status` (succeeded/failed/pending)
   - `status_label`: Human-readable label ('成功'/'失敗'/'處理中')
   - `payment_type`: From `$payuniMeta['trade_type']` ('credit'/'atm'/'cvs')
   - `payment_type_label`: Human-readable label ('信用卡'/'ATM 轉帳'/'超商代碼')

4. Add `$order['payuni_info'] = $payuniInfo` and return

5. In `fluentcart-payuni.php`:
   - Add require statement for new class (around line 50 with other requires)
   - In `init()` method, instantiate: `new \FluentCartPayUNi\Admin\OrderPayUNiMetaBox()`
   - Use priority 20 in plugins_loaded to ensure FluentCart loads first

IMPORTANT: Use priority 20 in filter registration to ensure FluentCart data is ready.
IMPORTANT: Check class_exists for FluentCart\App\Models\Order before usage.
  </action>
  <verify>
1. `grep -r "fluent_cart/order/view" src/Admin/` returns the filter hook
2. `grep -r "OrderPayUNiMetaBox" fluentcart-payuni.php` shows registration
3. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- OrderPayUNiMetaBox.php exists with filter registration
- Class is instantiated in main plugin file
- Filter hook uses priority 20
- Payment method check filters non-PayUNi orders
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ATM virtual account and CVS payment code display logic</name>
  <files>src/Admin/OrderPayUNiMetaBox.php</files>
  <action>
Extend OrderPayUNiMetaBox to include ATM and CVS pending payment information:

1. In `injectPayUNiData()`, after basic info extraction, check for pending payment:
```php
$pendingInfo = $payuniMeta['pending'] ?? [];
$paymentType = $pendingInfo['payment_type'] ?? '';
```

2. For ATM payments (`$paymentType === '2'` or `$payuniMeta['trade_type'] === 'atm'`):
   - Extract from `$pendingInfo`:
     - `bank_code`: 銀行代碼
     - `virtual_account`: 虛擬帳號
     - `expire_date`: 到期日 (format: Y/m/d H:i:s or similar)
   - Add to `$payuniInfo['atm']` array:
     ```php
     'atm' => [
         'bank_code' => $pendingInfo['bank_code'] ?? '',
         'bank_name' => $this->getBankName($pendingInfo['bank_code'] ?? ''),
         'virtual_account' => $pendingInfo['virtual_account'] ?? '',
         'expire_date' => $pendingInfo['expire_date'] ?? '',
         'expire_formatted' => $this->formatExpireDate($pendingInfo['expire_date'] ?? ''),
     ]
     ```

3. For CVS payments (`$paymentType === '3'` or `$payuniMeta['trade_type'] === 'cvs'`):
   - Extract from `$pendingInfo`:
     - `payment_no`: 繳費代碼
     - `store_type`: 超商類型 (711/family/hilife/ok)
     - `expire_date`: 到期日
   - Add to `$payuniInfo['cvs']` array:
     ```php
     'cvs' => [
         'payment_no' => $pendingInfo['payment_no'] ?? '',
         'store_type' => $pendingInfo['store_type'] ?? '',
         'store_name' => $this->getStoreName($pendingInfo['store_type'] ?? ''),
         'expire_date' => $pendingInfo['expire_date'] ?? '',
         'expire_formatted' => $this->formatExpireDate($pendingInfo['expire_date'] ?? ''),
     ]
     ```

4. Add helper methods:
   - `getBankName(string $bankCode): string` - Map bank code to name (e.g., '822' => '中國信託')
   - `getStoreName(string $storeType): string` - Map store type to name (e.g., '711' => '7-ELEVEN')
   - `formatExpireDate(string $date): string` - Format date for display

5. Add bank code mapping (common Taiwan banks):
```php
private function getBankName(string $bankCode): string {
    $banks = [
        '004' => '台灣銀行',
        '005' => '土地銀行',
        '006' => '合作金庫',
        '007' => '第一銀行',
        '008' => '華南銀行',
        '009' => '彰化銀行',
        '011' => '上海銀行',
        '012' => '台北富邦',
        '013' => '國泰世華',
        '017' => '兆豐銀行',
        '021' => '花旗銀行',
        '050' => '台灣企銀',
        '053' => '台中商銀',
        '803' => '聯邦銀行',
        '808' => '玉山銀行',
        '812' => '台新銀行',
        '822' => '中國信託',
    ];
    return $banks[$bankCode] ?? $bankCode;
}
```

6. Add store type mapping:
```php
private function getStoreName(string $storeType): string {
    $stores = [
        '1' => '7-ELEVEN',
        '2' => '全家 FamilyMart',
        '3' => '萊爾富 Hi-Life',
        '4' => 'OK 超商',
    ];
    return $stores[$storeType] ?? $storeType;
}
```

IMPORTANT: Handle empty/missing data gracefully - always use null coalescing operator.
IMPORTANT: Check if $pendingInfo exists before accessing its properties.
  </action>
  <verify>
1. `grep -r "getBankName\|getStoreName" src/Admin/` shows helper methods exist
2. `grep -r "'atm'\|'cvs'" src/Admin/OrderPayUNiMetaBox.php` shows payment type handling
3. PHP syntax check: `php -l src/Admin/OrderPayUNiMetaBox.php` returns no errors
  </verify>
  <done>
- ATM info extraction works (bank_code, virtual_account, expire_date)
- CVS info extraction works (payment_no, store_type, expire_date)
- Bank code mapping returns human-readable names
- Store type mapping returns human-readable names
- Empty data handled gracefully without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for OrderPayUNiMetaBox</name>
  <files>tests/Unit/Admin/OrderPayUNiMetaBoxTest.php, tests/bootstrap-unit.php</files>
  <action>
Create unit tests for OrderPayUNiMetaBox helper methods and data extraction logic:

1. Create `tests/Unit/Admin/OrderPayUNiMetaBoxTest.php`:
```php
namespace FluentCartPayUNi\Tests\Unit\Admin;

use PHPUnit\Framework\TestCase;
use FluentCartPayUNi\Admin\OrderPayUNiMetaBox;

class OrderPayUNiMetaBoxTest extends TestCase {
    private OrderPayUNiMetaBox $metaBox;

    protected function setUp(): void {
        parent::setUp();
        // Create instance without triggering WordPress hooks
        $this->metaBox = new OrderPayUNiMetaBox(false); // pass skip_hooks flag
    }
}
```

2. Add constructor parameter to OrderPayUNiMetaBox to skip hook registration in tests:
```php
public function __construct(bool $registerHooks = true) {
    if ($registerHooks) {
        add_filter('fluent_cart/order/view', [$this, 'injectPayUNiData'], 20, 2);
    }
}
```

3. Add tests for getBankName():
   - Test known bank code '822' returns '中國信託'
   - Test known bank code '808' returns '玉山銀行'
   - Test unknown bank code returns the code itself

4. Add tests for getStoreName():
   - Test store type '1' returns '7-ELEVEN'
   - Test store type '2' returns '全家 FamilyMart'
   - Test unknown store type returns the type itself

5. Add tests for formatExpireDate():
   - Test valid date format
   - Test empty string returns empty
   - Test invalid date handled gracefully

6. Add tests for data extraction:
   - Test non-PayUNi order returns unchanged
   - Test PayUNi order with ATM pending info extracts correctly
   - Test PayUNi order with CVS pending info extracts correctly

7. Update tests/bootstrap-unit.php if needed to autoload Admin namespace.

IMPORTANT: Make helper methods public or use ReflectionClass for testing private methods.
IMPORTANT: Mock WordPress functions that may be called (add_filter).
  </action>
  <verify>
1. Run tests: `cd /Users/fishtv/Development/fluentcart-payuni && composer test -- --filter OrderPayUNiMetaBox`
2. All tests pass
3. Test coverage includes bank mapping, store mapping, and date formatting
  </verify>
  <done>
- OrderPayUNiMetaBoxTest.php exists with at least 6 test cases
- Tests pass without WordPress environment
- Helper method mappings verified
- Edge cases (empty data, unknown codes) covered
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php -l src/Admin/OrderPayUNiMetaBox.php` - No syntax errors
2. `grep -r "fluent_cart/order/view" src/` - Filter hook registered
3. `composer test -- --filter OrderPayUNiMetaBox` - All tests pass
4. Check git diff shows expected changes
</verification>

<success_criteria>
1. OrderPayUNiMetaBox class created and registered in main plugin file
2. Filter injects payuni_info into order view data for PayUNi orders
3. ATM payment info (bank code, virtual account, expiry) extracted correctly
4. CVS payment info (payment code, store type, expiry) extracted correctly
5. Unit tests pass for helper methods and data extraction
6. Non-PayUNi orders pass through unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-meta-storage-order-detail-integration/06-01-SUMMARY.md`
</output>
