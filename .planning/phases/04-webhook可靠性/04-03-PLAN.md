---
phase: 04-webhook可靠性
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Services/IdempotencyService.php
  - src/API/PayUNiAPI.php
autonomous: true

must_haves:
  truths:
    - "每次 PayUNi API 呼叫都帶有唯一的 idempotency key"
    - "PayUNi API 呼叫失敗重試時不會重複扣款"
    - "Idempotency key 可從 API response 追溯"
  artifacts:
    - path: "src/Services/IdempotencyService.php"
      provides: "UUID 生成服務"
      exports: ["generateKey"]
    - path: "src/API/PayUNiAPI.php"
      provides: "帶有 idempotency key 的 API 呼叫"
      contains: "IdempotencyService"
  key_links:
    - from: "PayUNiAPI::post"
      to: "IdempotencyService"
      via: "generateKey for MerTradeNo"
      pattern: "IdempotencyService"
---

<objective>
加入 API Idempotency Key 機制

Purpose: 在 PayUNi API 呼叫中加入 UUID idempotency key，確保網路重試時不會重複扣款。PayUNi 使用 MerTradeNo 作為冪等鍵。

Output:
- `IdempotencyService` 服務類別（UUID 生成）
- 修改後的 `PayUNiAPI.php`（記錄 idempotency key）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md

# 現有實作
@src/API/PayUNiAPI.php
@src/Processor/PaymentProcessor.php
@src/Processor/SubscriptionPaymentProcessor.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 IdempotencyService</name>
  <files>src/Services/IdempotencyService.php</files>
  <action>
建立 `src/Services/IdempotencyService.php`：

1. **類別結構**：
   ```php
   namespace BuyGoFluentCart\PayUNi\Services;

   /**
    * IdempotencyService
    *
    * 白話：產生 API 呼叫的冪等鍵（UUID），確保重試不會重複扣款。
    */
   final class IdempotencyService
   {
       /**
        * 產生符合 PayUNi MerTradeNo 規範的唯一識別碼。
        *
        * PayUNi 要求：20 字元以內，英數字。
        * 格式：{prefix}{timestamp_base36}{random}
        *
        * @param string $prefix 可選前綴（如 transaction ID）
        * @return string 唯一識別碼（最多 20 字元）
        */
       public static function generateKey(string $prefix = ''): string
       {
           $time = base_convert((string) time(), 10, 36);
           $rand = substr(bin2hex(random_bytes(4)), 0, 6);

           if ($prefix) {
               // {prefix}A{time}{rand} - A 作為分隔符
               $key = substr($prefix, 0, 8) . 'A' . $time . $rand;
           } else {
               // {time}{rand}
               $key = $time . $rand;
           }

           return strtoupper(substr($key, 0, 20));
       }

       /**
        * 產生完整 UUID v4（用於內部追蹤）。
        *
        * @return string UUID v4 格式
        */
       public static function generateUuid(): string
       {
           $data = random_bytes(16);
           $data[6] = chr(ord($data[6]) & 0x0f | 0x40);
           $data[8] = chr(ord($data[8]) & 0x3f | 0x80);

           return vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4));
       }
   }
   ```

2. **說明**：
   - `generateKey()`: 產生符合 PayUNi MerTradeNo 規範的 20 字元以內唯一識別碼
   - `generateUuid()`: 產生完整 UUID v4，用於內部追蹤（可選）
   - 使用 `random_bytes()` 確保加密安全的隨機數

3. **格式說明**：
   - PayUNi MerTradeNo 限制 20 字元
   - 現有格式：`{trxHash}__{time}_{rand}` 可能超過限制
   - 新格式：`{prefix}A{base36_time}{hex_rand}` 保證在 20 字元內
  </action>
  <verify>
1. PHP 語法檢查：`php -l src/Services/IdempotencyService.php`
2. 單元測試（可在 bootstrap 後執行）：
   ```php
   $key1 = IdempotencyService::generateKey('123');
   $key2 = IdempotencyService::generateKey('123');
   var_dump(strlen($key1) <= 20);  // true
   var_dump($key1 !== $key2);       // true（不同）
   ```
  </verify>
  <done>
`IdempotencyService` 存在，`generateKey()` 產生最多 20 字元的唯一識別碼。
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 PayUNiAPI 記錄 idempotency key</name>
  <files>src/API/PayUNiAPI.php</files>
  <action>
修改 `src/API/PayUNiAPI.php`：

1. **新增 IdempotencyService 使用**：
   ```php
   use BuyGoFluentCart\PayUNi\Services\IdempotencyService;
   ```

2. **在 post() 方法中記錄 idempotency key**：

   修改 `post()` 方法，在呼叫前記錄 MerTradeNo：
   ```php
   public function post(string $tradeType, array $encryptInfo, string $version = '1.0', string $mode = '')
   {
       $mode = $mode ?: $this->settings->getMode();

       // 記錄 idempotency key（MerTradeNo）
       $merTradeNo = $encryptInfo['MerTradeNo'] ?? '';
       $idempotencyKey = IdempotencyService::generateUuid();

       Logger::info('PayUNi API call initiated', [
           'trade_type' => $tradeType,
           'mer_trade_no' => $merTradeNo,
           'idempotency_key' => $idempotencyKey,
           'mode' => $mode,
       ]);

       // ... 後續邏輯不變
   ```

3. **在 response 中也記錄**：
   ```php
   // 成功時記錄
   Logger::info('PayUNi API call succeeded', [
       'trade_type' => $tradeType,
       'mer_trade_no' => $merTradeNo,
       'idempotency_key' => $idempotencyKey,
       'response_status' => $decoded['Status'] ?? 'unknown',
   ]);
   ```

4. **注意事項**：
   - 不修改 encryptInfo 中的 MerTradeNo（由 Processor 產生）
   - 只在 Logger 中記錄 idempotency_key 供追蹤
   - PayUNi 本身使用 MerTradeNo 作為冪等鍵，我們只需確保它是唯一的
  </action>
  <verify>
1. PHP 語法檢查：`php -l src/API/PayUNiAPI.php`
2. 確認有 `IdempotencyService` 的 use statement
3. 確認 Logger 記錄包含 `idempotency_key`
  </verify>
  <done>
PayUNiAPI 在每次呼叫時記錄 idempotency key（UUID），可從 log 追溯。
  </done>
</task>

<task type="auto">
  <name>Task 3: 確保 Processor 使用唯一 MerTradeNo</name>
  <files>src/Processor/PaymentProcessor.php, src/Processor/SubscriptionPaymentProcessor.php</files>
  <action>
檢查並確保 Processor 中的 MerTradeNo 產生邏輯使用唯一識別碼：

1. **檢查 PaymentProcessor.php**：
   - 找到產生 `MerTradeNo` 的地方
   - 確認使用的格式符合 PayUNi 20 字元限制
   - 如果使用舊格式（`{trxHash}__{time}_{rand}`），考慮遷移到 `IdempotencyService::generateKey()`

2. **檢查 SubscriptionPaymentProcessor.php**：
   - 同上

3. **如果需要修改**，使用新格式：
   ```php
   use BuyGoFluentCart\PayUNi\Services\IdempotencyService;

   // 舊格式（可能超過 20 字元）
   // $merTradeNo = $trxHash . '__' . time() . '_' . wp_rand(1000, 9999);

   // 新格式（保證 20 字元以內）
   $merTradeNo = IdempotencyService::generateKey((string) $transaction->id);
   ```

4. **如果現有格式已經符合要求**，只需確認並記錄在 SUMMARY 中。

注意：這個任務可能不需要修改程式碼，取決於現有實作。主要目的是確認 MerTradeNo 的唯一性。
  </action>
  <verify>
1. PHP 語法檢查（如有修改）
2. 確認 MerTradeNo 長度 <= 20 字元
3. 確認每次呼叫產生不同的 MerTradeNo
  </verify>
  <done>
所有 Processor 使用符合 PayUNi 規範的唯一 MerTradeNo。
  </done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過：
   ```bash
   php -l src/Services/IdempotencyService.php
   php -l src/API/PayUNiAPI.php
   ```

2. 程式碼檢查：
   ```bash
   grep -c "IdempotencyService" src/API/PayUNiAPI.php        # 應 >= 1
   grep -c "idempotency_key" src/API/PayUNiAPI.php           # 應 >= 1
   ```

3. 功能驗證：
   ```php
   $key = \BuyGoFluentCart\PayUNi\Services\IdempotencyService::generateKey('999');
   echo strlen($key);  // <= 20
   echo $key;          // e.g., "999AMKQ5R6ABC123"
   ```
</verification>

<success_criteria>
- [ ] IdempotencyService 存在且 generateKey() 產生 <= 20 字元的唯一識別碼
- [ ] PayUNiAPI::post() 記錄 idempotency_key 到 log
- [ ] 所有 Processor 使用符合規範的 MerTradeNo
- [ ] 所有 PHP 檔案語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook可靠性/04-03-SUMMARY.md`
</output>
