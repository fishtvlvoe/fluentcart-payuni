---
phase: 04-webhook可靠性
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Services/WebhookDeduplicationService.php
  - includes/class-database.php
autonomous: true

must_haves:
  truths:
    - "Webhook log 資料表在外掛啟用時自動建立"
    - "去重服務可記錄已處理的 transaction_id"
    - "去重服務可查詢 transaction_id 是否已處理"
  artifacts:
    - path: "src/Services/WebhookDeduplicationService.php"
      provides: "Webhook 去重服務"
      exports: ["isProcessed", "markProcessed"]
    - path: "includes/class-database.php"
      provides: "資料表建立邏輯"
      contains: "payuni_webhook_log"
  key_links:
    - from: "WebhookDeduplicationService"
      to: "payuni_webhook_log table"
      via: "wpdb queries"
      pattern: "\\$wpdb->.*payuni_webhook_log"
---

<objective>
建立 Webhook 去重基礎設施

Purpose: 將 webhook 去重機制從不可靠的 transient（10 分鐘 TTL）遷移到資料庫記錄，確保同一筆交易在 24 小時內只處理一次。

Output:
- `payuni_webhook_log` 資料表結構
- `WebhookDeduplicationService` 服務類別
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md

# 現有去重實作（需替換）
@src/Webhook/NotifyHandler.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立資料庫 Schema 類別</name>
  <files>includes/class-database.php</files>
  <action>
建立 `includes/class-database.php`，包含：

1. **Database 類別**：
   - 命名空間：`FluentcartPayuni`
   - 靜態方法 `createTables()` - 使用 WordPress `dbDelta()` 建立資料表
   - 靜態方法 `getWebhookLogTable()` - 回傳完整資料表名稱（含前綴）

2. **payuni_webhook_log 資料表結構**：
   ```sql
   CREATE TABLE {prefix}payuni_webhook_log (
     id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
     transaction_id VARCHAR(64) NOT NULL,
     trade_no VARCHAR(64) DEFAULT NULL,
     webhook_type VARCHAR(32) NOT NULL,
     processed_at DATETIME NOT NULL,
     payload_hash VARCHAR(64) NOT NULL,
     PRIMARY KEY (id),
     UNIQUE KEY unique_transaction (transaction_id, webhook_type),
     KEY idx_processed_at (processed_at),
     KEY idx_trade_no (trade_no)
   ) {charset_collate};
   ```

3. **欄位說明**：
   - `transaction_id`: FluentCart transaction UUID（去重主鍵之一）
   - `trade_no`: PayUNi TradeNo（用於除錯查詢）
   - `webhook_type`: 'notify' 或 'return'（去重主鍵之二）
   - `processed_at`: 處理時間戳（用於清理）
   - `payload_hash`: 原始 payload 的 SHA256（防止相同 transaction 但不同 payload 的情況）

不要使用 WordPress 的 transient 或 options，直接使用自訂資料表。
  </action>
  <verify>
檔案語法檢查：`php -l includes/class-database.php`

手動驗證：在測試環境執行 `Database::createTables()` 後，使用 `SHOW CREATE TABLE wp_payuni_webhook_log` 確認結構。
  </verify>
  <done>
`includes/class-database.php` 存在且包含正確的 `createTables()` 和 `getWebhookLogTable()` 方法。
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立去重服務類別</name>
  <files>src/Services/WebhookDeduplicationService.php</files>
  <action>
建立 `src/Services/WebhookDeduplicationService.php`，包含：

1. **類別結構**：
   ```php
   namespace BuyGoFluentCart\PayUNi\Services;

   final class WebhookDeduplicationService
   {
       private const TTL_HOURS = 24;

       public function isProcessed(string $transactionId, string $webhookType): bool
       public function markProcessed(string $transactionId, string $webhookType, ?string $tradeNo = null, ?string $payloadHash = null): bool
       public function cleanup(): int
   }
   ```

2. **isProcessed() 方法**：
   - 查詢 `payuni_webhook_log` 資料表
   - 檢查 `transaction_id + webhook_type` 組合是否存在
   - 只檢查過去 24 小時內的記錄
   - 回傳 `bool`

3. **markProcessed() 方法**：
   - 使用 `INSERT IGNORE` 或 `ON DUPLICATE KEY` 避免重複插入
   - 記錄 `transaction_id`, `webhook_type`, `trade_no`, `processed_at`, `payload_hash`
   - 回傳 `bool` 表示是否成功插入（false 表示已存在）

4. **cleanup() 方法**：
   - 刪除超過 TTL_HOURS 的舊記錄
   - 回傳刪除的記錄數
   - 供排程任務呼叫

5. **注意事項**：
   - 使用 `$wpdb->prepare()` 防止 SQL injection
   - 使用 `FluentcartPayuni\Database::getWebhookLogTable()` 取得表名
   - 錯誤時記錄到 Logger（不要拋出例外，避免中斷 webhook 處理）
  </action>
  <verify>
檔案語法檢查：`php -l src/Services/WebhookDeduplicationService.php`

單元測試：在後續計畫中建立測試。
  </verify>
  <done>
`src/Services/WebhookDeduplicationService.php` 存在，包含 `isProcessed()`, `markProcessed()`, `cleanup()` 三個方法。
  </done>
</task>

<task type="auto">
  <name>Task 3: 外掛啟用時建立資料表</name>
  <files>fluentcart-payuni.php</files>
  <action>
修改主外掛檔案 `fluentcart-payuni.php`，在外掛啟用時建立資料表：

1. **新增啟用 hook**：
   ```php
   register_activation_hook(BUYGO_FC_PAYUNI_FILE, 'buygo_fc_payuni_activate');

   function buygo_fc_payuni_activate(): void
   {
       require_once BUYGO_FC_PAYUNI_PATH . 'includes/class-database.php';
       \FluentcartPayuni\Database::createTables();
   }
   ```

2. **新增版本升級檢查**（在 `buygo_fc_payuni_bootstrap()` 中）：
   - 比較 `get_option('buygo_fc_payuni_db_version')` 與當前版本
   - 若版本不同，執行 `Database::createTables()`（dbDelta 是 idempotent 的）
   - 更新 `buygo_fc_payuni_db_version` option

3. **確保 autoloader 可以載入 `FluentcartPayuni\Database`**：
   - 確認 `includes/` 的 autoloader 已設定

位置：在現有的 `register_activation_hook` 之後或替換現有的啟用邏輯。
  </action>
  <verify>
1. 停用並重新啟用外掛
2. 執行 `SHOW TABLES LIKE '%payuni_webhook_log%'` 確認資料表存在
3. 執行 `DESCRIBE {prefix}payuni_webhook_log` 確認欄位正確
  </verify>
  <done>
外掛啟用後，`payuni_webhook_log` 資料表自動建立。版本升級時自動更新 schema。
  </done>
</task>

</tasks>

<verification>
1. 外掛啟用後，`SHOW TABLES LIKE '%payuni_webhook_log%'` 回傳一筆記錄
2. `DESCRIBE {prefix}payuni_webhook_log` 顯示正確的欄位結構
3. PHP 語法檢查通過：`php -l includes/class-database.php && php -l src/Services/WebhookDeduplicationService.php`
4. 手動測試去重服務：
   ```php
   $svc = new \BuyGoFluentCart\PayUNi\Services\WebhookDeduplicationService();
   $svc->markProcessed('test-uuid', 'notify', 'TN123', 'hash123');
   var_dump($svc->isProcessed('test-uuid', 'notify')); // true
   var_dump($svc->isProcessed('test-uuid', 'return')); // false
   ```
</verification>

<success_criteria>
- [ ] `payuni_webhook_log` 資料表在外掛啟用時自動建立
- [ ] `WebhookDeduplicationService::isProcessed()` 可正確查詢
- [ ] `WebhookDeduplicationService::markProcessed()` 可正確記錄
- [ ] 所有 PHP 檔案語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook可靠性/04-01-SUMMARY.md`
</output>
