---
phase: 04-webhook可靠性
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/Webhook/NotifyHandler.php
  - src/Webhook/ReturnHandler.php
autonomous: true

must_haves:
  truths:
    - "同一 transaction_id 在 24 小時內只處理一次（notify）"
    - "同一 transaction_id 在 24 小時內只處理一次（return）"
    - "高負載情況下不會重複處理同一筆交易"
  artifacts:
    - path: "src/Webhook/NotifyHandler.php"
      provides: "使用資料庫去重的 notify 處理"
      contains: "WebhookDeduplicationService"
    - path: "src/Webhook/ReturnHandler.php"
      provides: "使用資料庫去重的 return 處理"
      contains: "WebhookDeduplicationService"
  key_links:
    - from: "NotifyHandler"
      to: "WebhookDeduplicationService"
      via: "isProcessed + markProcessed"
      pattern: "isProcessed|markProcessed"
    - from: "ReturnHandler"
      to: "WebhookDeduplicationService"
      via: "isProcessed + markProcessed"
      pattern: "isProcessed|markProcessed"
---

<objective>
整合去重服務到 Webhook Handler

Purpose: 將 NotifyHandler 和 ReturnHandler 的去重機制從 transient 遷移到資料庫服務，確保高負載情況下不會重複處理同一筆交易。

Output:
- 修改後的 `NotifyHandler.php`（使用 WebhookDeduplicationService）
- 修改後的 `ReturnHandler.php`（使用 WebhookDeduplicationService）
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-webhook可靠性/04-01-SUMMARY.md

# 現有實作
@src/Webhook/NotifyHandler.php
@src/Webhook/ReturnHandler.php
@src/Services/WebhookDeduplicationService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 修改 NotifyHandler 使用資料庫去重</name>
  <files>src/Webhook/NotifyHandler.php</files>
  <action>
修改 `src/Webhook/NotifyHandler.php`：

1. **移除 transient 去重邏輯**（約 line 40-46）：
   ```php
   // 移除這段
   $dedupKey = 'payuni_notify_' . md5($notifyId ?: ($encryptInfo . '|' . $hashInfo));
   if (get_transient($dedupKey)) {
       $this->sendResponse('SUCCESS');
       return;
   }
   set_transient($dedupKey, true, 10 * MINUTE_IN_SECONDS);
   ```

2. **新增 WebhookDeduplicationService 使用**：
   ```php
   use BuyGoFluentCart\PayUNi\Services\WebhookDeduplicationService;
   ```

3. **在找到 transaction 之後、處理之前檢查去重**（約 line 96-108 之後）：
   ```php
   // 找到 transaction 後，檢查是否已處理
   $dedup = new WebhookDeduplicationService();
   $tradeNo = (string) ($decrypted['TradeNo'] ?? '');
   $payloadHash = hash('sha256', wp_json_encode($decrypted));

   if ($dedup->isProcessed($transaction->uuid, 'notify')) {
       Logger::info('Notify already processed (dedup)', [
           'transaction_uuid' => $transaction->uuid,
           'trade_no' => $tradeNo,
       ]);
       $this->sendResponse('SUCCESS');
       return;
   }
   ```

4. **在成功處理後標記已處理**（在每個 `$this->sendResponse('SUCCESS')` 之前）：
   ```php
   $dedup->markProcessed($transaction->uuid, 'notify', $tradeNo, $payloadHash);
   ```

5. **注意事項**：
   - 保留原有的 Logger 呼叫
   - 確保在所有成功路徑都有 markProcessed
   - 去重檢查應在 transaction 驗證之後（避免偽造的重複請求佔用資源）
  </action>
  <verify>
1. PHP 語法檢查：`php -l src/Webhook/NotifyHandler.php`
2. 確認不再有 `get_transient` 或 `set_transient` 呼叫
3. 確認有 `WebhookDeduplicationService` 的 use statement
  </verify>
  <done>
NotifyHandler 使用 WebhookDeduplicationService 進行去重，不再使用 transient。
  </done>
</task>

<task type="auto">
  <name>Task 2: 修改 ReturnHandler 加入去重</name>
  <files>src/Webhook/ReturnHandler.php</files>
  <action>
修改 `src/Webhook/ReturnHandler.php`：

1. **新增 WebhookDeduplicationService 使用**：
   ```php
   use BuyGoFluentCart\PayUNi\Services\WebhookDeduplicationService;
   ```

2. **在找到 transaction 之後、處理之前檢查去重**（約 line 84-91 之後）：
   ```php
   // 找到 transaction 後，檢查是否已處理
   $dedup = new WebhookDeduplicationService();
   $tradeNo = (string) ($decrypted['TradeNo'] ?? '');
   $payloadHash = hash('sha256', wp_json_encode($decrypted));

   if ($dedup->isProcessed($transaction->uuid, 'return')) {
       Logger::info('Return already processed (dedup)', [
           'transaction_uuid' => $transaction->uuid,
           'trade_no' => $tradeNo,
       ]);
       return $trxHash;
   }
   ```

3. **在成功處理後標記已處理**（在每個 `return $trxHash;` 之前）：
   ```php
   $dedup->markProcessed($transaction->uuid, 'return', $tradeNo, $payloadHash);
   ```

4. **處理邊界情況**：
   - Return 可能會在 Notify 之後到達（或同時），兩者分開去重
   - 即使 return 已處理，仍然回傳 $trxHash（讓使用者看到正確頁面）

5. **注意事項**：
   - 保留原有的 Logger 呼叫
   - 確保在所有成功路徑都有 markProcessed
  </action>
  <verify>
1. PHP 語法檢查：`php -l src/Webhook/ReturnHandler.php`
2. 確認有 `WebhookDeduplicationService` 的 use statement
3. 確認有 `isProcessed` 和 `markProcessed` 呼叫
  </verify>
  <done>
ReturnHandler 使用 WebhookDeduplicationService 進行去重，與 NotifyHandler 分開追蹤。
  </done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過：
   ```bash
   php -l src/Webhook/NotifyHandler.php
   php -l src/Webhook/ReturnHandler.php
   ```

2. 程式碼檢查：
   ```bash
   grep -c "get_transient\|set_transient" src/Webhook/NotifyHandler.php  # 應為 0
   grep -c "WebhookDeduplicationService" src/Webhook/NotifyHandler.php   # 應 >= 1
   grep -c "WebhookDeduplicationService" src/Webhook/ReturnHandler.php   # 應 >= 1
   ```

3. 功能驗證（需要實際 webhook 或模擬）：
   - 模擬相同 transaction 的重複 notify → 第二次應直接回傳 SUCCESS
   - 模擬相同 transaction 的重複 return → 第二次應直接回傳 trxHash
</verification>

<success_criteria>
- [ ] NotifyHandler 不再使用 transient 去重
- [ ] NotifyHandler 使用 WebhookDeduplicationService
- [ ] ReturnHandler 使用 WebhookDeduplicationService
- [ ] 所有 PHP 檔案語法檢查通過
- [ ] 去重邏輯在 transaction 驗證之後執行
</success_criteria>

<output>
After completion, create `.planning/phases/04-webhook可靠性/04-02-SUMMARY.md`
</output>
