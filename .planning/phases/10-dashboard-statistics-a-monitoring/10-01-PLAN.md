---
phase: 10-dashboard-statistics-a-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Services/DashboardStatsService.php
  - src/API/DashboardStatsAPI.php
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "REST API endpoint returns PayUNi payment statistics"
    - "Statistics include payment method distribution (credit/ATM/CVS)"
    - "Statistics include subscription renewal success rate (30 days)"
    - "Statistics include recent webhook events (latest 5)"
    - "Statistics are cached using WordPress transients (15 min TTL)"
  artifacts:
    - path: "src/Services/DashboardStatsService.php"
      provides: "Statistics aggregation service with transient caching"
      min_lines: 150
      exports: ["DashboardStatsService"]
    - path: "src/API/DashboardStatsAPI.php"
      provides: "REST API endpoint for dashboard statistics"
      min_lines: 80
      exports: ["DashboardStatsAPI"]
  key_links:
    - from: "src/API/DashboardStatsAPI.php"
      to: "src/Services/DashboardStatsService.php"
      via: "service instantiation"
      pattern: "new.*DashboardStatsService"
    - from: "src/Services/DashboardStatsService.php"
      to: "wp_payuni_webhook_log table"
      via: "database query"
      pattern: "\\$wpdb->get_results"
    - from: "fluentcart-payuni.php"
      to: "DashboardStatsAPI"
      via: "rest_api_init hook"
      pattern: "DashboardStatsAPI"
---

<objective>
Create PayUNi Dashboard Statistics Service and REST API for aggregating payment performance metrics.

Purpose: Provide backend infrastructure for dashboard widget to display payment method distribution, subscription renewal success rate, and recent webhook events.
Output: REST API endpoint `/fluentcart-payuni/v1/dashboard/stats` returning cached statistics with 15-minute TTL.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md

# Reference existing patterns
@/Users/fishtv/Development/fluentcart-payuni/src/API/WebhookLogAPI.php
@/Users/fishtv/Development/fluentcart-payuni/includes/class-database.php

# Reference FluentCart documentation
@/Users/fishtv/Development/fluentcart-payuni/docs/fluentcart-reference/fluentcart.com_doc/restapi_operations_dashboard_get-dashboard-stats.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DashboardStatsService with aggregation queries and transient caching</name>
  <files>src/Services/DashboardStatsService.php</files>
  <action>
Create `src/Services/DashboardStatsService.php` as statistics aggregation service:

**Class structure:**
- Namespace: `BuyGoFluentCart\PayUNi\Services`
- Constants: `CACHE_KEY = 'payuni_dashboard_stats'`, `CACHE_TTL = 15 * MINUTE_IN_SECONDS`
- Constructor: Accept optional `$enableCache` parameter (default true) for testing

**Methods to implement:**

**1. `getStats(): array`** (main entry point)
- Check transient cache first (`get_transient(CACHE_KEY)`)
- If cache miss, call aggregation methods and store result
- Return array with: `payment_distribution`, `renewal_success_rate`, `recent_webhooks`, `generated_at`

**2. `getPaymentMethodDistribution(): array`** (DASH-02)
Query `wp_fct_order_transactions` table for PayUNi orders in last 30 days:
```sql
SELECT
  CASE
    WHEN payment_method = 'payuni_credit' OR payment_method = 'payuni_subscription' THEN 'credit'
    WHEN payment_method = 'payuni_atm' THEN 'atm'
    WHEN payment_method = 'payuni_cvs' THEN 'cvs'
    ELSE 'other'
  END as method_type,
  COUNT(*) as count,
  SUM(payment_total) as amount
FROM {wp_fct_order_transactions}
WHERE payment_method LIKE 'payuni%'
  AND status = 'paid'
  AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY method_type
```
Return array: `[['type' => 'credit', 'count' => 50, 'amount' => 125000, 'percentage' => 75], ...]`

**3. `getRenewalSuccessRate(): array`** (DASH-03)
Query subscription renewal transactions in last 30 days:
```sql
SELECT
  DATE(created_at) as date,
  SUM(CASE WHEN status = 'paid' THEN 1 ELSE 0 END) as success_count,
  SUM(CASE WHEN status IN ('failed', 'cancelled') THEN 1 ELSE 0 END) as failed_count,
  COUNT(*) as total_count
FROM {wp_fct_order_transactions}
WHERE payment_method = 'payuni_subscription'
  AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date ASC
```
Return array: `['data' => [['date' => '2026-01-15', 'success_rate' => 95.5, 'success' => 19, 'failed' => 1], ...], 'average_rate' => 92.3]`

**4. `getRecentWebhooks(): array`** (DASH-04)
Query `wp_payuni_webhook_log` table for latest 5 entries:
```sql
SELECT id, transaction_id, trade_no, webhook_type, webhook_status, processed_at
FROM {wp_payuni_webhook_log}
ORDER BY processed_at DESC
LIMIT 5
```
Return array with status labels in Chinese: `processed` -> `已處理`, `duplicate` -> `重複`, `failed` -> `失敗`

**5. `clearCache(): void`**
Delete transient: `delete_transient(CACHE_KEY)`

**Important notes:**
- Use `global $wpdb` for database queries
- Use `$wpdb->prefix` for table names
- Wrap queries in try/catch for error handling
- Return empty arrays if no data (graceful degradation)
- Use `gmdate('Y-m-d H:i:s')` for `generated_at` timestamp
  </action>
  <verify>
1. File exists at `src/Services/DashboardStatsService.php`
2. Class is loadable: `php -l src/Services/DashboardStatsService.php`
3. PHPDoc comments present for all public methods
  </verify>
  <done>
- DashboardStatsService class created with getStats(), getPaymentMethodDistribution(), getRenewalSuccessRate(), getRecentWebhooks() methods
- Transient caching implemented with 15-minute TTL
- All queries use proper FluentCart table names with $wpdb->prefix
- Status labels translated to Chinese for frontend display
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DashboardStatsAPI REST endpoint and integrate into bootstrap</name>
  <files>src/API/DashboardStatsAPI.php, fluentcart-payuni.php</files>
  <action>
**Part A: Create `src/API/DashboardStatsAPI.php`**

Following pattern from `WebhookLogAPI.php`:

**Class structure:**
- Namespace: `BuyGoFluentCart\PayUNi\API`
- Constants: `NAMESPACE = 'fluentcart-payuni/v1'`

**Methods:**

**1. `register_routes(): void`**
Register REST route:
```php
register_rest_route(self::NAMESPACE, '/dashboard/stats', [
    'methods'             => 'GET',
    'callback'            => [$this, 'get_stats'],
    'permission_callback' => [$this, 'permission_check'],
    'args'                => [
        'refresh' => [
            'type'        => 'boolean',
            'default'     => false,
            'description' => 'Force refresh cache',
        ],
    ],
]);
```

**2. `get_stats(\WP_REST_Request $request): \WP_REST_Response`**
- If `refresh` param is true, call `$service->clearCache()` first
- Call `DashboardStatsService::getStats()`
- Return `WP_REST_Response` with stats data

**3. `permission_check(): bool`**
Same pattern as WebhookLogAPI:
```php
return current_user_can('manage_options') || current_user_can('manage_fluentcart');
```

**Part B: Integrate into `fluentcart-payuni.php`**

Add after existing WebhookLogAPI registration (around line 138):
```php
// Dashboard Stats API：提供 Dashboard 統計資料查詢
add_action('rest_api_init', function () {
    if (class_exists('BuyGoFluentCart\\PayUNi\\API\\DashboardStatsAPI')) {
        $api = new \BuyGoFluentCart\PayUNi\API\DashboardStatsAPI();
        $api->register_routes();
    }
});
```
  </action>
  <verify>
1. Files exist and pass PHP lint check
2. REST API responds: `curl -X GET "http://buygo.local/wp-json/fluentcart-payuni/v1/dashboard/stats" -H "X-WP-Nonce: [nonce]"` (requires authentication)
3. Response includes: `payment_distribution`, `renewal_success_rate`, `recent_webhooks`, `generated_at`
  </verify>
  <done>
- DashboardStatsAPI class created with GET /dashboard/stats endpoint
- Permission check allows manage_options or manage_fluentcart capability
- Optional `refresh` parameter forces cache refresh
- Bootstrap integration in fluentcart-payuni.php with class_exists guard
  </done>
</task>

</tasks>

<verification>
1. PHP syntax validation passes for all new files
2. REST API endpoint accessible at `/wp-json/fluentcart-payuni/v1/dashboard/stats`
3. API returns expected data structure with all four sections
4. Transient cache is created after first request (`wp_options` table contains `_transient_payuni_dashboard_stats`)
5. Second request returns same `generated_at` timestamp (cache hit)
6. Request with `?refresh=true` returns new `generated_at` timestamp (cache refresh)
</verification>

<success_criteria>
1. DashboardStatsService provides cached statistics with 15-min TTL (DASH-05)
2. Payment method distribution query returns credit/ATM/CVS breakdown (DASH-02 data)
3. Renewal success rate query returns 30-day trend data (DASH-03 data)
4. Recent webhooks query returns latest 5 entries (DASH-04 data)
5. REST API is permission-protected for admin/shop_manager only (INFRA-02 pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/10-dashboard-statistics-a-monitoring/10-01-SUMMARY.md`
</output>
