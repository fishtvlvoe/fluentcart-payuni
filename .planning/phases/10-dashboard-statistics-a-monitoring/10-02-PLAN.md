---
phase: 10-dashboard-statistics-a-monitoring
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/Admin/DashboardWidget.php
  - assets/css/payuni-dashboard.css
  - assets/js/payuni-dashboard.js
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "FluentCart admin menu contains 'PayUNi Dashboard' page"
    - "Dashboard page displays payment method distribution chart"
    - "Dashboard page displays subscription renewal success rate trend"
    - "Dashboard page displays recent webhook events table"
    - "Chart.js is used for visualization"
    - "Assets only load on the dashboard page (INFRA-04)"
  artifacts:
    - path: "src/Admin/DashboardWidget.php"
      provides: "Dashboard admin page registration and rendering"
      min_lines: 150
      exports: ["DashboardWidget"]
    - path: "assets/css/payuni-dashboard.css"
      provides: "Dashboard page styling"
      contains: ".payuni-dashboard"
    - path: "assets/js/payuni-dashboard.js"
      provides: "Dashboard interactivity with Chart.js"
      contains: "new Chart"
  key_links:
    - from: "src/Admin/DashboardWidget.php"
      to: "fluent-cart admin menu"
      via: "add_submenu_page hook"
      pattern: "add_submenu_page.*fluent-cart"
    - from: "assets/js/payuni-dashboard.js"
      to: "REST API"
      via: "fetch API call"
      pattern: "fetch.*dashboard/stats"
    - from: "fluentcart-payuni.php"
      to: "DashboardWidget class"
      via: "class instantiation"
      pattern: "new.*DashboardWidget"
---

<objective>
Create PayUNi Dashboard Widget admin page with Chart.js visualizations for payment statistics.

Purpose: Provide merchants with a visual overview of PayUNi performance including payment method distribution (pie chart), subscription renewal success rate (line chart), and recent webhook events.
Output: WordPress admin page under "FluentCart → PayUNi Dashboard" with interactive charts and statistics tables.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md

# Reference existing admin page patterns
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/SettingsPage.php
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/WebhookLogPage.php

# Plan 10-01 summary (provides REST API endpoint)
# API: GET /fluentcart-payuni/v1/dashboard/stats
# Response: { payment_distribution, renewal_success_rate, recent_webhooks, generated_at }
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DashboardWidget admin page class with HTML structure</name>
  <files>src/Admin/DashboardWidget.php</files>
  <action>
Create `src/Admin/DashboardWidget.php` following pattern from `SettingsPage.php`:

**Class structure:**
- Namespace: `BuyGoFluentCart\PayUNi\Admin`
- Constants: `PAGE_SLUG = 'payuni-dashboard'`
- Constructor: Accept `$registerHooks` parameter (default true) for testability

**Hooks to register:**
- `admin_menu` (priority 99) - register submenu page
- `admin_enqueue_scripts` - load assets only on this page

**registerAdminPage method:**
- Check `manage_options` or `manage_fluentcart` capability
- Add submenu under `fluent-cart` parent slug
- Menu title: "PayUNi Dashboard" (統計面板)
- Position: Before "Webhook 記錄" (use position parameter)

**enqueueAssets method:**
Following INFRA-04 requirement (assets only on related pages):
```php
public function enqueueAssets(string $hook): void
{
    // Only load on dashboard page
    if (strpos($hook, self::PAGE_SLUG) === false) {
        return;
    }

    // Load Chart.js from CDN
    wp_enqueue_script(
        'chartjs',
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
        [],
        '4.4.1',
        true
    );

    // Load dashboard CSS
    wp_enqueue_style(
        'payuni-dashboard',
        FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/css/payuni-dashboard.css',
        [],
        FLUENTCART_PAYUNI_VERSION
    );

    // Load dashboard JS (depends on Chart.js)
    wp_enqueue_script(
        'payuni-dashboard',
        FLUENTCART_PAYUNI_PLUGIN_URL . 'assets/js/payuni-dashboard.js',
        ['chartjs', 'jquery'],
        FLUENTCART_PAYUNI_VERSION,
        true
    );

    // Localize script
    wp_localize_script('payuni-dashboard', 'payuniDashboard', [
        'restUrl' => rest_url('fluentcart-payuni/v1/dashboard/stats'),
        'nonce' => wp_create_nonce('wp_rest'),
        'labels' => [
            'paymentDistribution' => __('支付方式分布', 'fluentcart-payuni'),
            'credit' => __('信用卡', 'fluentcart-payuni'),
            'atm' => __('ATM 轉帳', 'fluentcart-payuni'),
            'cvs' => __('超商代碼', 'fluentcart-payuni'),
            'renewalSuccessRate' => __('訂閱續扣成功率 (30天)', 'fluentcart-payuni'),
            'successRate' => __('成功率', 'fluentcart-payuni'),
            'recentWebhooks' => __('最近 Webhook 事件', 'fluentcart-payuni'),
            'loading' => __('載入中...', 'fluentcart-payuni'),
            'noData' => __('尚無資料', 'fluentcart-payuni'),
            'refresh' => __('重新整理', 'fluentcart-payuni'),
            'lastUpdated' => __('最後更新', 'fluentcart-payuni'),
        ],
    ]);
}
```

**renderPage method:**
Render HTML structure with placeholder containers for JavaScript:
```html
<div class="wrap payuni-dashboard">
    <h1>PayUNi Dashboard <button id="refresh-stats" class="button">重新整理</button></h1>
    <p class="last-updated">最後更新: <span id="generated-at">-</span></p>

    <div class="dashboard-grid">
        <!-- Payment Distribution Card (DASH-02) -->
        <div class="dashboard-card">
            <h2>支付方式分布</h2>
            <div class="chart-container">
                <canvas id="payment-distribution-chart"></canvas>
            </div>
            <div id="payment-distribution-legend"></div>
        </div>

        <!-- Renewal Success Rate Card (DASH-03) -->
        <div class="dashboard-card wide">
            <h2>訂閱續扣成功率 (30天)</h2>
            <div class="stat-highlight">
                <span class="stat-value" id="average-success-rate">-</span>
                <span class="stat-label">平均成功率</span>
            </div>
            <div class="chart-container">
                <canvas id="renewal-success-chart"></canvas>
            </div>
        </div>

        <!-- Recent Webhooks Card (DASH-04) -->
        <div class="dashboard-card">
            <h2>最近 Webhook 事件</h2>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th>時間</th>
                        <th>類型</th>
                        <th>狀態</th>
                    </tr>
                </thead>
                <tbody id="recent-webhooks-tbody">
                    <tr><td colspan="3">載入中...</td></tr>
                </tbody>
            </table>
            <p class="card-footer">
                <a href="admin.php?page=payuni-webhook-logs">查看全部 →</a>
            </p>
        </div>
    </div>
</div>
```
  </action>
  <verify>
1. File exists at `src/Admin/DashboardWidget.php`
2. PHP syntax check passes: `php -l src/Admin/DashboardWidget.php`
3. Class follows SettingsPage pattern with testable constructor
  </verify>
  <done>
- DashboardWidget class created with registerAdminPage, enqueueAssets, renderPage methods
- Admin menu registered under FluentCart with proper capability check
- Chart.js CDN loaded as dependency (version 4.4.1)
- Assets only load on dashboard page (INFRA-04 compliance)
- HTML structure includes canvas elements for Chart.js and table for recent webhooks
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSS/JS for Chart.js integration and data rendering</name>
  <files>assets/css/payuni-dashboard.css, assets/js/payuni-dashboard.js, fluentcart-payuni.php</files>
  <action>
**Part A: Create `assets/css/payuni-dashboard.css`**

Dashboard styling following Element Plus color palette (from Phase 9 decisions):
```css
/* Dashboard Layout */
.payuni-dashboard {
    max-width: 1200px;
}

.payuni-dashboard h1 {
    display: flex;
    align-items: center;
    gap: 15px;
}

.payuni-dashboard .last-updated {
    color: #909399;
    margin-bottom: 20px;
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

@media (max-width: 1024px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

/* Dashboard Cards */
.dashboard-card {
    background: #fff;
    border: 1px solid #e4e7ed;
    border-radius: 4px;
    padding: 20px;
}

.dashboard-card.wide {
    grid-column: span 2;
}

@media (max-width: 1024px) {
    .dashboard-card.wide {
        grid-column: span 1;
    }
}

.dashboard-card h2 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #303133;
    border-bottom: 1px solid #e4e7ed;
    padding-bottom: 10px;
}

/* Chart Container */
.chart-container {
    position: relative;
    height: 250px;
}

/* Stat Highlight */
.stat-highlight {
    text-align: center;
    margin-bottom: 15px;
}

.stat-value {
    font-size: 36px;
    font-weight: 600;
    color: #67c23a;
}

.stat-label {
    display: block;
    font-size: 14px;
    color: #909399;
}

/* Payment Distribution Legend */
#payment-distribution-legend {
    margin-top: 15px;
}

#payment-distribution-legend .legend-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f2f6fc;
}

#payment-distribution-legend .legend-item:last-child {
    border-bottom: none;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    display: inline-block;
    margin-right: 8px;
}

.legend-label {
    color: #606266;
}

.legend-value {
    color: #303133;
    font-weight: 500;
}

/* Recent Webhooks Table */
.dashboard-card table {
    margin-top: 0;
}

.dashboard-card .card-footer {
    margin: 15px 0 0 0;
    text-align: right;
}

/* Status Badges */
.webhook-status {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.webhook-status.processed {
    background: #f0f9eb;
    color: #67c23a;
}

.webhook-status.duplicate {
    background: #fdf6ec;
    color: #e6a23c;
}

.webhook-status.failed {
    background: #fef0f0;
    color: #f56c6c;
}

.webhook-status.pending {
    background: #f4f4f5;
    color: #909399;
}

/* Loading State */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #909399;
}
```

**Part B: Create `assets/js/payuni-dashboard.js`**

JavaScript for fetching data and rendering charts:
```javascript
(function($) {
    'use strict';

    // Chart instances for updating
    let paymentChart = null;
    let renewalChart = null;

    // Color palette (Element Plus colors)
    const colors = {
        credit: '#409EFF',  // Primary blue
        atm: '#67C23A',     // Success green
        cvs: '#E6A23C',     // Warning orange
        other: '#909399'    // Info gray
    };

    // Initialize on DOM ready
    $(document).ready(function() {
        loadDashboardStats();

        // Refresh button handler
        $('#refresh-stats').on('click', function() {
            loadDashboardStats(true);
        });
    });

    /**
     * Load dashboard statistics from REST API
     * @param {boolean} refresh - Force cache refresh
     */
    function loadDashboardStats(refresh = false) {
        const $refreshBtn = $('#refresh-stats');
        $refreshBtn.prop('disabled', true).text(payuniDashboard.labels.loading);

        const url = refresh
            ? payuniDashboard.restUrl + '?refresh=true'
            : payuniDashboard.restUrl;

        $.ajax({
            url: url,
            method: 'GET',
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-WP-Nonce', payuniDashboard.nonce);
            },
            success: function(response) {
                renderPaymentDistribution(response.payment_distribution);
                renderRenewalSuccessRate(response.renewal_success_rate);
                renderRecentWebhooks(response.recent_webhooks);
                $('#generated-at').text(response.generated_at || '-');
            },
            error: function(xhr) {
                console.error('Dashboard stats load failed:', xhr.responseText);
            },
            complete: function() {
                $refreshBtn.prop('disabled', false).text(payuniDashboard.labels.refresh);
            }
        });
    }

    /**
     * Render payment distribution pie chart (DASH-02)
     */
    function renderPaymentDistribution(data) {
        if (!data || data.length === 0) {
            $('#payment-distribution-legend').html('<p>' + payuniDashboard.labels.noData + '</p>');
            return;
        }

        const ctx = document.getElementById('payment-distribution-chart').getContext('2d');
        const labels = [];
        const values = [];
        const bgColors = [];

        data.forEach(function(item) {
            const label = payuniDashboard.labels[item.type] || item.type;
            labels.push(label);
            values.push(item.count);
            bgColors.push(colors[item.type] || colors.other);
        });

        // Destroy existing chart if any
        if (paymentChart) {
            paymentChart.destroy();
        }

        paymentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // We use custom legend
                    }
                }
            }
        });

        // Render custom legend with amounts
        let legendHtml = '';
        data.forEach(function(item) {
            const label = payuniDashboard.labels[item.type] || item.type;
            const color = colors[item.type] || colors.other;
            legendHtml += '<div class="legend-item">' +
                '<span><span class="legend-color" style="background:' + color + '"></span>' +
                '<span class="legend-label">' + label + '</span></span>' +
                '<span class="legend-value">' + item.count + ' 筆 / NT$' + formatNumber(item.amount) + '</span>' +
                '</div>';
        });
        $('#payment-distribution-legend').html(legendHtml);
    }

    /**
     * Render renewal success rate line chart (DASH-03)
     */
    function renderRenewalSuccessRate(data) {
        // Update average rate display
        const avgRate = data && data.average_rate ? data.average_rate.toFixed(1) + '%' : '-';
        $('#average-success-rate').text(avgRate);

        if (!data || !data.data || data.data.length === 0) {
            return;
        }

        const ctx = document.getElementById('renewal-success-chart').getContext('2d');
        const labels = data.data.map(function(item) {
            return item.date.substring(5); // Show MM-DD only
        });
        const values = data.data.map(function(item) {
            return item.success_rate;
        });

        // Destroy existing chart if any
        if (renewalChart) {
            renewalChart.destroy();
        }

        renewalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: payuniDashboard.labels.successRate,
                    data: values,
                    borderColor: '#67C23A',
                    backgroundColor: 'rgba(103, 194, 58, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Render recent webhooks table (DASH-04)
     */
    function renderRecentWebhooks(data) {
        const $tbody = $('#recent-webhooks-tbody');

        if (!data || data.length === 0) {
            $tbody.html('<tr><td colspan="3">' + payuniDashboard.labels.noData + '</td></tr>');
            return;
        }

        let html = '';
        data.forEach(function(item) {
            const time = item.processed_at ? item.processed_at.substring(5, 16) : '-';
            const type = item.webhook_type || '-';
            const status = item.webhook_status || 'pending';
            const statusLabel = item.status_label || status;

            html += '<tr>' +
                '<td>' + time + '</td>' +
                '<td>' + type + '</td>' +
                '<td><span class="webhook-status ' + status + '">' + statusLabel + '</span></td>' +
                '</tr>';
        });

        $tbody.html(html);
    }

    /**
     * Format number with thousand separators
     */
    function formatNumber(num) {
        if (!num) return '0';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

})(jQuery);
```

**Part C: Integrate DashboardWidget into `fluentcart-payuni.php`**

Add after SettingsPage registration (around line 132):
```php
// PayUNi Dashboard Widget：後台統計面板
if (class_exists('BuyGoFluentCart\\PayUNi\\Admin\\DashboardWidget')) {
    new \BuyGoFluentCart\PayUNi\Admin\DashboardWidget();
}
```
  </action>
  <verify>
1. All files exist and pass syntax checks
2. Dashboard page accessible at `/wp-admin/admin.php?page=payuni-dashboard`
3. Chart.js loads only on dashboard page (check Network tab on other admin pages)
4. Payment distribution pie chart renders with correct colors
5. Renewal success rate line chart renders with percentage scale
6. Recent webhooks table shows latest 5 entries with status badges
  </verify>
  <done>
- DashboardWidget class integrated into bootstrap with class_exists guard
- CSS styles created with Element Plus color palette and responsive grid
- JavaScript fetches data from REST API and renders Chart.js charts
- Payment distribution shows doughnut chart with custom legend (DASH-02)
- Renewal success rate shows line chart with 30-day trend (DASH-03)
- Recent webhooks shows table with status badges (DASH-04)
- Assets only load on dashboard page (INFRA-04)
  </done>
</task>

</tasks>

<verification>
1. Admin menu shows "PayUNi Dashboard" under FluentCart menu
2. Dashboard page loads without JavaScript errors
3. Chart.js is only loaded on dashboard page (verify by checking Network tab on Settings page)
4. Payment distribution chart displays correctly with legend
5. Renewal success rate chart displays 30-day trend line
6. Recent webhooks table shows latest 5 entries with colored status badges
7. Refresh button clears cache and reloads data
8. Responsive layout works on smaller screens (cards stack vertically)
</verification>

<success_criteria>
1. FluentCart Dashboard contains PayUNi statistics page (DASH-01)
2. Payment method distribution chart visible using Chart.js (DASH-02)
3. Subscription renewal success rate trend displayed (DASH-03)
4. Recent webhook events summary visible (DASH-04)
5. Admin assets only load on dashboard page (INFRA-04)
</success_criteria>

<output>
After completion, create `.planning/phases/10-dashboard-statistics-a-monitoring/10-02-SUMMARY.md`
</output>
