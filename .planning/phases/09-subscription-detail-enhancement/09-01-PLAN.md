---
phase: 09-subscription-detail-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Admin/SubscriptionPayUNiMetaBox.php
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "Subscription detail API returns renewal history with date, amount, status, retry count"
    - "Subscription detail API returns bound card information (last 4 digits, expiry)"
    - "Subscription detail API returns failure reason when renewal fails"
    - "Subscription detail API returns next billing date and expected renewal amount"
  artifacts:
    - path: "src/Admin/SubscriptionPayUNiMetaBox.php"
      provides: "PayUNi subscription data injection into FluentCart subscription view"
      min_lines: 150
      exports: ["SubscriptionPayUNiMetaBox"]
  key_links:
    - from: "src/Admin/SubscriptionPayUNiMetaBox.php"
      to: "fluent_cart/subscription/view filter"
      via: "add_filter hook"
      pattern: "add_filter.*fluent_cart/subscription/view"
    - from: "src/Admin/SubscriptionPayUNiMetaBox.php"
      to: "FluentCart OrderTransaction model"
      via: "subscription->transactions relation"
      pattern: "subscription.*transactions|OrderTransaction"
    - from: "fluentcart-payuni.php"
      to: "SubscriptionPayUNiMetaBox class"
      via: "class instantiation"
      pattern: "new.*SubscriptionPayUNiMetaBox"
---

<objective>
Create SubscriptionPayUNiMetaBox class to inject renewal history, card info, and failure details into FluentCart subscription detail API.

Purpose: Enable merchants to monitor subscription health by providing complete PayUNi transaction data through the existing FluentCart subscription/view filter, refactoring the inline closure to a dedicated testable class.
Output: Backend class that enriches subscription data with renewal_history, card_info, failure_reason, and enhanced next_billing_info.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/REQUIREMENTS.md

# Reference existing admin meta box pattern
@/Users/fishtv/Development/fluentcart-payuni/src/Admin/OrderPayUNiMetaBox.php

# Reference existing subscription filter (to be refactored into class)
@/Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php

# Reference renewal runner for retry info structure
@/Users/fishtv/Development/fluentcart-payuni/src/Scheduler/PayUNiSubscriptionRenewalRunner.php

# FluentCart subscription model documentation
@/Users/fishtv/Development/fluentcart-payuni/docs/fluentcart-reference/fluentcart.com_doc/database_models_subscription.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubscriptionPayUNiMetaBox class with renewal history and card info extraction</name>
  <files>src/Admin/SubscriptionPayUNiMetaBox.php</files>
  <action>
Create `src/Admin/SubscriptionPayUNiMetaBox.php` following the pattern from `OrderPayUNiMetaBox.php`:

**Class structure:**
- Namespace: `BuyGoFluentCart\PayUNi\Admin`
- Constructor: Accept `$registerHooks` parameter (default true) for testability
- Hooks: `fluent_cart/subscription/view` filter at priority 10

**injectPayUNiData method (signature: array $subscription, array $data):**

Only process PayUNi subscriptions:
```php
$paymentMethod = $subscription['current_payment_method'] ?? '';
if ($paymentMethod !== 'payuni_subscription') {
    return $subscription;
}
```

Load subscription model to access meta and transactions:
```php
if (!class_exists('FluentCart\\App\\Models\\Subscription')) {
    return $subscription;
}
$subscriptionModel = \FluentCart\App\Models\Subscription::find($subscription['id']);
if (!$subscriptionModel) {
    return $subscription;
}
```

**Build payuni_subscription_info array with:**

1. **renewal_history** (array of renewal transactions):
   - Query transactions via `$subscriptionModel->transactions` relation
   - Filter for `transaction_type = 'charge'` (renewals, not initial)
   - For each transaction, extract:
     - `date`: transaction created_at (formatted Y-m-d H:i)
     - `amount`: transaction total (formatted as currency)
     - `status`: transaction status (succeeded/failed/pending)
     - `status_label`: human-readable status (成功/失敗/處理中)
     - `trade_no`: vendor_charge_id or payuni.trade_no from meta
     - `retry_count`: from transaction meta payuni.retry_attempt or 0
   - Order by created_at DESC, limit 10 entries

2. **card_info** (bound payment card):
   - Get from subscription meta `active_payment_method`:
     ```php
     $activePaymentMethod = $subscriptionModel->getMeta('active_payment_method', []);
     $cardLast4 = $activePaymentMethod['details']['last_4'] ?? '';
     $cardExpiry = $activePaymentMethod['details']['card_expiry'] ?? '';
     ```
   - Detect card brand using same logic as OrderPayUNiMetaBox::detectCardBrand()
   - Check for token existence: `!empty($subscriptionModel->getMeta('payuni_credit_hash'))`
   - Return: `['card_last4' => string, 'card_expiry' => string, 'card_brand' => string, 'has_token' => bool]`

3. **failure_info** (when subscription is failing):
   - Get from subscription meta `payuni_last_error`:
     ```php
     $lastError = $subscriptionModel->getMeta('payuni_last_error', []);
     ```
   - Get retry info from `payuni_renewal_retry`:
     ```php
     $retryInfo = $subscriptionModel->getMeta('payuni_renewal_retry', []);
     ```
   - Return: `['message' => string, 'message_label' => string (translated), 'at' => datetime, 'retry_count' => int, 'max_retries' => int, 'next_retry_at' => datetime|null, 'exhausted' => bool]`
   - Translate error messages: missing_credit_hash -> "缺少信用卡 Token", requires_3d -> "需要 3D 驗證", etc.

4. **next_billing_info** (enhanced billing date display):
   - `next_billing_date`: from subscription model
   - `next_billing_date_formatted`: formatted as Y/m/d H:i
   - `expected_amount`: from `$subscriptionModel->getCurrentRenewalAmount()` (formatted as currency)
   - `billing_interval`: subscription billing_interval
   - `billing_interval_label`: human-readable (monthly -> "每月", yearly -> "每年")

**Helper methods (public for testability):**
- `getStatusLabel(string $status): string` - same as OrderPayUNiMetaBox
- `getErrorMessageLabel(string $errorCode): string` - translate error codes to Chinese
- `getBillingIntervalLabel(string $interval): string` - translate interval to Chinese
- `formatAmount(int $amountInCents): string` - format with currency symbol
- `detectCardBrand(string $cardNumber): string` - copy from OrderPayUNiMetaBox

**Add payuni_subscription_info to subscription array:**
```php
$subscription['payuni_subscription_info'] = [
    'renewal_history' => $renewalHistory,
    'card_info' => $cardInfo,
    'failure_info' => $failureInfo, // null if no failure
    'next_billing_info' => $nextBillingInfo,
];
```

**DO NOT:**
- Do NOT remove existing payuni_gateway_actions or payuni_display (preserve backward compatibility)
- Do NOT modify the existing inline filter in fluentcart-payuni.php yet (Task 2)
- Do NOT add frontend JavaScript (that's Plan 09-02)

**WHY these constraints:**
- Existing payuni-subscription-detail.js depends on payuni_gateway_actions structure
- Incremental approach: backend first, frontend second
- Separate concerns: data injection vs UI rendering
  </action>
  <verify>
Check file exists and has correct structure:
```bash
php -l /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php
grep -E "class SubscriptionPayUNiMetaBox|injectPayUNiData|renewal_history|card_info|failure_info|next_billing_info" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php
grep -E "getStatusLabel|getErrorMessageLabel|getBillingIntervalLabel|formatAmount|detectCardBrand" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php
```
  </verify>
  <done>
- [x] SubscriptionPayUNiMetaBox.php exists with correct namespace
- [x] Class has constructor with $registerHooks parameter
- [x] injectPayUNiData method processes payuni_subscription orders only
- [x] renewal_history extracted from subscription transactions
- [x] card_info extracted from active_payment_method meta
- [x] failure_info extracted from payuni_last_error and payuni_renewal_retry meta
- [x] next_billing_info includes expected amount and interval label
- [x] Helper methods are public for testability
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor existing filter to use SubscriptionPayUNiMetaBox and integrate into bootstrap</name>
  <files>fluentcart-payuni.php</files>
  <action>
**Update fluentcart-payuni.php:**

1. **Add SubscriptionPayUNiMetaBox instantiation** after existing admin class instantiations (around line 385):
```php
// PayUNi Subscription Meta Box: 訂閱詳情頁 PayUNi 資訊注入（續扣歷史、卡片資訊、失敗原因）
if (class_exists('BuyGoFluentCart\\PayUNi\\Admin\\SubscriptionPayUNiMetaBox')) {
    new \BuyGoFluentCart\PayUNi\Admin\SubscriptionPayUNiMetaBox();
}
```

2. **Update existing inline filter** (around line 454):
The existing inline `fluent_cart/subscription/view` filter handles:
- payment_method_display_name
- vendor_subscription_id fallback
- payuni_gateway_actions
- payuni_display

Keep this filter but change priority from 10 to 15 so SubscriptionPayUNiMetaBox (priority 10) runs first:
```php
add_filter('fluent_cart/subscription/view', function ($subscription, $args) {
    // ... existing code unchanged ...
}, 15, 2);  // Changed from 10 to 15
```

This ensures:
- SubscriptionPayUNiMetaBox (priority 10): Adds payuni_subscription_info with renewal_history, card_info, failure_info
- Existing inline filter (priority 15): Adds payuni_gateway_actions and payuni_display for backward compatibility

**DO NOT:**
- Do NOT remove or rewrite the existing inline filter code (only change priority)
- Do NOT duplicate logic already in SubscriptionPayUNiMetaBox

**WHY this approach:**
- Preserves backward compatibility with existing payuni-subscription-detail.js
- New data available via payuni_subscription_info without breaking existing UI
- Testable class for new functionality, inline filter for legacy support
  </action>
  <verify>
Check integration:
```bash
# Check SubscriptionPayUNiMetaBox is instantiated
grep -A 3 "new.*SubscriptionPayUNiMetaBox" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php

# Check filter priority changed to 15
grep -B 2 "fluent_cart/subscription/view" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php | grep -E "15, 2|, 15,"

# Syntax check
php -l /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php
```
  </verify>
  <done>
- [x] SubscriptionPayUNiMetaBox instantiated in bootstrap function
- [x] Existing inline filter priority changed to 15 (runs after SubscriptionPayUNiMetaBox)
- [x] No syntax errors
- [x] Backward compatibility maintained (payuni_gateway_actions and payuni_display still work)
  </done>
</task>

</tasks>

<verification>
**Code verification:**
```bash
# Check complete file structure
ls -la /Users/fishtv/Development/fluentcart-payuni/src/Admin/

# Verify class methods exist
grep -E "public function" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php

# Check filter registration
grep -A 5 "subscription/view" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php

# Check data structure keys
grep -E "renewal_history|card_info|failure_info|next_billing_info" /Users/fishtv/Development/fluentcart-payuni/src/Admin/SubscriptionPayUNiMetaBox.php
```

**Manual verification (in browser after Plan 09-02):**
- Navigate to FluentCart admin -> Subscriptions -> select a PayUNi subscription
- Check browser dev tools Network tab for subscription API response
- Verify `payuni_subscription_info` object contains:
  - `renewal_history`: array of renewal transactions
  - `card_info`: card_last4, card_expiry, card_brand, has_token
  - `failure_info`: present only when subscription is failing
  - `next_billing_info`: next_billing_date_formatted, expected_amount, billing_interval_label
</verification>

<success_criteria>
**Plan complete when:**

- [ ] SubscriptionPayUNiMetaBox.php exists with correct namespace and structure
- [ ] Class injects payuni_subscription_info into subscription view data
- [ ] renewal_history contains up to 10 recent renewal transactions with status and retry count
- [ ] card_info contains last4, expiry, brand, and token status
- [ ] failure_info contains translated error message, retry count, and next retry time
- [ ] next_billing_info contains formatted date, expected amount, and interval label
- [ ] Helper methods are public for unit testing
- [ ] Bootstrap instantiates SubscriptionPayUNiMetaBox
- [ ] Existing inline filter priority changed to 15 for backward compatibility
- [ ] No PHP syntax errors

**Requirements coverage:**
- [x] SUB-06: Renewal history data structure ready (date, amount, status, retry count)
- [x] SUB-07: Next billing info with expected amount
- [x] SUB-08: Card info with last 4 digits and expiry
- [x] SUB-09: Filter-based injection via fluent_cart/subscription/view
</success_criteria>

<output>
After completion, create `.planning/phases/09-subscription-detail-enhancement/09-01-SUMMARY.md` documenting:
- SubscriptionPayUNiMetaBox class structure and methods
- Data structure for payuni_subscription_info
- Integration pattern with existing filter
- Helper method translations (error codes, intervals)
</output>
