---
phase: 09-subscription-detail-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - assets/js/payuni-subscription-detail.js
  - assets/css/payuni-subscription-detail.css
  - fluentcart-payuni.php
autonomous: true

must_haves:
  truths:
    - "Merchant sees renewal history table showing date, amount, status badge, and transaction ID for each renewal"
    - "Merchant sees bound payment card section displaying masked card number (****1234), expiry, and brand icon"
    - "Merchant sees failure alert banner with error message, retry count, and next retry time when renewal fails"
    - "Merchant sees next billing info showing formatted date and expected amount in currency format"
  artifacts:
    - path: "assets/js/payuni-subscription-detail.js"
      provides: "Enhanced UI rendering for PayUNi subscription data"
      contains: "renewal_history"
    - path: "assets/css/payuni-subscription-detail.css"
      provides: "Styling for subscription detail PayUNi section"
      min_lines: 50
  key_links:
    - from: "assets/js/payuni-subscription-detail.js"
      to: "payuni_subscription_info"
      via: "subscription object property access"
      pattern: "payuni_subscription_info"
    - from: "fluentcart-payuni.php"
      to: "payuni-subscription-detail.css"
      via: "wp_enqueue_style"
      pattern: "payuni-subscription-detail"
---

<objective>
Enhance payuni-subscription-detail.js to display renewal history, card info, and failure details in the FluentCart subscription detail page.

Purpose: Provide merchants with visual representation of subscription health data injected by SubscriptionPayUNiMetaBox, including renewal transaction history, bound card information, and failure diagnostics.
Output: Enhanced JavaScript UI and CSS styling for subscription detail PayUNi meta box.
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/fishtv/Development/fluentcart-payuni/.planning/PROJECT.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/ROADMAP.md
@/Users/fishtv/Development/fluentcart-payuni/.planning/STATE.md

# Reference existing subscription detail JavaScript
@/Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js

# Reference existing admin CSS patterns
@/Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-settings.css
@/Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-webhook-log.css

# Reference Plan 09-01 for data structure
@/Users/fishtv/Development/fluentcart-payuni/.planning/phases/09-subscription-detail-enhancement/09-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSS file for subscription detail PayUNi section</name>
  <files>assets/css/payuni-subscription-detail.css</files>
  <action>
Create `assets/css/payuni-subscription-detail.css` following WordPress admin and existing PayUNi CSS patterns:

```css
/**
 * PayUNi Subscription Detail Page Styles
 * Styling for renewal history, card info, and failure display
 */

/* Card container - matches existing el-card styling */
.payuni-subscription-actions {
  margin-top: 16px;
}

.payuni-subscription-actions .el-card__header {
  background: #f5f7fa;
  border-bottom: 1px solid #ebeef5;
  padding: 12px 20px;
  font-weight: 600;
  color: #303133;
}

.payuni-subscription-actions .el-card__body {
  padding: 20px;
}

/* Section within the card */
.payuni-info-section {
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #ebeef5;
}

.payuni-info-section:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.payuni-info-section h4 {
  margin: 0 0 12px 0;
  font-size: 14px;
  font-weight: 600;
  color: #606266;
}

/* Card info display */
.payuni-card-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f5f7fa;
  border-radius: 4px;
}

.payuni-card-brand {
  font-weight: 600;
  color: #303133;
}

.payuni-card-number {
  font-family: 'Monaco', 'Consolas', monospace;
  font-size: 14px;
  letter-spacing: 1px;
}

.payuni-card-expiry {
  color: #909399;
  font-size: 13px;
}

.payuni-card-token-badge {
  display: inline-block;
  padding: 2px 8px;
  font-size: 12px;
  border-radius: 4px;
  margin-left: auto;
}

.payuni-card-token-badge.has-token {
  background: #e1f3d8;
  color: #67c23a;
}

.payuni-card-token-badge.no-token {
  background: #fef0f0;
  color: #f56c6c;
}

/* Next billing info */
.payuni-billing-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.payuni-billing-item {
  padding: 12px;
  background: #f5f7fa;
  border-radius: 4px;
}

.payuni-billing-item label {
  display: block;
  font-size: 12px;
  color: #909399;
  margin-bottom: 4px;
}

.payuni-billing-item .value {
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

/* Failure info alert */
.payuni-failure-alert {
  padding: 12px 16px;
  background: #fef0f0;
  border: 1px solid #fbc4c4;
  border-radius: 4px;
  color: #f56c6c;
}

.payuni-failure-alert .failure-title {
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.payuni-failure-alert .failure-title::before {
  content: "!";
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  background: #f56c6c;
  color: #fff;
  border-radius: 50%;
  font-size: 12px;
  font-weight: 700;
}

.payuni-failure-alert .failure-details {
  font-size: 13px;
  line-height: 1.5;
}

.payuni-failure-alert .failure-details p {
  margin: 4px 0;
}

.payuni-failure-alert .retry-info {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed #fbc4c4;
  font-size: 12px;
  color: #909399;
}

/* Renewal history table */
.payuni-renewal-history {
  overflow-x: auto;
}

.payuni-renewal-history table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.payuni-renewal-history th,
.payuni-renewal-history td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid #ebeef5;
}

.payuni-renewal-history th {
  background: #f5f7fa;
  color: #909399;
  font-weight: 500;
  font-size: 12px;
  text-transform: uppercase;
}

.payuni-renewal-history tr:hover td {
  background: #f5f7fa;
}

.payuni-renewal-history .status-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.payuni-renewal-history .status-badge.succeeded {
  background: #e1f3d8;
  color: #67c23a;
}

.payuni-renewal-history .status-badge.failed {
  background: #fef0f0;
  color: #f56c6c;
}

.payuni-renewal-history .status-badge.pending {
  background: #fdf6ec;
  color: #e6a23c;
}

.payuni-renewal-history .no-history {
  padding: 20px;
  text-align: center;
  color: #909399;
  font-style: italic;
}

/* Responsive */
@media (max-width: 768px) {
  .payuni-billing-info {
    grid-template-columns: 1fr;
  }

  .payuni-card-info {
    flex-wrap: wrap;
  }

  .payuni-card-token-badge {
    margin-left: 0;
    margin-top: 8px;
    width: 100%;
    text-align: center;
  }
}
```

**Styling principles:**
- Match Element Plus card component styling (el-card)
- Use FluentCart color palette (#303133 text, #909399 secondary, #67c23a success, #f56c6c error)
- Consistent with existing payuni-settings.css and payuni-webhook-log.css patterns
- Responsive grid for billing info on mobile
  </action>
  <verify>
```bash
ls -la /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-subscription-detail.css
wc -l /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-subscription-detail.css
grep -E "payuni-renewal-history|payuni-card-info|payuni-failure-alert|payuni-billing-info" /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-subscription-detail.css
```
  </verify>
  <done>
- [x] CSS file created at assets/css/payuni-subscription-detail.css
- [x] Styling for card info section
- [x] Styling for billing info grid
- [x] Styling for failure alert
- [x] Styling for renewal history table with status badges
- [x] Responsive layout for mobile
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance payuni-subscription-detail.js with new data display</name>
  <files>assets/js/payuni-subscription-detail.js</files>
  <action>
Update `assets/js/payuni-subscription-detail.js` to display the new payuni_subscription_info data.

**Add new render functions inside the IIFE, before the existing injectUI function:**

1. **renderCardInfo(cardInfo) function:**
```javascript
function renderCardInfo(cardInfo) {
  if (!cardInfo || !cardInfo.card_last4) {
    return null;
  }

  var section = document.createElement('div');
  section.className = 'payuni-info-section';

  var title = document.createElement('h4');
  title.textContent = '綁定信用卡';
  section.appendChild(title);

  var cardBox = document.createElement('div');
  cardBox.className = 'payuni-card-info';

  var brand = document.createElement('span');
  brand.className = 'payuni-card-brand';
  brand.textContent = cardInfo.card_brand || '信用卡';
  cardBox.appendChild(brand);

  var number = document.createElement('span');
  number.className = 'payuni-card-number';
  number.textContent = '**** **** **** ' + cardInfo.card_last4;
  cardBox.appendChild(number);

  if (cardInfo.card_expiry) {
    var expiry = document.createElement('span');
    expiry.className = 'payuni-card-expiry';
    expiry.textContent = '有效期限 ' + cardInfo.card_expiry;
    cardBox.appendChild(expiry);
  }

  var tokenBadge = document.createElement('span');
  tokenBadge.className = 'payuni-card-token-badge ' + (cardInfo.has_token ? 'has-token' : 'no-token');
  tokenBadge.textContent = cardInfo.has_token ? 'Token 已儲存' : '無 Token';
  cardBox.appendChild(tokenBadge);

  section.appendChild(cardBox);
  return section;
}
```

2. **renderBillingInfo(billingInfo) function:**
```javascript
function renderBillingInfo(billingInfo) {
  if (!billingInfo) {
    return null;
  }

  var section = document.createElement('div');
  section.className = 'payuni-info-section';

  var title = document.createElement('h4');
  title.textContent = '下次扣款資訊';
  section.appendChild(title);

  var grid = document.createElement('div');
  grid.className = 'payuni-billing-info';

  // Next billing date
  var dateItem = document.createElement('div');
  dateItem.className = 'payuni-billing-item';
  dateItem.innerHTML = '<label>下次扣款日</label><div class="value">' +
    (billingInfo.next_billing_date_formatted || '未設定') + '</div>';
  grid.appendChild(dateItem);

  // Expected amount
  var amountItem = document.createElement('div');
  amountItem.className = 'payuni-billing-item';
  amountItem.innerHTML = '<label>預計金額</label><div class="value">' +
    (billingInfo.expected_amount || '-') + '</div>';
  grid.appendChild(amountItem);

  section.appendChild(grid);
  return section;
}
```

3. **renderFailureInfo(failureInfo) function:**
```javascript
function renderFailureInfo(failureInfo) {
  if (!failureInfo || !failureInfo.message) {
    return null;
  }

  var section = document.createElement('div');
  section.className = 'payuni-info-section';

  var alert = document.createElement('div');
  alert.className = 'payuni-failure-alert';

  var titleDiv = document.createElement('div');
  titleDiv.className = 'failure-title';
  titleDiv.textContent = '續扣失敗';
  alert.appendChild(titleDiv);

  var details = document.createElement('div');
  details.className = 'failure-details';
  details.innerHTML = '<p><strong>原因：</strong>' + (failureInfo.message_label || failureInfo.message) + '</p>' +
    '<p><strong>發生時間：</strong>' + (failureInfo.at || '-') + '</p>';
  alert.appendChild(details);

  if (failureInfo.retry_count > 0 || failureInfo.next_retry_at) {
    var retryDiv = document.createElement('div');
    retryDiv.className = 'retry-info';
    var retryText = '重試次數：' + (failureInfo.retry_count || 0) + ' / ' + (failureInfo.max_retries || 3);
    if (failureInfo.exhausted) {
      retryText += ' (已達上限)';
    } else if (failureInfo.next_retry_at) {
      retryText += ' | 下次重試：' + failureInfo.next_retry_at;
    }
    retryDiv.textContent = retryText;
    alert.appendChild(retryDiv);
  }

  section.appendChild(alert);
  return section;
}
```

4. **renderRenewalHistory(history) function:**
```javascript
function renderRenewalHistory(history) {
  var section = document.createElement('div');
  section.className = 'payuni-info-section';

  var title = document.createElement('h4');
  title.textContent = '續扣紀錄';
  section.appendChild(title);

  var container = document.createElement('div');
  container.className = 'payuni-renewal-history';

  if (!history || history.length === 0) {
    var noHistory = document.createElement('div');
    noHistory.className = 'no-history';
    noHistory.textContent = '尚無續扣紀錄';
    container.appendChild(noHistory);
  } else {
    var table = document.createElement('table');

    var thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>日期</th><th>金額</th><th>狀態</th><th>交易編號</th></tr>';
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    history.forEach(function(item) {
      var tr = document.createElement('tr');

      var statusClass = item.status === 'succeeded' ? 'succeeded' :
                       item.status === 'failed' ? 'failed' : 'pending';

      tr.innerHTML =
        '<td>' + (item.date || '-') + '</td>' +
        '<td>' + (item.amount || '-') + '</td>' +
        '<td><span class="status-badge ' + statusClass + '">' + (item.status_label || item.status) + '</span></td>' +
        '<td style="font-family:monospace;font-size:12px;">' + (item.trade_no || '-') + '</td>';

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  section.appendChild(container);
  return section;
}
```

**Modify existing injectUI function to call new render functions:**

Find the insertion point using this pattern-based approach:
1. Search for the line that appends nextBillingRow to body: `body.appendChild(nextBillingRow)`
2. Insert the new section rendering code AFTER nextBillingRow is appended
3. Insert BEFORE `container.appendChild(body)` - find this by searching for `container.appendChild(body)`

The insertion block:
```javascript
// Render PayUNi subscription info sections (from Plan 09-01)
var subInfo = subscription.payuni_subscription_info;
if (subInfo) {
  // Card info section
  var cardSection = renderCardInfo(subInfo.card_info);
  if (cardSection) {
    body.appendChild(cardSection);
  }

  // Failure info section (if failing)
  var failureSection = renderFailureInfo(subInfo.failure_info);
  if (failureSection) {
    body.appendChild(failureSection);
  }

  // Billing info section
  var billingSection = renderBillingInfo(subInfo.next_billing_info);
  if (billingSection) {
    body.appendChild(billingSection);
  }

  // Renewal history section
  var historySection = renderRenewalHistory(subInfo.renewal_history);
  if (historySection) {
    body.appendChild(historySection);
  }
}
```

**DO NOT:**
- Do NOT remove existing functionality (buttons, cancel, reactivate, next billing date editor)
- Do NOT change the injectUI function signature
- Do NOT modify the loadAndMaybeInject or run functions

**WHY this approach:**
- Additive enhancement: new UI elements added without breaking existing flow
- Data-driven: sections only render if data exists (graceful degradation)
- Consistent styling: uses same el-card structure as existing UI
  </action>
  <verify>
```bash
# Check new functions exist
grep -E "renderCardInfo|renderBillingInfo|renderFailureInfo|renderRenewalHistory" /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js

# Check payuni_subscription_info is accessed
grep "payuni_subscription_info" /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js

# Check no syntax errors (basic check)
node -c /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js 2>&1 || echo "Syntax check done"
```
  </verify>
  <done>
- [x] renderCardInfo function displays card brand, masked number, expiry, token status
- [x] renderBillingInfo function displays next billing date and expected amount
- [x] renderFailureInfo function displays error message, retry count, next retry time
- [x] renderRenewalHistory function displays table with date, amount, status, trade_no
- [x] injectUI calls new render functions when payuni_subscription_info exists
- [x] Existing functionality preserved (buttons, cancel, reactivate)
  </done>
</task>

<task type="auto">
  <name>Task 3: Enqueue CSS file in fluentcart-payuni.php</name>
  <files>fluentcart-payuni.php</files>
  <action>
**Update fluentcart-payuni.php** to enqueue the new CSS file.

Find the existing section that enqueues `payuni-subscription-detail.js` by searching for `payuni-subscription-detail` in the file. This should be within an `admin_enqueue_scripts` callback, typically inside a condition checking for FluentCart admin pages.

**Add CSS enqueue** before or alongside the JS enqueue:

```php
// Subscription detail page styles
wp_enqueue_style(
    'buygo-fc-payuni-subscription-detail',
    BUYGO_FC_PAYUNI_URL . 'assets/css/payuni-subscription-detail.css',
    [],
    BUYGO_FC_PAYUNI_VERSION
);
```

This should be added in the same `admin_enqueue_scripts` callback that already loads `payuni-subscription-detail.js`, typically within the `if (strpos($hook, 'page=fluent-cart') !== false)` condition or similar FluentCart page check.

**DO NOT:**
- Do NOT create a new enqueue hook (add to existing one)
- Do NOT load CSS globally (only on FluentCart admin pages)
  </action>
  <verify>
```bash
# Check CSS is enqueued
grep "payuni-subscription-detail.css" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php

# Check it's in the correct location (near JS enqueue)
grep -B 5 -A 5 "payuni-subscription-detail.css" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php | head -20

# Syntax check
php -l /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php
```
  </verify>
  <done>
- [x] CSS file enqueued via wp_enqueue_style
- [x] CSS only loads on FluentCart admin pages
- [x] CSS loaded before or alongside JS file
- [x] No PHP syntax errors
  </done>
</task>

</tasks>

<verification>
**Manual verification in browser:**

1. Navigate to WordPress admin -> FluentCart -> Subscriptions
2. Select a PayUNi subscription (current_payment_method = payuni_subscription)
3. Verify PayUNi card displays:
   - Card info section with masked number and expiry
   - Next billing info with date and expected amount
   - Renewal history table (may be empty for new subscriptions)
4. For a failing subscription, verify failure alert is displayed with error message and retry info
5. Check browser console for JavaScript errors (should be none)
6. Test responsive layout on mobile viewport

**Code verification:**
```bash
# Check all files modified
ls -la /Users/fishtv/Development/fluentcart-payuni/assets/css/payuni-subscription-detail.css
ls -la /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js
grep "payuni-subscription-detail" /Users/fishtv/Development/fluentcart-payuni/fluentcart-payuni.php

# Check data structure access pattern
grep "payuni_subscription_info" /Users/fishtv/Development/fluentcart-payuni/assets/js/payuni-subscription-detail.js
```
</verification>

<success_criteria>
**Plan complete when:**

- [ ] CSS file exists with styling for all new sections
- [ ] CSS uses consistent FluentCart/Element Plus color palette
- [ ] JavaScript has renderCardInfo, renderBillingInfo, renderFailureInfo, renderRenewalHistory functions
- [ ] injectUI function calls new render functions when data available
- [ ] Existing subscription detail functionality preserved (buttons, cancel, reactivate)
- [ ] CSS file enqueued in fluentcart-payuni.php
- [ ] No JavaScript console errors
- [ ] Responsive layout works on mobile

**Requirements coverage:**
- [x] SUB-06: Renewal history displayed (date, amount, status)
- [x] SUB-07: Next billing date and expected amount visible
- [x] SUB-08: Card info displayed (last 4 digits, expiry)
- [x] SUB-09: Visual display via filter-injected data
</success_criteria>

<output>
After completion, create `.planning/phases/09-subscription-detail-enhancement/09-02-SUMMARY.md` documenting:
- New JavaScript render functions and their output
- CSS styling approach and color palette
- Integration with existing payuni-subscription-detail.js
- Data flow from backend to frontend display
</output>
