# Requirements — Milestone v1.0

**Milestone:** v1.0 — Webhook 可靠性與測試覆蓋率提升
**Completed:** 2026-01-29
**Achievement:** 9/11 requirements (82%)

---

## v1.0 Requirements

### 訂閱功能修復（Subscription）

- [x] **SUB-03**: 用戶可以更換訂閱信用卡且 3D 驗證流程正確完成 ✅
  - **接受標準：** 3D 驗證後正確回傳 subscription_id，卡片更新成功
  - **技術細節：** 修復 `PayUNiSubscriptions.php:214-228` 加入 state 參數，`fluentcart-payuni.php:799-853` 三層 fallback
  - **對應 Phase:** Phase 1
  - **完成日期:** 2026-01-29 (Commit 8a1dbf3)
  - **驗證狀態:** ✅ Validated

- [x] **SUB-04**: 訂閱帳單日期在首次付款後自動同步 ✅
  - **接受標準：** FluentCart 後台訂閱列表顯示正確的下次扣款日期（非 Invalid Date）
  - **技術細節：** `confirmCreditPaymentSucceeded:298-302` 已實作 `syncSubscriptionStates`
  - **對應 Phase:** Phase 1
  - **完成日期:** 2026-01-29
  - **驗證狀態:** ✅ Validated（功能既存，驗證完成）

- [x] **SUB-05**: 訂閱續扣失敗時有自動重試機制 ✅
  - **接受標準：** 失敗後 24/48/72 小時自動重試，3 次失敗才標記為 failing
  - **技術細節：** 擴展 `PayUNiSubscriptionRenewalRunner`，新增 `handleRenewalFailure()` 和 `clearRetryInfo()`
  - **對應 Phase:** Phase 2
  - **完成日期:** 2026-01-29 (Commit 96a93ec)
  - **驗證狀態:** ✅ Validated

### 測試完成（Payment Testing）

- [ ] **ATM-03**: ATM 轉帳完成真實付款測試 ⏸️
  - **接受標準：** 真實轉帳後收到正確通知，訂單狀態更新，Email 通知格式驗證
  - **技術細節：** 使用 PayUNi 沙盒環境測試端到端流程
  - **對應 Phase:** Phase 3
  - **狀態:** ⏸️ **部分完成**
  - **原因：** PayUNi 測試環境 ATM webhook 不會自動觸發（外部服務問題）
  - **Workaround:** 已建立 `mark-atm-paid.php` script 手動標記付款
  - **生產環境:** ✅ 正常運作
  - **延後至:** 待 PayUNi 修復測試環境

- [ ] **CVS-03**: 超商代碼完成真實付款測試
  - **接受標準：** 真實繳費後收到正確通知，訂單狀態更新，Email 通知格式驗證
  - **技術細節：** 使用 PayUNi 沙盒環境測試端到端流程
  - **對應 Phase:** Phase 3
  - **狀態:** ⏸️ **延後至 v1.1**
  - **原因：** 需要實體超商繳費，測試環境限制

### 可靠性提升（Reliability）

- [x] **WEBHOOK-03**: Webhook 去重機制使用資料庫記錄 ✅
  - **接受標準：** 同一 transaction_id 在 24 小時內只處理一次，高負載下不重複
  - **技術細節：** 新增 `payuni_webhook_log` 資料表 + `WebhookDeduplicationService`
  - **對應 Phase:** Phase 4
  - **完成日期:** 2026-01-29
  - **相關 Commits:** f70c570, 6b9496c, c5c2996, f7b3ee7
  - **驗證狀態:** ✅ Validated（12 tests passed）

- [x] **API-01**: PayUNi API 呼叫加入 idempotency key ✅
  - **接受標準：** 網路重試時不會重複扣款
  - **技術細節：** 在 `IdempotencyService` 加入 UUID 生成，`PayUNiAPI` 記錄 idempotency key
  - **對應 Phase:** Phase 4
  - **完成日期:** 2026-01-29
  - **相關 Commits:** c540817, aa6ccae
  - **驗證狀態:** ✅ Validated（9 tests passed）

### 測試覆蓋率（Test Coverage）

- [x] **TEST-01**: 核心支付流程測試覆蓋率達 60%+ ✅
  - **接受標準：** PHPUnit 報告顯示 `src/Gateway/` 和 `src/Processor/` 覆蓋率 ≥ 60%
  - **技術細節：** 測試一次性付款、訂閱初次、訂閱續扣流程
  - **對應 Phase:** Phase 5
  - **完成日期:** 2026-01-29
  - **實際覆蓋率:** 67% (超越目標)
  - **測試數量:** 36 tests（PaymentProcessor + Gateway）
  - **驗證狀態:** ✅ Validated

- [x] **TEST-02**: Webhook 處理邊界案例測試 ✅
  - **接受標準：** 測試重複通知、錯誤簽章、無效 transaction_id
  - **技術細節：** Mock PayUNi 通知並驗證處理邏輯
  - **對應 Phase:** Phase 5
  - **完成日期:** 2026-01-29
  - **測試數量:** 15 tests（NotifyHandler）
  - **驗證狀態:** ✅ Validated

- [x] **TEST-03**: 訂閱續扣狀態機測試 ✅
  - **接受標準：** 測試 active → trialing → failing → cancelled 轉換
  - **技術細節：** Mock `SubscriptionService` 並驗證狀態轉換
  - **對應 Phase:** Phase 5
  - **完成日期:** 2026-01-29
  - **測試數量:** 32 tests（SubscriptionStateMachine）
  - **驗證狀態:** ✅ Validated

- [x] **TEST-04**: 加密服務單元測試 ✅
  - **接受標準：** 測試 AES-256-GCM 加解密、簽章驗證、邊界案例
  - **技術細節：** 測試 `PayUNiCryptoService::encrypt/decrypt/createSignature`
  - **對應 Phase:** Phase 5
  - **完成日期:** 2026-01-29
  - **測試數量:** 24 tests（PayUNiCryptoService）
  - **驗證狀態:** ✅ Validated

---

## Requirements Summary

### Completed: 9/11 (82%)

| Category | Completed | Total | % |
|----------|-----------|-------|---|
| 訂閱核心 (SUB) | 3 | 3 | 100% ✅ |
| 付款測試 (ATM/CVS) | 0 | 2 | 0% ⏸️ |
| 可靠性 (WEBHOOK/API) | 2 | 2 | 100% ✅ |
| 測試覆蓋率 (TEST) | 4 | 4 | 100% ✅ |

### Requirement Outcomes

#### ✅ Validated (9)
All requirements validated through automated tests and manual verification:
- SUB-03, SUB-04, SUB-05 — Subscription functionality verified
- WEBHOOK-03, API-01 — Reliability features tested
- TEST-01, TEST-02, TEST-03, TEST-04 — Test coverage achieved

#### ⏸️ Deferred (2)
- **ATM-03** — Partial (external service issue, has workaround)
- **CVS-03** — Deferred to v1.1 (test environment limitation)

#### ❌ Dropped (0)
No requirements were dropped.

---

## Traceability Matrix

| Requirement | Phase | Plan(s) | Status | Completed | Evidence |
|-------------|-------|---------|--------|-----------|----------|
| SUB-03 | 1 | - | ✅ Completed | 2026-01-29 | Commit 8a1dbf3 |
| SUB-04 | 1 | - | ✅ Completed | 2026-01-29 | Existing functionality verified |
| SUB-05 | 2 | - | ✅ Completed | 2026-01-29 | Commit 96a93ec |
| ATM-03 | 3 | - | ⏸️ Partial | - | Workaround: mark-atm-paid.php |
| CVS-03 | 3 | - | ⏸️ Deferred | - | v1.1 milestone |
| WEBHOOK-03 | 4 | 04-01, 04-02, 04-04 | ✅ Completed | 2026-01-29 | 12 tests passed |
| API-01 | 4 | 04-03, 04-04 | ✅ Completed | 2026-01-29 | 9 tests passed |
| TEST-01 | 5 | 05-04 | ✅ Completed | 2026-01-29 | 67% coverage (36 tests) |
| TEST-02 | 5 | 05-02 | ✅ Completed | 2026-01-29 | 15 tests passed |
| TEST-03 | 5 | 05-03 | ✅ Completed | 2026-01-29 | 32 tests passed |
| TEST-04 | 5 | 05-01 | ✅ Completed | 2026-01-29 | 24 tests passed |

---

## Quality Gates

### Test Coverage
- **Target:** 60%
- **Achieved:** 67% ✅
- **Tests:** 139 tests, 385 assertions
- **Core Modules:** 8/12 files covered

### Integration Verification
- **Cross-Phase Wiring:** 12/12 verified ✅
- **E2E Flows:** 4/5 verified (1 partial due to external issue)

### Documentation
- ✅ Test README (365 lines)
- ✅ API verification docs
- ✅ Phase verification reports (2)
- ✅ Milestone audit report

---

## Known Issues

### ATM Webhook Issue
**Requirement:** ATM-03
**Issue:** PayUNi 測試環境 ATM webhook 不會自動觸發
**Impact:** 測試需手動標記付款
**Workaround:** `mark-atm-paid.php` script
**Production Status:** ✅ 正常運作
**External Dependency:** PayUNi 技術支援已通報

### CVS Testing
**Requirement:** CVS-03
**Status:** 延後至 v1.1
**Reason:** 需實體超商繳費，測試環境限制
**Impact:** 低（CVS 流程與 ATM 相似，高信心度）

---

## Next Milestone Requirements (v1.1)

待定義。建議方向：
1. 完成 ATM-03 和 CVS-03 真實交易測試
2. 前端整合（Dashboard UI）
3. 監控和告警機制
4. 效能優化

---

## Archived From

**Original File:** `.planning/REQUIREMENTS.md`
**Archived:** 2026-01-29
**Milestone:** v1.0

---

*REQ-IDs follow pattern: [CATEGORY]-[NUMBER]*
*This file is a historical record of v1.0 milestone requirements*
